<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon-16x16-next.png">
  <link rel="mask-icon" href="../../images/logo.svg" color="#222">
  <link rel="manifest" href="../../images/manifest.json">
  <meta name="msapplication-config" content="../../images/browserconfig.xml">

<link rel="stylesheet" href="../../css/main.css">


<link rel="stylesheet" href="../../lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"myblog.cuimouren.cn","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Hello, here is wenyao&#39;s space, how do you come in???">
<meta property="og:type" content="website">
<meta property="og:title" content="这里是文耀的space">
<meta property="og:url" content="http://myblog.cuimouren.cn/page/3/index.html">
<meta property="og:site_name" content="这里是文耀的space">
<meta property="og:description" content="Hello, here is wenyao&#39;s space, how do you come in???">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="崔文耀">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://myblog.cuimouren.cn/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>这里是文耀的space</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="atom.xml" title="这里是文耀的space" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">这里是文耀的space</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">wenyao'space</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="../../index.html" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="../../about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="../../tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="../../categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="../../archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://myblog.cuimouren.cn/2021/08/04/leedcode-%E5%88%9D%E7%BA%A7%E7%AE%97%E6%B3%95-%E6%A0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="崔文耀">
      <meta itemprop="description" content="Hello, here is wenyao's space, how do you come in???">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="这里是文耀的space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="../../2021/08/04/leedcode-%E5%88%9D%E7%BA%A7%E7%AE%97%E6%B3%95-%E6%A0%91/" class="post-title-link" itemprop="url">leedcode  树</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-04 20:44:25" itemprop="dateCreated datePublished" datetime="2021-08-04T20:44:25+08:00">2021-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-24 09:13:09" itemprop="dateModified" datetime="2022-02-24T09:13:09+08:00">2022-02-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/%E7%AE%97%E6%B3%95/leedcode/" itemprop="url" rel="index"><span itemprop="name">leedcode</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="leedcode-树"><a href="#leedcode-树" class="headerlink" title="leedcode  树"></a>leedcode  树</h1><p><a target="_blank" rel="noopener" href="https://leetcode-cn.com/leetbook/read/top-interview-questions-easy/x28wnt/">链接</a></p>
<h4 id="二叉树的最大深度"><a href="#二叉树的最大深度" class="headerlink" title="二叉树的最大深度"></a>二叉树的最大深度</h4><h6 id="题目说明"><a href="#题目说明" class="headerlink" title="题目说明"></a>题目说明</h6><p>求二叉树的最大深度</p>
<h6 id="题目解析"><a href="#题目解析" class="headerlink" title="题目解析"></a>题目解析</h6><p>使用递归求解即可</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">maxDepth</span><span class="params">(struct TreeNode* root)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root==<span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> left=<span class="built_in">maxDepth</span>(root-&gt;left);</span><br><span class="line">    <span class="keyword">int</span> right=<span class="built_in">maxDepth</span>(root-&gt;right);</span><br><span class="line">    <span class="keyword">return</span> (left&gt;=right?left+<span class="number">1</span>:right+<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="验证二叉搜索树"><a href="#验证二叉搜索树" class="headerlink" title="验证二叉搜索树"></a>验证二叉搜索树</h4><h6 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h6><p>给定一个二叉树，判断其是否是一个有效的二叉搜索树。</p>
<h6 id="题目解析-方法一"><a href="#题目解析-方法一" class="headerlink" title="题目解析 方法一"></a>题目解析 方法一</h6><p>递归验证即可。</p>
<p>或者中序遍历也可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">is_right</span><span class="params">(struct TreeNode* root,<span class="keyword">long</span> low,<span class="keyword">long</span> up)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root==<span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(root-&gt;val&lt;=low||root-&gt;val&gt;=up)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">is_right</span>(root-&gt;left,low,root-&gt;val)&amp;&amp;<span class="built_in">is_right</span>(root-&gt;right,root-&gt;val,up);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isValidBST</span><span class="params">(struct TreeNode* root)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root==<span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">is_right</span>(root,LONG_MIN,LONG_MAX);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="题目解析-方法二"><a href="#题目解析-方法二" class="headerlink" title="题目解析 方法二"></a>题目解析 方法二</h6><p>中序遍历</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> cur =INT_MIN;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isValidBST</span><span class="params">(struct TreeNode *root)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d \n&quot;</span>,cur);</span><br><span class="line">    <span class="keyword">if</span> (root)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">isValidBST</span>(root-&gt;left))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d %d\n&quot;</span>,cur,root-&gt;val);</span><br><span class="line">        <span class="keyword">if</span> (cur &gt;= root-&gt;val)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        cur = root-&gt;val;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">isValidBST</span>(root-&gt;right))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="对称二叉树"><a href="#对称二叉树" class="headerlink" title="对称二叉树"></a>对称二叉树</h4><h6 id="题目描述-1"><a href="#题目描述-1" class="headerlink" title="题目描述"></a>题目描述</h6><p>给定一个二叉树，检查它是否是镜像对称的。</p>
<h6 id="题目解析-方法一-1"><a href="#题目解析-方法一-1" class="headerlink" title="题目解析 方法一"></a>题目解析 方法一</h6><p>中序遍历的方法不可行，形状判定很复杂。</p>
<p>使用递归，若像棵树镜像，则一棵树的左子树必定和另一棵树的右子树镜像。递归判断即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">is_right</span><span class="params">(struct TreeNode *left, struct TreeNode *right)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!left &amp;&amp; !right)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!left || !right)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> ((left-&gt;val == right-&gt;val) &amp;&amp; <span class="built_in">is_right</span>(left-&gt;left, right-&gt;right) &amp;&amp; <span class="built_in">is_right</span>(left-&gt;right, right-&gt;left));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isSymmetric</span><span class="params">(struct TreeNode *root)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">is_right</span>(root, root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="题目解析-方法二-1"><a href="#题目解析-方法二-1" class="headerlink" title="题目解析 方法二"></a>题目解析 方法二</h6><p>使用队列啊ing递归改为迭代</p>
<p>每次从队列中取出要进行比较的两个结点，不相等的直接返回，相等则按相反顺序插入四个孩子到队列。直到队列为空。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isSymmetric</span><span class="params">(TreeNode *root)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        deque&lt;TreeNode *&gt; q;</span><br><span class="line">        q.<span class="built_in">push_back</span>(root);</span><br><span class="line">        q.<span class="built_in">push_back</span>(root);</span><br><span class="line">        <span class="keyword">while</span> (!q.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            TreeNode *left = q.<span class="built_in">front</span>();</span><br><span class="line">            q.<span class="built_in">pop_front</span>();</span><br><span class="line">            TreeNode *right = q.<span class="built_in">front</span>();</span><br><span class="line">            q.<span class="built_in">pop_front</span>();</span><br><span class="line">            <span class="keyword">if</span> (!left &amp;&amp; !right)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (!left || !right)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (left-&gt;val != right-&gt;val)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">//现在 left right 都不空 逆序存入</span></span><br><span class="line">            q.<span class="built_in">push_back</span>(left-&gt;left);</span><br><span class="line">            q.<span class="built_in">push_back</span>(right-&gt;right);</span><br><span class="line">            q.<span class="built_in">push_back</span>(left-&gt;right);</span><br><span class="line">            q.<span class="built_in">push_back</span>(right-&gt;left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="二叉树的层序遍历"><a href="#二叉树的层序遍历" class="headerlink" title="二叉树的层序遍历"></a>二叉树的层序遍历</h4><h6 id="题目描述-2"><a href="#题目描述-2" class="headerlink" title="题目描述"></a>题目描述</h6><p>层序遍历二叉树</p>
<h6 id="题目解析-方法一-2"><a href="#题目解析-方法一-2" class="headerlink" title="题目解析 方法一"></a>题目解析 方法一</h6><p>根结点入队。key_num记录每一层的个数，出队一个存入数组，入队其孩子。更新key_num。直到队空。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">levelOrder</span>(TreeNode *root)</span><br><span class="line">    &#123;</span><br><span class="line">        vector&lt;vector&lt;<span class="keyword">int</span>&gt;&gt; v;</span><br><span class="line">        deque&lt;TreeNode *&gt; q;</span><br><span class="line">        <span class="keyword">int</span> key_num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> temp_key_num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!root)</span><br><span class="line">            <span class="keyword">return</span> v;</span><br><span class="line">        q.<span class="built_in">push_back</span>(root);</span><br><span class="line">        key_num++;</span><br><span class="line">        <span class="keyword">while</span> (!q.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            vector&lt;<span class="keyword">int</span>&gt; v1;</span><br><span class="line">            TreeNode *t;</span><br><span class="line">            <span class="keyword">while</span> (key_num &gt;= <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                t = q.<span class="built_in">front</span>();</span><br><span class="line">                v1.<span class="built_in">push_back</span>(t-&gt;val);</span><br><span class="line">                q.<span class="built_in">pop_front</span>();</span><br><span class="line">                key_num--;</span><br><span class="line">                <span class="keyword">if</span> (t-&gt;left)</span><br><span class="line">                &#123;</span><br><span class="line">                    q.<span class="built_in">push_back</span>(t-&gt;left);</span><br><span class="line">                    temp_key_num++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (t-&gt;right)</span><br><span class="line">                &#123;</span><br><span class="line">                    q.<span class="built_in">push_back</span>(t-&gt;right);</span><br><span class="line">                    temp_key_num++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            key_num = temp_key_num;</span><br><span class="line">            temp_key_num = <span class="number">0</span>;</span><br><span class="line">            v.<span class="built_in">push_back</span>(v1);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="将有序数组转换为二叉搜索树"><a href="#将有序数组转换为二叉搜索树" class="headerlink" title="将有序数组转换为二叉搜索树"></a>将有序数组转换为二叉搜索树</h4><h6 id="题目描述-3"><a href="#题目描述-3" class="headerlink" title="题目描述"></a>题目描述</h6><p>给你一个整数数组 nums ，其中元素已经按 升序 排列，请你将其转换为一棵 高度平衡 二叉搜索树。</p>
<p>高度平衡 二叉树是一棵满足「每个节点的左右两个子树的高度差的绝对值不超过 1 」的二叉树。</p>
<h6 id="题目解析-方法一-3"><a href="#题目解析-方法一-3" class="headerlink" title="题目解析 方法一"></a>题目解析 方法一</h6><p>AVL树插入的时候可能涉及不平衡需要进行旋转，但是现在是从一个确定的数组中插入，故不需要进行旋转，只需要判断插入的顺序即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode *<span class="title">sortedArrayToBST</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp;nums)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//TreeNode *root = (TreeNode *)malloc(sizeof(struct TreeNode));</span></span><br><span class="line">        TreeNode *root = <span class="keyword">new</span> <span class="built_in">TreeNode</span>();</span><br><span class="line">        root-&gt;val=nums.<span class="built_in">at</span>(nums.<span class="built_in">size</span>() / <span class="number">2</span>);</span><br><span class="line">        root-&gt;left = <span class="built_in">insert</span>(nums, <span class="number">0</span>, nums.<span class="built_in">size</span>() / <span class="number">2</span>, root);</span><br><span class="line">        root-&gt;right = <span class="built_in">insert</span>(nums, nums.<span class="built_in">size</span>() / <span class="number">2</span> + <span class="number">1</span>, nums.<span class="built_in">size</span>(), root);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">TreeNode *<span class="title">insert</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt; &amp;nums, <span class="keyword">int</span> low, <span class="keyword">int</span> up, TreeNode *pa)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (low != up)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//TreeNode *t = (TreeNode *)malloc(sizeof(struct TreeNode));</span></span><br><span class="line">            TreeNode *t = <span class="keyword">new</span> <span class="built_in">TreeNode</span>();</span><br><span class="line">            t-&gt;val=nums.<span class="built_in">at</span>((low + up) / <span class="number">2</span>);</span><br><span class="line">            t-&gt;left = <span class="built_in">insert</span>(nums, low, (low + up) / <span class="number">2</span>, t);</span><br><span class="line">            t-&gt;right = <span class="built_in">insert</span>(nums, (low + up) / <span class="number">2</span> + <span class="number">1</span>, up, t);</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://myblog.cuimouren.cn/2021/07/23/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E4%BA%94-AVL-%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%A0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="崔文耀">
      <meta itemprop="description" content="Hello, here is wenyao's space, how do you come in???">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="这里是文耀的space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="../../2021/07/23/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E4%BA%94-AVL-%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%A0%91/" class="post-title-link" itemprop="url">数据结构 五 AVL 平衡二叉树</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-23 15:48:43" itemprop="dateCreated datePublished" datetime="2021-07-23T15:48:43+08:00">2021-07-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-26 10:57:22" itemprop="dateModified" datetime="2021-07-26T10:57:22+08:00">2021-07-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">数据结构</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%A0%91/" itemprop="url" rel="index"><span itemprop="name">树</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="AVL-平衡二叉树"><a href="#AVL-平衡二叉树" class="headerlink" title="AVL 平衡二叉树"></a>AVL 平衡二叉树</h1><p>最近在写一个数据库引擎，需要学习一下 B-TREE 的知识，我一看，之前学习数据结构的时候才学习到 AVL 树，这可不行，得加紧学习了，所以今天的任务就是将AVL树弄明白。</p>
<h2 id="ADT"><a href="#ADT" class="headerlink" title="ADT"></a>ADT</h2><p>平衡二叉树AVLTree和二叉查找树BSTree差不多，只不过平衡二叉树需要保持平衡，即每一个节点的左右两颗子树的高度小于等于1.这样就使得二叉搜索树保持最好的状态，不至于陷入链表的境地。</p>
<p>平衡二叉树的要点在于怎样保持平衡。要解决这个问题首先要搞清楚不平衡的集中条件。</p>
<h2 id="平衡二叉树的失衡姿态。"><a href="#平衡二叉树的失衡姿态。" class="headerlink" title="平衡二叉树的失衡姿态。"></a>平衡二叉树的失衡姿态。</h2><p><strong>对二叉树的描述我就使用插入顺序来描述了。</strong></p>
<p><strong>LL</strong>、<strong>RR</strong>、<strong>LR</strong>、<strong>RL</strong></p>
<p>B1: 失衡结点<br>B2：失衡因节点，因为这个结点才失衡的。<br>B3：失衡因节点的一个祖宗&amp;&amp;失衡结点的一个孙子。</p>
<p>即寻找B3，既是B2的祖宗（自己可以是自己的祖宗），也是B1的孙子。</p>
<p>然后判断B3是B1的哪一个孙子即可得知是哪种情况。</p>
<p>这样直接判断可行性较低，除非在插入的时候明确知道失衡因子。</p>
<p>要想避开寻找失衡因子，可以从失衡结点向下判断两颗高度最大的子树，由这个方向来判断失衡姿态。</p>
<p>但是这样仍有一个问题就是这种情况：</p>
<p>8，4，2，6</p>
<p>失衡因子有两个 2，6 而且失衡银子本身就是失衡节点的孙子。</p>
<p>这样也有解决方案，在寻找两层高度最大的子树的时候将 大于 换为 大于等于 即可，其余同理。</p>
<p>在纠正姿态的时候可能存在数种不同的姿态错误，这时候应当遵循从左往右，从下往上的原则。</p>
<h3 id="接口说明"><a href="#接口说明" class="headerlink" title="接口说明"></a>接口说明</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _AVLTREE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _AVLTREE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX(a,b) (a&gt;b)?a:b</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//AVL TREE</span></span><br><span class="line"><span class="comment">//AVL 树中的任意两个节点的两个子树的高度差最大为1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">AVLTREE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> Key;</span><br><span class="line">    <span class="comment">//树的高度，即一颗树的最大层次。 par.height=max(left.height,right.height),若一个节点的左右高度差达到了-2或者2，则这棵树不平衡。</span></span><br><span class="line">    <span class="keyword">int</span> Heigth;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">AVLTREE</span> *<span class="title">Left</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">AVLTREE</span> *<span class="title">Right</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">AVLTREE</span> *<span class="title">Parent</span>;</span></span><br><span class="line">&#125; * AVLTree, *Node;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    LL,</span><br><span class="line">    LR,</span><br><span class="line">    RL,</span><br><span class="line">    RR,</span><br><span class="line">    BALANCED    <span class="comment">//已平衡</span></span><br><span class="line">&#125;UNBALANCED_STATUS;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化一个空树</span></span><br><span class="line"><span class="function">AVLTree <span class="title">AVLTree_Init</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据 key 生成一个树结点</span></span><br><span class="line"><span class="function">AVLTree <span class="title">AVLTree_Create</span><span class="params">(<span class="keyword">int</span> key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断一棵树不平衡的状态</span></span><br><span class="line"><span class="function">UNBALANCED_STATUS <span class="title">AVLTree_judge_unbalance_status</span><span class="params">(AVLTree unbalanced_tree)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断是否是祖宗 自己也是自己的祖宗。</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isancestor</span><span class="params">(AVLTree ancestor,AVLTree son)</span></span>;</span><br><span class="line"><span class="comment">//使树平衡。</span></span><br><span class="line"><span class="function">AVLTree <span class="title">AVLTree_make_it_balance</span><span class="params">(AVLTree tree)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取AVL树的高度</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avltree_height</span><span class="params">(AVLTree tree)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前序遍历&quot;AVL树&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">preorder_avltree</span><span class="params">(AVLTree tree)</span></span>;</span><br><span class="line"><span class="comment">// 中序遍历&quot;AVL树&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inorder_avltree</span><span class="params">(AVLTree tree)</span></span>;</span><br><span class="line"><span class="comment">// 后序遍历&quot;AVL树&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">postorder_avltree</span><span class="params">(AVLTree tree)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新树的高度</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">update_avltree_heigth</span><span class="params">(AVLTree tree)</span></span>;</span><br><span class="line"><span class="comment">//寻找不平衡的结点</span></span><br><span class="line"><span class="function">AVLTree <span class="title">search_unbalanced_tree</span><span class="params">(AVLTree tree)</span></span>;</span><br><span class="line"><span class="comment">//balance</span></span><br><span class="line"><span class="function">AVLTree <span class="title">balance</span><span class="params">(AVLTree tree)</span></span>;</span><br><span class="line"><span class="comment">//height</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">height_avltree</span><span class="params">(AVLTree tree)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ll_rotation</span><span class="params">(AVLTree k2)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rr_rotation</span><span class="params">(AVLTree k2)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_avltree</span><span class="params">(AVLTree tree, <span class="keyword">int</span> key, <span class="keyword">int</span> direction)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (递归实现)查找&quot;AVL树x&quot;中键值为key的节点</span></span><br><span class="line"><span class="function">AVLTree <span class="title">avltree_search</span><span class="params">(AVLTree tree, <span class="keyword">int</span> key)</span></span>;</span><br><span class="line"><span class="comment">// (非递归实现)查找&quot;AVL树x&quot;中键值为key的节点</span></span><br><span class="line"><span class="function">AVLTree <span class="title">iterative_avltree_search</span><span class="params">(AVLTree tree, <span class="keyword">int</span> key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找最小结点：返回tree为根结点的AVL树的最小结点。</span></span><br><span class="line"><span class="function">AVLTree <span class="title">avltree_minimum</span><span class="params">(AVLTree tree)</span></span>;</span><br><span class="line"><span class="comment">// 查找最大结点：返回tree为根结点的AVL树的最大结点。</span></span><br><span class="line"><span class="function">AVLTree <span class="title">avltree_maximum</span><span class="params">(AVLTree tree)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将结点插入到AVL树中，返回根节点</span></span><br><span class="line"><span class="function">AVLTree <span class="title">avltree_insert</span><span class="params">(AVLTree tree, <span class="keyword">int</span> key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除结点(key是节点值)，返回根节点</span></span><br><span class="line"><span class="function">AVLTree <span class="title">avltree_delete</span><span class="params">(AVLTree tree, <span class="keyword">int</span> key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁AVL树</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">destroy_avltree</span><span class="params">(AVLTree tree)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="接口实现"><a href="#接口实现" class="headerlink" title="接口实现"></a>接口实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;AVLTree.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">AVLTree <span class="title">AVLTree_Init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">AVLTree <span class="title">AVLTree_Create</span><span class="params">(<span class="keyword">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AVLTree tree=(AVLTree)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(struct AVLTREE));</span><br><span class="line">    tree-&gt;Key=key;</span><br><span class="line">    tree-&gt;Heigth=<span class="number">0</span>;</span><br><span class="line">    tree-&gt;Left=<span class="literal">NULL</span>;</span><br><span class="line">    tree-&gt;Right=<span class="literal">NULL</span>;</span><br><span class="line">    tree-&gt;Parent=<span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取AVL树的高度</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avltree_height</span><span class="params">(AVLTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> tree-&gt;Heigth;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前序遍历&quot;AVL树&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">preorder_avltree</span><span class="params">(AVLTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!tree)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>,tree-&gt;Key);</span><br><span class="line">    <span class="built_in">preorder_avltree</span>(tree-&gt;Left);</span><br><span class="line">    <span class="built_in">preorder_avltree</span>(tree-&gt;Right);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 中序遍历&quot;AVL树&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inorder_avltree</span><span class="params">(AVLTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!tree)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">inorder_avltree</span>(tree-&gt;Left);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;key: %d height: %d\n&quot;</span>,tree-&gt;Key,tree-&gt;Heigth);</span><br><span class="line">    <span class="built_in">inorder_avltree</span>(tree-&gt;Right);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 后序遍历&quot;AVL树&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">postorder_avltree</span><span class="params">(AVLTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!tree)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">postorder_avltree</span>(tree-&gt;Left);</span><br><span class="line">    <span class="built_in">postorder_avltree</span>(tree-&gt;Right);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>,tree-&gt;Key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新树的高度</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">update_avltree_heigth</span><span class="params">(AVLTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(tree==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> hei_left=<span class="built_in">update_avltree_heigth</span>(tree-&gt;Left);</span><br><span class="line">        <span class="keyword">int</span> hei_right=<span class="built_in">update_avltree_heigth</span>(tree-&gt;Right);</span><br><span class="line">        tree-&gt;Heigth=(<span class="built_in">MAX</span>(hei_left,hei_right))+<span class="number">1</span>;</span><br><span class="line">        <span class="comment">//printf(&quot;hei_left: %d hei_right: %d height: %d\n&quot;,hei_left,hei_right,tree-&gt;Heigth);</span></span><br><span class="line">        <span class="keyword">return</span> tree-&gt;Heigth;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//寻找不平衡的结点</span></span><br><span class="line"><span class="function">AVLTree <span class="title">search_unbalanced_tree</span><span class="params">(AVLTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//找到引起失衡的节点 自己失衡，但是孩子不失衡。</span></span><br><span class="line">    <span class="keyword">if</span>(tree==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">update_avltree_heigth</span>(tree);</span><br><span class="line">    <span class="comment">//记得在这之前更新树的高度</span></span><br><span class="line">    <span class="keyword">int</span> hei_left=(tree-&gt;Left)?tree-&gt;Left-&gt;Heigth:<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> hei_right=(tree-&gt;Right)?tree-&gt;Right-&gt;Heigth:<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> hei_sub=<span class="built_in">abs</span>(hei_left-hei_right);</span><br><span class="line">    <span class="keyword">if</span>(hei_sub&lt;=<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//平衡</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">search_unbalanced_tree</span>(tree-&gt;Left)!=<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">search_unbalanced_tree</span>(tree-&gt;Left);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">search_unbalanced_tree</span>(tree-&gt;Right)!=<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">search_unbalanced_tree</span>(tree-&gt;Right);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(hei_sub&gt;=<span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> tree;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将结点插入到AVL树中，返回根节点</span></span><br><span class="line"><span class="function">AVLTree <span class="title">avltree_insert</span><span class="params">(AVLTree tree, <span class="keyword">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//插入之后分为四种平衡破坏的状态</span></span><br><span class="line">    AVLTree result=<span class="literal">NULL</span>;</span><br><span class="line">    AVLTree tree_to_insert=<span class="built_in">AVLTree_Create</span>(key);</span><br><span class="line">    AVLTree p=tree;</span><br><span class="line">    <span class="keyword">while</span>(p)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(p-&gt;Key&lt;=key)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//如果p的右孩子为空则插入到右</span></span><br><span class="line">            <span class="keyword">if</span>(!p-&gt;Right)</span><br><span class="line">            &#123;</span><br><span class="line">                p-&gt;Right=tree_to_insert;</span><br><span class="line">                tree_to_insert-&gt;Parent=p;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                p=p-&gt;Right;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(p-&gt;Key&gt;=key)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!p-&gt;Left)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//插入为左孩子</span></span><br><span class="line">                p-&gt;Left=tree_to_insert;</span><br><span class="line">                tree_to_insert-&gt;Parent=p;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            p=p-&gt;Left;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!tree)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//说明树本为空</span></span><br><span class="line">        tree=tree_to_insert;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//result= AVLTree_make_it_balance(tree);</span></span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除结点(key是节点值)，返回根节点</span></span><br><span class="line"><span class="function">AVLTree <span class="title">avltree_delete</span><span class="params">(AVLTree tree, <span class="keyword">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AVLTree p=tree;</span><br><span class="line">    AVLTree result=tree;</span><br><span class="line">    <span class="keyword">while</span>(p!=<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(p-&gt;Key&lt;key)</span><br><span class="line">        &#123;</span><br><span class="line">            p=p-&gt;Right;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(p-&gt;Key&gt;key)</span><br><span class="line">        &#123;</span><br><span class="line">            p=p-&gt;Left;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//找到了 </span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(p==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;没有找到这个结点 %d \n&quot;</span>,key);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//找到了结点进行删除并再次平衡。</span></span><br><span class="line">        <span class="comment">//1. 删除的是头节点按 3 4 行事</span></span><br><span class="line">        <span class="comment">//2. 删除的是叶子则直接free</span></span><br><span class="line">        <span class="comment">//3. 删除的结点只有一个孩子则继承其位置</span></span><br><span class="line">        <span class="comment">//4. 删除的结点两个孩子都有，则若其为左孩子，则将其右孩子插入其左孩子的最右边。若其为右孩子，则将其左孩子插入其右孩子的最左边</span></span><br><span class="line">        AVLTree tree_to_del=p;</span><br><span class="line">        AVLTree pre_root=<span class="built_in">AVLTree_Create</span>(<span class="number">0</span>);</span><br><span class="line">        pre_root-&gt;Left=tree;</span><br><span class="line">        tree-&gt;Parent=pre_root;</span><br><span class="line">        <span class="comment">//现在设一个傀儡 pre_root 这样头节点和其他结点都一样了</span></span><br><span class="line">        <span class="comment">//1. 叶子没有孩子</span></span><br><span class="line">        <span class="keyword">if</span>((!tree_to_del-&gt;Left)&amp;&amp;(!tree_to_del-&gt;Right))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(tree_to_del-&gt;Parent-&gt;Left==tree_to_del)</span><br><span class="line">                tree_to_del-&gt;Parent-&gt;Left=<span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">if</span>(tree_to_del-&gt;Parent-&gt;Right==tree_to_del)</span><br><span class="line">                tree_to_del-&gt;Parent-&gt;Right=<span class="literal">NULL</span>;    </span><br><span class="line">            <span class="built_in">free</span>(tree_to_del);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>((tree_to_del-&gt;Left!=<span class="literal">NULL</span>)&amp;&amp;(tree_to_del-&gt;Right==<span class="literal">NULL</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//只有左孩子</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(tree_to_del-&gt;Parent-&gt;Left==tree_to_del)</span><br><span class="line">                tree_to_del-&gt;Parent-&gt;Left=tree_to_del-&gt;Left;</span><br><span class="line">            <span class="keyword">if</span>(tree_to_del-&gt;Parent-&gt;Right==tree_to_del)</span><br><span class="line">                tree_to_del-&gt;Parent-&gt;Right=tree_to_del-&gt;Left;</span><br><span class="line">                </span><br><span class="line">            tree_to_del-&gt;Left-&gt;Parent=tree_to_del-&gt;Parent; </span><br><span class="line">            tree_to_del-&gt;Left-&gt;Heigth--;</span><br><span class="line">            <span class="built_in">free</span>(tree_to_del);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>((tree_to_del-&gt;Left==<span class="literal">NULL</span>)&amp;&amp;(tree_to_del-&gt;Right!=<span class="literal">NULL</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//只有右孩子</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(tree_to_del-&gt;Parent-&gt;Left==tree_to_del)</span><br><span class="line">                tree_to_del-&gt;Parent-&gt;Left=tree_to_del-&gt;Right;</span><br><span class="line">            <span class="keyword">if</span>(tree_to_del-&gt;Parent-&gt;Right==tree_to_del)</span><br><span class="line">                tree_to_del-&gt;Parent-&gt;Right=tree_to_del-&gt;Right;</span><br><span class="line">            </span><br><span class="line">            tree_to_del-&gt;Right-&gt;Parent=tree_to_del-&gt;Parent; </span><br><span class="line">            tree_to_del-&gt;Right-&gt;Heigth--;</span><br><span class="line">            <span class="built_in">free</span>(tree_to_del);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//两个孩子都有</span></span><br><span class="line">            <span class="comment">//若其为左孩子，则将其右孩子插入其左孩子的最右边。若其为右孩子，则将其左孩子插入其右孩子的最左边</span></span><br><span class="line">            <span class="keyword">if</span>(tree_to_del-&gt;Parent-&gt;Left==tree_to_del)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//我觉得不管删除的结点时左孩子还是右孩子，都让其左孩子替代其位置，其右孩子插入到左孩子的最右边</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//寻找左孩子的最右边</span></span><br><span class="line">                AVLTree MAX_Right=tree_to_del-&gt;Left;</span><br><span class="line">                <span class="keyword">while</span>(MAX_Right-&gt;Right)</span><br><span class="line">                &#123;</span><br><span class="line">                    MAX_Right=MAX_Right-&gt;Right;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//将右孩子插入进去</span></span><br><span class="line">                MAX_Right-&gt;Right=tree_to_del-&gt;Right;</span><br><span class="line">                tree_to_del-&gt;Right-&gt;Parent=MAX_Right;</span><br><span class="line">                <span class="comment">//更新其深度信息。 略</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//放置左孩子</span></span><br><span class="line">                <span class="keyword">if</span>(tree_to_del-&gt;Parent-&gt;Left==tree_to_del)</span><br><span class="line">                    tree_to_del-&gt;Parent-&gt;Left=tree_to_del-&gt;Left;</span><br><span class="line">                <span class="keyword">if</span>(tree_to_del-&gt;Parent-&gt;Right==tree_to_del)</span><br><span class="line">                    tree_to_del-&gt;Parent-&gt;Right=tree_to_del-&gt;Left;</span><br><span class="line">                tree_to_del-&gt;Left-&gt;Parent=tree_to_del-&gt;Parent; </span><br><span class="line">                tree_to_del-&gt;Left-&gt;Heigth--;</span><br><span class="line">                <span class="comment">//现在其左孩子已经坐上了他的位置。</span></span><br><span class="line">                <span class="built_in">free</span>(tree_to_del);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//头归原主</span></span><br><span class="line">        tree=pre_root-&gt;Left;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//删除完成，需要判断不平衡的状态并进行修正。</span></span><br><span class="line">    <span class="comment">//result=AVLTree_make_it_balance(tree);</span></span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断一棵树不平衡的状态</span></span><br><span class="line"><span class="function">UNBALANCED_STATUS <span class="title">AVLTree_judge_unbalance_status</span><span class="params">(AVLTree unbalanced_tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// LL, LR, RL, RR, balanceD  </span></span><br><span class="line">    AVLTree tree=unbalanced_tree;</span><br><span class="line">    <span class="comment">//B1: 失衡结点</span></span><br><span class="line">    <span class="comment">//B2：失衡因节点，因为这个结点才失衡的。</span></span><br><span class="line">    <span class="comment">//B3：失衡因节点的一个祖宗&amp;&amp;失衡结点的一个孙子。</span></span><br><span class="line">    <span class="comment">//即寻找B3，既是B2的祖宗（自己可以是自己的祖宗），也是B1的孙子。</span></span><br><span class="line">    <span class="comment">//然后判断B3是B1的哪一个孙子即可得知是哪种情况。</span></span><br><span class="line">    <span class="comment">//向下找两层高度最大的子树，其方向就是不平衡的状态。</span></span><br><span class="line">    <span class="comment">//加等于号为了防止判断不出来 不如这种情况 10 5 1 7 </span></span><br><span class="line">    <span class="comment">//L</span></span><br><span class="line">    <span class="comment">//height_avltree</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">height_avltree</span>(tree-&gt;Left)&gt;=<span class="built_in">height_avltree</span>(tree-&gt;Right))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//L</span></span><br><span class="line">        AVLTree tree_l=tree-&gt;Left;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">height_avltree</span>(tree_l-&gt;Left)&gt;=<span class="built_in">height_avltree</span>(tree_l-&gt;Right))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> LL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">height_avltree</span>(tree_l-&gt;Left)&lt;<span class="built_in">height_avltree</span>(tree_l-&gt;Right))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> LR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//R</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">height_avltree</span>(tree-&gt;Left)&lt;<span class="built_in">height_avltree</span>(tree-&gt;Right))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//L</span></span><br><span class="line">        AVLTree tree_r=tree-&gt;Right;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">height_avltree</span>(tree_r-&gt;Left)&gt;<span class="built_in">height_avltree</span>(tree_r-&gt;Right))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> RL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">height_avltree</span>(tree_r-&gt;Left)&lt;=<span class="built_in">height_avltree</span>(tree_r-&gt;Right))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> RR;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BALANCED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使树平衡。</span></span><br><span class="line"><span class="function">AVLTree <span class="title">AVLTree_make_it_balance</span><span class="params">(AVLTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AVLTree result=tree;</span><br><span class="line">    <span class="comment">//设一个傀儡头节点</span></span><br><span class="line">    AVLTree preroot=<span class="built_in">AVLTree_Create</span>(<span class="number">0</span>);</span><br><span class="line">    preroot-&gt;Left=tree;</span><br><span class="line">    tree-&gt;Parent=preroot;</span><br><span class="line">    <span class="comment">//更新高度</span></span><br><span class="line">    <span class="built_in">update_avltree_heigth</span>(tree);</span><br><span class="line">    <span class="comment">//寻找不平衡的结点</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">search_unbalanced_tree</span>(tree))</span><br><span class="line">    &#123;</span><br><span class="line">        AVLTree unbalanced_tree=<span class="built_in">search_unbalanced_tree</span>(tree);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;结点：%d 不平衡\n&quot;</span>,unbalanced_tree-&gt;Key);</span><br><span class="line">        <span class="comment">//更新高度成功，现在肯可能造成不平衡的只有tree_to_insert,所以判断其父节点的高度信息即可。</span></span><br><span class="line">        <span class="comment">//插入完成，需要判断不平衡的状态并进行修正。</span></span><br><span class="line">        UNBALANCED_STATUS status=<span class="built_in">AVLTree_judge_unbalance_status</span>(unbalanced_tree);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//status=LR;</span></span><br><span class="line">        <span class="keyword">if</span>(status==LL)</span><br><span class="line">        &#123;   </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ll\n&quot;</span>);</span><br><span class="line">            <span class="built_in">ll_rotation</span>(unbalanced_tree);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(status==LR)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;lr\n&quot;</span>);</span><br><span class="line">            <span class="comment">//绕两次，</span></span><br><span class="line">            AVLTree k1=unbalanced_tree-&gt;Left;</span><br><span class="line">            AVLTree k2=unbalanced_tree;</span><br><span class="line">            <span class="built_in">rr_rotation</span>(k1);</span><br><span class="line">            <span class="built_in">ll_rotation</span>(k2);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(status==RR)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;rr\n&quot;</span>);</span><br><span class="line">            <span class="built_in">rr_rotation</span>(unbalanced_tree);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(status==RL)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;rl\n&quot;</span>);</span><br><span class="line">            <span class="comment">//绕两次</span></span><br><span class="line">            AVLTree k1=unbalanced_tree-&gt;Right;</span><br><span class="line">            AVLTree k2=unbalanced_tree;</span><br><span class="line">            <span class="built_in">ll_rotation</span>(k1);</span><br><span class="line">            <span class="built_in">rr_rotation</span>(k2);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;balance\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;树平衡\n&quot;</span>);</span><br><span class="line">    result=preroot-&gt;Left;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">AVLTree <span class="title">balance</span><span class="params">(AVLTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">search_unbalanced_tree</span>(tree))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//update_avltree_heigth(tree);</span></span><br><span class="line">        tree=<span class="built_in">AVLTree_make_it_balance</span>(tree);</span><br><span class="line">        <span class="comment">//print_avltree(tree,tree-&gt;Key,0);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//height</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">height_avltree</span><span class="params">(AVLTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(tree==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> tree-&gt;Heigth;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ll_rotation</span><span class="params">(AVLTree k2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//k1替代k2,k1的右孩子变成k2的左孩子,k2变成k1的右孩子，。</span></span><br><span class="line">    AVLTree k1 = k2-&gt;Left;</span><br><span class="line">    <span class="keyword">if</span> (k2-&gt;Parent-&gt;Left == k2)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//k2是左孩子</span></span><br><span class="line">        k2-&gt;Parent-&gt;Left = k1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        k2-&gt;Parent-&gt;Right = k1;</span><br><span class="line">    &#125;</span><br><span class="line">    k1-&gt;Parent=k2-&gt;Parent;</span><br><span class="line">    k2-&gt;Left = k1-&gt;Right;</span><br><span class="line">    <span class="keyword">if</span> (k1-&gt;Right)</span><br><span class="line">        k1-&gt;Right-&gt;Parent = k2;</span><br><span class="line">    k2-&gt;Left=k1-&gt;Right;</span><br><span class="line">    k2-&gt;Parent = k1;</span><br><span class="line">    k1-&gt;Right = k2;</span><br><span class="line">    <span class="comment">//return k1;   </span></span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rr_rotation</span><span class="params">(AVLTree k2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//k1替代k2 k1的左孩子变成k2的右孩子，k2变为k1的左孩子。</span></span><br><span class="line">    AVLTree k1=k2-&gt;Right;</span><br><span class="line">    <span class="keyword">if</span>(k2-&gt;Parent-&gt;Left==k2)</span><br><span class="line">    &#123;</span><br><span class="line">        k2-&gt;Parent-&gt;Left=k1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        k2-&gt;Parent-&gt;Right=k1;</span><br><span class="line">    &#125;</span><br><span class="line">    k1-&gt;Parent=k2-&gt;Parent;</span><br><span class="line">    <span class="keyword">if</span>(k1-&gt;Left)</span><br><span class="line">        k1-&gt;Left-&gt;Parent=k2;</span><br><span class="line">    k2-&gt;Right=k1-&gt;Left;</span><br><span class="line">    k2-&gt;Parent=k1;</span><br><span class="line">    k1-&gt;Left=k2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// (递归实现)查找&quot;AVL树x&quot;中键值为key的节点</span></span><br><span class="line"><span class="function">AVLTree <span class="title">avltree_search</span><span class="params">(AVLTree tree, <span class="keyword">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(tree==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(tree-&gt;Key==key)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;找到了 %d \n&quot;</span>,key);</span><br><span class="line">        <span class="keyword">return</span> tree;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(key&lt;tree-&gt;Key)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">avltree_search</span>(tree-&gt;Left,key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(key&gt;tree-&gt;Key)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">avltree_search</span>(tree-&gt;Right,key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// (非递归实现)查找&quot;AVL树x&quot;中键值为key的节点</span></span><br><span class="line"><span class="function">AVLTree <span class="title">iterative_avltree_search</span><span class="params">(AVLTree tree, <span class="keyword">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(tree)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(tree-&gt;Key==key)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;找到了 %d \n&quot;</span>,tree-&gt;Key);</span><br><span class="line">            <span class="keyword">return</span> tree;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(tree-&gt;Key&gt;key)</span><br><span class="line">        &#123;</span><br><span class="line">            tree=tree-&gt;Left;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(tree-&gt;Key&lt;key)</span><br><span class="line">        &#123;</span><br><span class="line">            tree=tree-&gt;Right;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找最小结点：返回tree为根结点的AVL树的最小结点。</span></span><br><span class="line"><span class="function">AVLTree <span class="title">avltree_minimum</span><span class="params">(AVLTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AVLTree min=tree;</span><br><span class="line">    <span class="keyword">if</span>(min==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(min-&gt;Left)</span><br><span class="line">        &#123;</span><br><span class="line">            min=min-&gt;Left;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> min;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 查找最大结点：返回tree为根结点的AVL树的最大结点。</span></span><br><span class="line"><span class="function">AVLTree <span class="title">avltree_maximum</span><span class="params">(AVLTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AVLTree max=tree;</span><br><span class="line">    <span class="keyword">if</span>(max==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(max-&gt;Right)</span><br><span class="line">        &#123;</span><br><span class="line">            max=max-&gt;Right;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//打印树</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_avltree</span><span class="params">(AVLTree tree, <span class="keyword">int</span> key, <span class="keyword">int</span> direction)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(tree != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(direction==<span class="number">0</span>)    <span class="comment">// tree是根节点</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%2d is root\n&quot;</span>, tree-&gt;Key, key);</span><br><span class="line">        <span class="keyword">else</span>                <span class="comment">// tree是分支节点</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%2d is %2d&#x27;s %6s child\n&quot;</span>, tree-&gt;Key, key, direction==<span class="number">1</span>?<span class="string">&quot;right&quot;</span> : <span class="string">&quot;left&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print_avltree</span>(tree-&gt;Left, tree-&gt;Key, <span class="number">-1</span>);</span><br><span class="line">        <span class="built_in">print_avltree</span>(tree-&gt;Right,tree-&gt;Key,  <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁AVL树</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">destroy_avltree</span><span class="params">(AVLTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(tree==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">destroy_avltree</span>(tree-&gt;Left);</span><br><span class="line">    <span class="built_in">destroy_avltree</span>(tree-&gt;Right);</span><br><span class="line">    tree-&gt;Parent=<span class="literal">NULL</span>;</span><br><span class="line">    tree-&gt;Left=<span class="literal">NULL</span>;</span><br><span class="line">    tree-&gt;Right=<span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">free</span>(tree);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="接口使用"><a href="#接口使用" class="headerlink" title="接口使用"></a>接口使用</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;avltree.c&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AVLTree tree=<span class="built_in">AVLTree_Init</span>();</span><br><span class="line">    tree=<span class="built_in">avltree_insert</span>(tree,<span class="number">10</span>);</span><br><span class="line">    tree=<span class="built_in">avltree_insert</span>(tree,<span class="number">15</span>);</span><br><span class="line">    tree=<span class="built_in">avltree_insert</span>(tree,<span class="number">8</span>);</span><br><span class="line">    tree=<span class="built_in">avltree_insert</span>(tree,<span class="number">7</span>);</span><br><span class="line">    tree=<span class="built_in">avltree_insert</span>(tree,<span class="number">9</span>);</span><br><span class="line">    <span class="comment">//tree=avltree_delete(tree,15);</span></span><br><span class="line">    <span class="built_in">inorder_avltree</span>(tree);</span><br><span class="line">    <span class="built_in">print_avltree</span>(tree,tree-&gt;Key,<span class="number">0</span>);</span><br><span class="line">    tree=<span class="built_in">balance</span>(tree);</span><br><span class="line">    <span class="built_in">print_avltree</span>(tree,tree-&gt;Key,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;search %d \n&quot;</span>,<span class="built_in">avltree_search</span>(tree,<span class="number">10</span>)?<span class="built_in">avltree_search</span>(tree,<span class="number">10</span>)-&gt;Key:<span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;search %d \n&quot;</span>,<span class="built_in">iterative_avltree_search</span>(tree,<span class="number">7</span>)?<span class="built_in">iterative_avltree_search</span>(tree,<span class="number">7</span>)-&gt;Key:<span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;min: %d \n&quot;</span>,<span class="built_in">avltree_minimum</span>(tree)-&gt;Key);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;min: %d \n&quot;</span>,<span class="built_in">avltree_maximum</span>(tree)-&gt;Key);</span><br><span class="line">    <span class="built_in">destroy_avltree</span>(tree);</span><br><span class="line">    <span class="comment">//printf(&quot;min: %d \n&quot;,avltree_maximum(tree)-&gt;Key);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>











      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://myblog.cuimouren.cn/2021/07/23/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%85%AD-B-tree&&B+tree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="崔文耀">
      <meta itemprop="description" content="Hello, here is wenyao's space, how do you come in???">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="这里是文耀的space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="../../2021/07/23/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%85%AD-B-tree&&B+tree/" class="post-title-link" itemprop="url">数据结构 六 B-tree && B+tree</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-23 15:42:31" itemprop="dateCreated datePublished" datetime="2021-07-23T15:42:31+08:00">2021-07-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-23 16:44:11" itemprop="dateModified" datetime="2021-08-23T16:44:11+08:00">2021-08-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">数据结构</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/B-tree/" itemprop="url" rel="index"><span itemprop="name">B-tree</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Btree"><a href="#Btree" class="headerlink" title="Btree"></a>Btree</h1><p>终于学完了AVL树，现在开始学习BTree，为数据库做准备。</p>
<p>参考资料 <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020416577">https://segmentfault.com/a/1190000020416577</a></p>
<h2 id="BTree的定义"><a href="#BTree的定义" class="headerlink" title="BTree的定义"></a>BTree的定义</h2><p>阶数M，每个结点所能够包含的关键数的数目有一个上下界，用M来限定。M&gt;=2 也成为Btree的最小度数</p>
<p><strong>min:</strong> 每一个非根节点至少由M-1个关键字，每一个非根内节点至少有M个子女，如果树非空，则根节点至少包含一个关键字。</p>
<p><strong>max:</strong> 每个结点最多包含2M-1个关键字，所以一个内节点最多有2M个子女，如果一个结点恰好有2M-1个关键字则称其为满的。</p>
<p>M=2的Btree是最简单的，这时一个内结点可以包含2-3-4个子女，称为一颗2-3-4树，但是在实际使用中常常使用大得多的M值。</p>
<p>BTree要求每一个内节点至少是半满。</p>
<p><strong>在数据结构课本中以及考研中对Btree的定义和算法导论中的定义有些许不同，如下：</strong></p>
<blockquote>
<p>阶数M为非根结点孩子的最大值而不是算法导论中的非根节点孩子的最小值。<br>我不喜欢课本和考研，所以我推崇算法导论的定义。以下实现都是基于算法导论的定义。</p>
<ol>
<li>树中每一个结点至多含有m颗子树，至少含有m/2向上取整个子树</li>
</ol>
</blockquote>
<h2 id="BTree的性质"><a href="#BTree的性质" class="headerlink" title="BTree的性质"></a>BTree的性质</h2><ol>
<li>根节点的key数量可以为1到2*M</li>
<li>非根节点的key的数量在M到2*M</li>
<li>每一个节点的孩子数量必须为其key数量加一，保证每一个key左右各一个孩子。</li>
<li>BTree是自平衡的，无论在什么情况下都是平衡的，子树的高度永远一致。</li>
<li></li>
</ol>
<h2 id="BTree-中的算法"><a href="#BTree-中的算法" class="headerlink" title="BTree 中的算法"></a>BTree 中的算法</h2><h3 id="查询算法"><a href="#查询算法" class="headerlink" title="查询算法"></a>查询算法</h3><p>从根节点进行递归查询直到找到或者确认不存在，遍历置每一个结点时，查询是否为比该结点的最小还要小或者比最大还要大，然后查询节点内是否存在该关键字，否则便利该节点的key,找到两个key使得要查找的关键字介于两者之间。</p>
<h3 id="后继和前驱"><a href="#后继和前驱" class="headerlink" title="后继和前驱"></a>后继和前驱</h3><p>这里只说后继。所谓后继就是中序遍历中后面的那一个key</p>
<ol>
<li>首先由传入的key寻找到对应的结点以及index.</li>
<li>若这个结点是叶子结点且不是叶子中最后一个，则其后面的key为其后继。</li>
<li>若这个结点是叶子结点且为叶子中的最后一个，则递归向上遍历，直到找到一个结点的父节点不是其节点中的最后一个孩子为止，则返回其父节点中对应节点的后面一个孩子。若寻找不到的话返回空。</li>
<li>若为非叶子结点，则其肯定有后继，即为其以右面的那个孩子为根的最小key.关于寻找最大最小key就不赘述了。</li>
</ol>
<h3 id="插入算法"><a href="#插入算法" class="headerlink" title="插入算法"></a>插入算法</h3><p>插入算法是难点所在，这里我的实现并不优雅，由于现在没有时间重制就将就看吧。</p>
<ol>
<li>首先由BTree的性质可知，每一次的插入都应该插入到叶子结点。</li>
<li>在预插入之后，判断插入之后的结点的key数量合不合格，若合格则返回。</li>
<li>数量超标则将结点分裂。</li>
<li>分裂方法：<ol>
<li>将中间的key上浮到父节点，将剩余的key分裂问两个key个数为M的child插入到父节点的对应位置。</li>
<li>若父节点空，则声明一个父节点并且这个父节点是新的树根。这就是为什么根节点的key数量可以为1了。</li>
</ol>
</li>
<li>递归向上浮动，直到某一个结点可以吃得下，不用分裂，返回。</li>
</ol>
<h3 id="删除算法"><a href="#删除算法" class="headerlink" title="删除算法"></a>删除算法</h3><p>写插入算法的时候觉得难，是因为当时没有搞懂BTree的性质，现在将BTree完全实现了一遍就很是明白BTree的性质了。</p>
<p>删除结点要比插入结点复杂，但是弄懂之后也不觉得什么了。</p>
<ol>
<li>查询目标结点和key的index</li>
<li>若要删除的结点为叶子，且删除之后数量大于等于M（若此时根节点也是叶子结点且删除根节点则无此顾虑），则直接删除。</li>
<li>若删除的结点为叶子节点（非根节点）但是删除之后数量小于M，则：<ol>
<li>先删除该key</li>
<li>判断其兄弟结点（由性质可知兄弟结点都是叶子）有没有key数量大于M的，若有的话则借过来。循环着使用根节点跳跃进行。</li>
<li>若没有key数量大于M的，借不了，则与其相邻的一个兄弟和对应的父节点的一个key进行合并，由于只有根节点的key最小可以有一个，所以其与父节点结点合并之后最多只少一个key。</li>
<li>合并之后判断父节点是否合格（根节点或者key数量大于等于M），合格则返回</li>
<li>不合格的话向父结点借key进行合并。规则如下<ol>
<li>确定要进行合并的两个孩子和父节点中的key。</li>
<li>若这三者的key加起来小于等于2*M则进行合并，否则的话说明另一个兄弟有多余的key可以借出来。</li>
<li>若有一个兄弟有多余的key，则进行轮换。具体看代码。</li>
</ol>
</li>
<li>递归进行5直到不需要借或者父节点是根节点且只有一个key</li>
<li>5递归执行完之后判断是否合格（key数量合格或者其为根节点）</li>
<li>不合格则说明此时根节点只有一个key，其中一个孩子需要key。这时将其合并即可。<ol>
<li>这里仍然分为总结点数小于等于2*M或者大于</li>
<li>若小于等于则合并为一个根</li>
<li>若大于则进行轮换。具体看代码。</li>
</ol>
</li>
</ol>
</li>
<li>若删除的是非叶子结点，则递归的使用后继进行替代，然后删除后继，直到叶子结点，在进行上面两步对叶子的操作。</li>
</ol>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><h4 id="BTree-h"><a href="#BTree-h" class="headerlink" title="BTree.h"></a>BTree.h</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _BSTREE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _BSTREE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ungigned long long int</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> M</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> M 8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAX_KEY_NUM = <span class="number">2</span> * M;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> MAX_CHILD_NUM = <span class="number">2</span> * M + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">BTREE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> key_num;                    <span class="comment">//键的数量</span></span><br><span class="line">    <span class="keyword">int</span> child_num;                  <span class="comment">//孩子数量 孩子数量永远等于key的数量加一</span></span><br><span class="line">    <span class="keyword">int</span> key[<span class="number">2</span> * M + <span class="number">1</span>];             <span class="comment">//键  冗余一位，child同理</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BTREE</span> *<span class="title">child</span>[2 * <span class="title">M</span> + 2];</span> <span class="comment">//最多拥有 2M+1个孩子</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BTREE</span> *<span class="title">parent</span>;</span>           <span class="comment">//父节点</span></span><br><span class="line">    <span class="keyword">bool</span> isleaf;</span><br><span class="line">    <span class="comment">//BTree在实际运用中还需要存储值，但是这里就不用了。</span></span><br><span class="line">&#125; Node, *BTree;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化一个空树</span></span><br><span class="line"><span class="function">BTree <span class="title">BTree_Init</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 前序遍历</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">preorder</span><span class="params">(BTree tree)</span></span>;</span><br><span class="line"><span class="comment">// 中序遍历</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inorder</span><span class="params">(BTree tree)</span></span>;</span><br><span class="line"><span class="comment">// 后序遍历</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">postorder</span><span class="params">(BTree tree)</span></span>;</span><br><span class="line"><span class="comment">//打印Btree</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_btree</span><span class="params">(BTree tree, <span class="keyword">int</span> key, <span class="keyword">int</span> direction)</span></span>;</span><br><span class="line"><span class="comment">// (递归实现)查找&quot;b树x&quot;中键值为key的节点</span></span><br><span class="line"><span class="function">BTree <span class="title">search</span><span class="params">(BTree tree, <span class="keyword">int</span> key, <span class="keyword">int</span> *index)</span></span>;</span><br><span class="line"><span class="comment">// (非递归实现)查找&quot;b树x&quot;中键值为key的节点</span></span><br><span class="line"><span class="function">BTree <span class="title">search_iterative</span><span class="params">(BTree tree, <span class="keyword">int</span> key, <span class="keyword">int</span> *index)</span></span>;</span><br><span class="line"><span class="comment">// 查找最小结点</span></span><br><span class="line"><span class="function">BTree <span class="title">minimum</span><span class="params">(BTree tree, <span class="keyword">int</span> *index)</span></span>;</span><br><span class="line"><span class="comment">// 查找最大结点</span></span><br><span class="line"><span class="function">BTree <span class="title">maximum</span><span class="params">(BTree tree, <span class="keyword">int</span> *index)</span></span>;</span><br><span class="line"><span class="comment">// 将结点插入</span></span><br><span class="line"><span class="function">BTree <span class="title">insert</span><span class="params">(BTree tree, <span class="keyword">int</span> key)</span></span>;</span><br><span class="line"><span class="comment">//将一个值插入一个结点，返回更新过后的树</span></span><br><span class="line"><span class="function">BTree <span class="title">insert_into_node</span><span class="params">(BTree tree, BTree node_to_insert, <span class="keyword">int</span> key, <span class="keyword">bool</span> is_key_to_up, <span class="keyword">int</span> index, BTree tree_left, BTree tree_right)</span></span>;</span><br><span class="line"><span class="comment">// 删除结点</span></span><br><span class="line"><span class="function">BTree <span class="title">delete_btree</span><span class="params">(BTree tree, <span class="keyword">bool</span> useindex, BTree del_tree, <span class="keyword">int</span> del_key_index, <span class="keyword">int</span> key)</span></span>;</span><br><span class="line"><span class="comment">//后继</span></span><br><span class="line"><span class="function">BTree <span class="title">success_btree</span><span class="params">(BTree tree, <span class="keyword">bool</span> useindex, BTree tree_source, <span class="keyword">int</span> *index_source, <span class="keyword">int</span> key, <span class="keyword">int</span> *index_success)</span></span>;</span><br><span class="line"><span class="comment">//孩子</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">childindex</span><span class="params">(BTree pa, BTree son)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">borrow_direction</span><span class="params">(BTree tree)</span></span>;</span><br><span class="line"><span class="comment">//交换左侧</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">l_exchange</span><span class="params">(BTree tree, <span class="keyword">int</span> index_key)</span></span>;</span><br><span class="line"><span class="comment">//交换左侧</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">r_exchange</span><span class="params">(BTree tree, <span class="keyword">int</span> index_key)</span></span>;</span><br><span class="line"><span class="function">BTree <span class="title">merge_onekey</span><span class="params">(BTree tree)</span></span>;</span><br><span class="line"><span class="function">BTree <span class="title">merge</span><span class="params">(BTree tree)</span></span>;</span><br><span class="line"><span class="function">BTree <span class="title">borrow_from_parent</span><span class="params">(BTree tree)</span></span>;</span><br><span class="line"><span class="function">BTree <span class="title">merge_root</span><span class="params">(BTree tree)</span></span>;</span><br><span class="line"><span class="comment">//协调两个孩子的节点数量 多的给少的一个，这其中当然也要通过parent-&gt;key进行交换</span></span><br><span class="line"><span class="function">BTree <span class="title">balance_two_child</span><span class="params">(BTree tree, <span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function">BTree <span class="title">merge_parent</span><span class="params">(BTree tree, <span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="comment">// 销毁b树</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">(BTree tree)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>


<h4 id="BTree-c"><a href="#BTree-c" class="headerlink" title="BTree.c"></a>BTree.c</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;BTree.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">typedef struct BTREE</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    int key_num;//键的数量</span></span><br><span class="line"><span class="comment">    int key[2*M+1];//键,有一个冗余的键用来预插入</span></span><br><span class="line"><span class="comment">    BTREE * child[2*M+1];//最多拥有 2M+1个孩子</span></span><br><span class="line"><span class="comment">    bool isleaf;</span></span><br><span class="line"><span class="comment">    //BTree在实际运用中还需要存储值，但是这里就不用了。</span></span><br><span class="line"><span class="comment">&#125;Node,*BTree;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化一个空树</span></span><br><span class="line"><span class="function">BTree <span class="title">BTree_Init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前序遍历</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">preorder</span><span class="params">(BTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tree)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//printf(&quot;tree-&gt;key_num %d\n&quot;,tree-&gt;key_num);</span></span><br><span class="line">        <span class="comment">//打印结点内的第一个值，打印结点的第一个孩子结点，依次打印后面的值和结点</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= tree-&gt;key_num - <span class="number">1</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//printf(&quot; %d&quot;, tree-&gt;key[i]);</span></span><br><span class="line">            <span class="built_in">preorder</span>(tree-&gt;child[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">preorder</span>(tree-&gt;child[tree-&gt;key_num]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 中序遍历</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inorder</span><span class="params">(BTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tree)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//打印结点内的第一个值，打印结点的第一个孩子结点，依次打印后面的值和结点</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= tree-&gt;key_num - <span class="number">1</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">inorder</span>(tree-&gt;child[i]);</span><br><span class="line">            <span class="comment">//printf(&quot; %d&quot;, tree-&gt;key[i]);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">inorder</span>(tree-&gt;child[tree-&gt;key_num]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 后序遍历</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">postorder</span><span class="params">(BTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tree)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//后序遍历，</span></span><br><span class="line">        <span class="built_in">postorder</span>(tree-&gt;child[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= tree-&gt;key_num - <span class="number">1</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">postorder</span>(tree-&gt;child[i + <span class="number">1</span>]);</span><br><span class="line">            <span class="comment">//printf(&quot; %d&quot;, tree-&gt;key[i]);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_btree</span><span class="params">(BTree tree, <span class="keyword">int</span> key, <span class="keyword">int</span> direction)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (递归实现)查找&quot;b树x&quot;中键值为key的节点</span></span><br><span class="line"><span class="function">BTree <span class="title">search</span><span class="params">(BTree tree, <span class="keyword">int</span> key, <span class="keyword">int</span> *index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *index = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (tree)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> child_index = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (tree-&gt;key[<span class="number">0</span>] &gt; key)</span><br><span class="line">            child_index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (tree-&gt;key[tree-&gt;key_num - <span class="number">1</span>] &lt; key)</span><br><span class="line">            child_index = tree-&gt;key_num;</span><br><span class="line">        <span class="comment">//只有一个结点判断是否相等</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= tree-&gt;key_num - <span class="number">1</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (tree-&gt;key[i] == key)</span><br><span class="line">            &#123;</span><br><span class="line">                *index = i;</span><br><span class="line">                <span class="keyword">return</span> tree;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//两个或以上结点判断出口</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= tree-&gt;key_num - <span class="number">2</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> left = tree-&gt;key[i];</span><br><span class="line">            <span class="keyword">int</span> right = tree-&gt;key[i + <span class="number">1</span>];</span><br><span class="line">            <span class="comment">//printf(&quot;key: %d left: %d right: %d \n&quot;,key,left,right);</span></span><br><span class="line">            <span class="keyword">if</span> (left == key)</span><br><span class="line">            &#123;</span><br><span class="line">                *index = i;</span><br><span class="line">                <span class="keyword">return</span> tree;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (right == key)</span><br><span class="line">            &#123;</span><br><span class="line">                *index = i + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">return</span> tree;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((left &lt; key) &amp;&amp; (key &lt; right))</span><br><span class="line">            &#123;</span><br><span class="line">                child_index = i + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">search</span>(tree-&gt;child[child_index], key, index);</span><br><span class="line">    &#125;</span><br><span class="line">    *index = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// (非递归实现)查找&quot;b树x&quot;中键值为key的节点</span></span><br><span class="line"><span class="function">BTree <span class="title">search_iterative</span><span class="params">(BTree tree, <span class="keyword">int</span> key, <span class="keyword">int</span> *index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (tree)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> child_index = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (tree-&gt;key[<span class="number">0</span>] &gt; key)</span><br><span class="line">            child_index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (tree-&gt;key[tree-&gt;key_num - <span class="number">1</span>] &lt; key)</span><br><span class="line">            child_index = tree-&gt;key_num;</span><br><span class="line">        <span class="comment">//只有一个结点判断是否相等</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= tree-&gt;key_num - <span class="number">1</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (tree-&gt;key[i] == key)</span><br><span class="line">            &#123;</span><br><span class="line">                *index = i;</span><br><span class="line">                <span class="keyword">return</span> tree;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= tree-&gt;key_num - <span class="number">2</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> left = tree-&gt;key[i];</span><br><span class="line">            <span class="keyword">int</span> right = tree-&gt;key[i + <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (left == key)</span><br><span class="line">            &#123;</span><br><span class="line">                *index = i;</span><br><span class="line">                <span class="keyword">return</span> tree;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (right == key)</span><br><span class="line">            &#123;</span><br><span class="line">                *index = i + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">return</span> tree;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((left &lt; key) &amp;&amp; (key &lt; right))</span><br><span class="line">            &#123;</span><br><span class="line">                child_index = i + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        tree = tree-&gt;child[child_index];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//没找到</span></span><br><span class="line">    *index = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找最小结点</span></span><br><span class="line"><span class="function">BTree <span class="title">minimum</span><span class="params">(BTree tree, <span class="keyword">int</span> *index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tree == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *index = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (tree-&gt;isleaf == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">minimum</span>(tree-&gt;child[<span class="number">0</span>], index);</span><br><span class="line">    &#125;</span><br><span class="line">    *index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 查找最大结点</span></span><br><span class="line"><span class="function">BTree <span class="title">maximum</span><span class="params">(BTree tree, <span class="keyword">int</span> *index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tree == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *index = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (tree-&gt;isleaf == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">maximum</span>(tree-&gt;child[tree-&gt;key_num], index);</span><br><span class="line">    &#125;</span><br><span class="line">    *index = tree-&gt;key_num;</span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将结点插入</span></span><br><span class="line"><span class="function">BTree <span class="title">insert</span><span class="params">(BTree tree, <span class="keyword">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//printf(&quot;insert %d \n&quot;, key);</span></span><br><span class="line">    <span class="comment">//首先找到应该插入的结点,若插入后超载了，则从中间将这个结点一分为二，将中间的结点插入到父节点上，父节点上的插入同理，直到插入成功。</span></span><br><span class="line">    <span class="comment">//空结点直接插入,</span></span><br><span class="line">    <span class="keyword">if</span> (tree == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        tree = <span class="built_in">insert_into_node</span>(tree, <span class="literal">NULL</span>, key, <span class="literal">false</span>, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> tree;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//tree不空 则寻找合适的插入点 遍历结点找到合适的插入子节点，重复，直到到达叶子  普通插入只能首选叶子进行插入。</span></span><br><span class="line">    BTree node_to_insert = tree;</span><br><span class="line">    <span class="keyword">while</span> (node_to_insert-&gt;isleaf == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//判断插入到哪一个child</span></span><br><span class="line">        <span class="keyword">int</span> child_index = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//小于最左边的，则插入到 child0</span></span><br><span class="line">        <span class="keyword">if</span> (key &lt; node_to_insert-&gt;key[<span class="number">0</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            child_index = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//大于最右边的</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (key &gt; node_to_insert-&gt;key[node_to_insert-&gt;key_num - <span class="number">1</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            child_index = node_to_insert-&gt;key_num;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//从中间找合适的位置</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= node_to_insert-&gt;key_num - <span class="number">2</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> left = node_to_insert-&gt;key[i];</span><br><span class="line">                <span class="keyword">int</span> right = node_to_insert-&gt;key[i + <span class="number">1</span>];</span><br><span class="line">                <span class="keyword">if</span> ((left &lt; key) &amp;&amp; (key &lt; right))</span><br><span class="line">                &#123;</span><br><span class="line">                    child_index = i + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//找到合适的插入分支，进行插入</span></span><br><span class="line">        node_to_insert = node_to_insert-&gt;child[child_index];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//经过数个分支，已经到达叶子结点，进行结点级别的插入。node_to_insert</span></span><br><span class="line">    <span class="keyword">if</span> (node_to_insert-&gt;isleaf == <span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        tree = <span class="built_in">insert_into_node</span>(tree, node_to_insert, key, <span class="literal">false</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//将一个值插入一个结点，返回更新过后的树,这里还有插入的是上浮结点的情况。index指的是上浮结点之前所在的结点是要插入到的结点的第几个child</span></span><br><span class="line"><span class="function">BTree <span class="title">insert_into_node</span><span class="params">(BTree tree, BTree node_to_insert, <span class="keyword">int</span> key, <span class="keyword">bool</span> is_key_to_up, <span class="keyword">int</span> index, BTree tree_left, BTree tree_right)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//记得每一次产生新的节点之后更新叶子信息。</span></span><br><span class="line">    <span class="comment">//若插入后超载了，则从中间将这个结点一分为二，将中间的结点插入到父节点上，父节点上的插入同理，直到插入成功。</span></span><br><span class="line">    <span class="comment">//若上浮结点且index为-1的话说明是头结点分裂</span></span><br><span class="line">    <span class="comment">//先插入这个结点，再判断是否满</span></span><br><span class="line">    <span class="comment">//node_to_insert==NULL 说明要产生一个新的父节点，当然第一次插入的时候也是如此</span></span><br><span class="line">    <span class="comment">//printf(&quot;insert_into_node %d \n&quot;, key);</span></span><br><span class="line">    <span class="keyword">if</span> (node_to_insert == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        tree = (BTree)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(struct BTREE));</span><br><span class="line">        tree-&gt;key[<span class="number">0</span>] = key;</span><br><span class="line">        tree-&gt;key_num = <span class="number">1</span>;</span><br><span class="line">        tree-&gt;child_num = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">2</span> * M; i++)</span><br><span class="line">            tree-&gt;child[i] = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">//若初始化根节点则都为空，若是后来分裂产生的根节点，则指向传来的参数。</span></span><br><span class="line">        <span class="keyword">if</span> (tree_left)</span><br><span class="line">            tree_left-&gt;parent = tree;</span><br><span class="line">        <span class="keyword">if</span> (tree_right)</span><br><span class="line">            tree_right-&gt;parent = tree;</span><br><span class="line">        tree-&gt;child[<span class="number">0</span>] = tree_left;</span><br><span class="line">        tree-&gt;child[<span class="number">1</span>] = tree_right;</span><br><span class="line">        tree-&gt;parent = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="comment">//如果不是上浮上来的则为叶子，否则不是叶子</span></span><br><span class="line">        <span class="keyword">if</span> (is_key_to_up)</span><br><span class="line">            tree-&gt;isleaf = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            tree-&gt;isleaf = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> tree;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> key_index = <span class="number">-1</span>; <span class="comment">//插入的目标位置</span></span><br><span class="line">    <span class="keyword">if</span> (node_to_insert-&gt;key[<span class="number">0</span>] &gt; key)</span><br><span class="line">    &#123;</span><br><span class="line">        key_index = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (node_to_insert-&gt;key[node_to_insert-&gt;key_num - <span class="number">1</span>] &lt; key)</span><br><span class="line">    &#123;</span><br><span class="line">        key_index = node_to_insert-&gt;key_num;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//从中间找合适的位置</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= node_to_insert-&gt;key_num - <span class="number">2</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> left = node_to_insert-&gt;key[i];</span><br><span class="line">            <span class="keyword">int</span> right = node_to_insert-&gt;key[i + <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> ((left &lt; key) &amp;&amp; (key &lt; right))</span><br><span class="line">            &#123;</span><br><span class="line">                key_index = i + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//插入到key_index位置，因为有一个冗余的键用于预插入所以可以放心的插入</span></span><br><span class="line">    node_to_insert-&gt;key_num++;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = node_to_insert-&gt;key_num - <span class="number">1</span>; i &gt;= key_index + <span class="number">1</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        node_to_insert-&gt;key[i] = node_to_insert-&gt;key[i - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    node_to_insert-&gt;key[key_index] = key;</span><br><span class="line">    <span class="comment">//预载入child  只有上升节点才需要更新child</span></span><br><span class="line">    <span class="keyword">if</span> (is_key_to_up)</span><br><span class="line">    &#123;</span><br><span class="line">        node_to_insert-&gt;child_num = node_to_insert-&gt;key_num + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//child[index]指向带上来的左节点，child[index+1]指向右节点，孩子的数量永远等于key的数量加一</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = node_to_insert-&gt;key_num; i &gt;= index + <span class="number">2</span>; i--)</span><br><span class="line">        &#123;</span><br><span class="line">            node_to_insert-&gt;child[i] = node_to_insert-&gt;child[i - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        node_to_insert-&gt;child[key_index] = tree_left;</span><br><span class="line">        node_to_insert-&gt;child[key_index + <span class="number">1</span>] = tree_right;</span><br><span class="line">        tree_left-&gt;parent = node_to_insert;</span><br><span class="line">        tree_right-&gt;parent = node_to_insert;</span><br><span class="line">        <span class="comment">//return tree;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//预插入成功，判断是否超载</span></span><br><span class="line">    <span class="comment">//未超载</span></span><br><span class="line">    <span class="keyword">if</span> (node_to_insert-&gt;key_num &lt;= MAX_KEY_NUM)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//未超载，去下面判断是否为上浮结点，否的话直接返回。</span></span><br><span class="line">        <span class="keyword">if</span> (!is_key_to_up)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> tree;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> tree;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//超载,将中间的key上浮插入，两边节点各成一家</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> middle_position = M; <span class="comment">//索引值小于M的为左节点，大于M的为右节点，M为中间节点，上移</span></span><br><span class="line">        <span class="keyword">int</span> key_to_up = node_to_insert-&gt;key[middle_position];</span><br><span class="line">        <span class="comment">//将分裂开的child线分别连接到key_to_up插入的地方的左右</span></span><br><span class="line">        <span class="comment">//这里要注意递归的插入，若当前节点是内部结点还需要进行他的子节点的分配。将中间的子节点分配给右侧的结点，因为不可缺少最左边的child</span></span><br><span class="line">        <span class="comment">//得到 index   指的是上浮结点之前所在的结点是要插入到的结点的第几个child</span></span><br><span class="line">        <span class="keyword">int</span> key_to_up_index = <span class="number">-1</span>; <span class="comment">//若结果是-1，说明没有父节点，这是一个根节点分裂</span></span><br><span class="line">        <span class="comment">//有父节点</span></span><br><span class="line">        <span class="keyword">if</span> (node_to_insert-&gt;parent != <span class="literal">NULL</span>)</span><br><span class="line">        &#123; <span class="comment">//判断index</span></span><br><span class="line">            <span class="keyword">int</span> child_num = node_to_insert-&gt;parent-&gt;key_num + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= child_num; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (node_to_insert-&gt;parent-&gt;child[i] == node_to_insert)</span><br><span class="line">                &#123;</span><br><span class="line">                    key_to_up_index = i;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//保留0 - M-1 个key在t_l 剩下的放在右边t_r</span></span><br><span class="line">            BTree t_l = node_to_insert;</span><br><span class="line">            BTree t_r = (BTree)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(struct BTREE));</span><br><span class="line">            <span class="keyword">if</span> (!t_r)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;内存不足\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">            &#125;</span><br><span class="line">            t_r-&gt;key_num = M; <span class="comment">//error: 48344239 原因，电脑内存不够</span></span><br><span class="line">            t_l-&gt;key_num = M;</span><br><span class="line">            <span class="comment">//如果这个结点是因为下层结点上升才分裂的，则为非叶子结点</span></span><br><span class="line">            <span class="keyword">if</span> (is_key_to_up)</span><br><span class="line">            &#123;</span><br><span class="line">                t_r-&gt;isleaf = <span class="literal">false</span>;</span><br><span class="line">                t_l-&gt;isleaf = <span class="literal">false</span>;</span><br><span class="line">                t_r-&gt;child_num = M + <span class="number">1</span>;</span><br><span class="line">                t_l-&gt;child_num = M + <span class="number">1</span>;</span><br><span class="line">                t_r-&gt;parent = node_to_insert-&gt;parent;</span><br><span class="line">                t_l-&gt;parent = node_to_insert-&gt;parent;</span><br><span class="line">                <span class="comment">//非叶子结点，说明其child为满的，并且还有上升结点带来的tree_left 和 tree_right</span></span><br><span class="line">                <span class="comment">//放置child</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= M; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_l-&gt;child[i] = node_to_insert-&gt;child[i];</span><br><span class="line">                    t_l-&gt;child[i]-&gt;parent = t_l;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = M + <span class="number">1</span>; i &lt;= <span class="number">2</span> * M + <span class="number">1</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_r-&gt;child[i - M - <span class="number">1</span>] = node_to_insert-&gt;child[i];</span><br><span class="line">                    t_r-&gt;child[i - M - <span class="number">1</span>]-&gt;parent = t_r;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = M + <span class="number">1</span>; i &lt;= <span class="number">2</span> * M + <span class="number">1</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_l-&gt;child[i] = <span class="literal">NULL</span>;</span><br><span class="line">                    t_r-&gt;child[i] = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//放置key</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= M - <span class="number">1</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_l-&gt;key[i] = node_to_insert-&gt;key[i];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = M + <span class="number">1</span>; i &lt;= <span class="number">2</span> * M; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_r-&gt;key[i - M - <span class="number">1</span>] = node_to_insert-&gt;key[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//叶子的分裂 不需要分配child</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                t_r-&gt;isleaf = <span class="literal">true</span>;</span><br><span class="line">                t_l-&gt;isleaf = <span class="literal">true</span>;</span><br><span class="line">                t_r-&gt;child_num = <span class="number">0</span>;</span><br><span class="line">                t_l-&gt;child_num = <span class="number">0</span>;</span><br><span class="line">                t_r-&gt;parent = node_to_insert-&gt;parent;</span><br><span class="line">                t_l-&gt;parent = node_to_insert-&gt;parent;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">2</span> * M + <span class="number">1</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_l-&gt;child[i] = <span class="literal">NULL</span>;</span><br><span class="line">                    t_r-&gt;child[i] = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//放置key</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= M - <span class="number">1</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_l-&gt;key[i] = node_to_insert-&gt;key[i];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = M + <span class="number">1</span>; i &lt;= <span class="number">2</span> * M; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_r-&gt;key[i - M - <span class="number">1</span>] = node_to_insert-&gt;key[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">insert_into_node</span>(tree, node_to_insert-&gt;parent, key_to_up, <span class="literal">true</span>, key_to_up_index, t_l, t_r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//父节点为空，说明这是一次根节点分裂</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//保留0 - M-1 个key在t_l 剩下的放在右边t_r</span></span><br><span class="line">            BTree t_l = node_to_insert;</span><br><span class="line">            BTree t_r = (BTree)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(struct BTREE));</span><br><span class="line">            t_r-&gt;key_num = M;</span><br><span class="line">            t_l-&gt;key_num = M;</span><br><span class="line">            <span class="comment">//如果这个结点是因为下层结点上升才分裂的，则为非叶子结点</span></span><br><span class="line">            <span class="keyword">if</span> (is_key_to_up)</span><br><span class="line">            &#123;</span><br><span class="line">                t_r-&gt;isleaf = <span class="literal">false</span>;</span><br><span class="line">                t_l-&gt;isleaf = <span class="literal">false</span>;</span><br><span class="line">                t_r-&gt;child_num = M + <span class="number">1</span>;</span><br><span class="line">                t_l-&gt;child_num = M + <span class="number">1</span>;</span><br><span class="line">                t_r-&gt;parent = node_to_insert-&gt;parent;</span><br><span class="line">                t_l-&gt;parent = node_to_insert-&gt;parent;</span><br><span class="line">                <span class="comment">//非叶子结点，说明其child为满的，并且还有上升结点带来的tree_left 和 tree_right</span></span><br><span class="line">                <span class="comment">//放置child</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= M; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_l-&gt;child[i] = node_to_insert-&gt;child[i];</span><br><span class="line">                    t_l-&gt;child[i]-&gt;parent = t_l;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = M + <span class="number">1</span>; i &lt;= <span class="number">2</span> * M + <span class="number">1</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_r-&gt;child[i - M - <span class="number">1</span>] = node_to_insert-&gt;child[i];</span><br><span class="line">                    t_r-&gt;child[i - M - <span class="number">1</span>]-&gt;parent = t_r;</span><br><span class="line">                    t_l-&gt;child[i] = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = M + <span class="number">1</span>; i &lt;= <span class="number">2</span> * M + <span class="number">1</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_l-&gt;child[i] = <span class="literal">NULL</span>;</span><br><span class="line">                    t_r-&gt;child[i] = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//放置key</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= M - <span class="number">1</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_l-&gt;key[i] = node_to_insert-&gt;key[i];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = M + <span class="number">1</span>; i &lt;= <span class="number">2</span> * M; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_r-&gt;key[i - M - <span class="number">1</span>] = node_to_insert-&gt;key[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//叶子的分裂 不需要分配child</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                t_r-&gt;isleaf = <span class="literal">true</span>;</span><br><span class="line">                t_l-&gt;isleaf = <span class="literal">true</span>;</span><br><span class="line">                t_r-&gt;child_num = <span class="number">0</span>;</span><br><span class="line">                t_l-&gt;child_num = <span class="number">0</span>;</span><br><span class="line">                t_r-&gt;parent = node_to_insert-&gt;parent;</span><br><span class="line">                t_l-&gt;parent = node_to_insert-&gt;parent;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">2</span> * M + <span class="number">1</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_l-&gt;child[i] = <span class="literal">NULL</span>;</span><br><span class="line">                    t_r-&gt;child[i] = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//放置key</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= M - <span class="number">1</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_l-&gt;key[i] = node_to_insert-&gt;key[i];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = M + <span class="number">1</span>; i &lt;= <span class="number">2</span> * M; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    t_r-&gt;key[i - M - <span class="number">1</span>] = node_to_insert-&gt;key[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">insert_into_node</span>(tree, <span class="literal">NULL</span>, key_to_up, <span class="literal">true</span>, <span class="number">-1</span>, t_l, t_r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除数据</span></span><br><span class="line"><span class="function">BTree <span class="title">delete_btree</span><span class="params">(BTree tree, <span class="keyword">bool</span> useindex, BTree del_tree, <span class="keyword">int</span> del_key_index, <span class="keyword">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//1. 删除叶子节点 且 删除之后key_num&gt;=M , 直接删除</span></span><br><span class="line">    <span class="comment">//2. 删除叶子节点但是删除过后 keu_num&lt;M ,则</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//寻找要删除的数据 不使用index</span></span><br><span class="line">    <span class="keyword">if</span> (useindex == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        del_tree = <span class="built_in">search</span>(tree, key, &amp;del_key_index);</span><br><span class="line">        <span class="keyword">if</span> (del_tree)</span><br><span class="line">            ; <span class="comment">//printf(&quot;search %d\n&quot;, del_tree-&gt;key[del_key_index]);</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;删除失败 没找到 %d\n&quot;</span>, key);</span><br><span class="line">            <span class="keyword">return</span> tree;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        key = del_tree-&gt;key[del_key_index];</span><br><span class="line">        <span class="comment">//printf(&quot;删除 %d 使用index\n&quot;,del_tree-&gt;key[del_key_index]);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//printf(&quot;delete_btree 删除 %d \n&quot;,del_tree-&gt;key[del_key_index]);</span></span><br><span class="line">    <span class="comment">//情况一 叶子结点且删除后key_num&gt;=M 或者是根节点</span></span><br><span class="line">    <span class="keyword">if</span> (((del_tree-&gt;key_num &gt;= M + <span class="number">1</span>) || (del_tree-&gt;parent == <span class="literal">NULL</span>)) &amp;&amp; (del_tree-&gt;isleaf == <span class="literal">true</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//printf(&quot;1 删除叶子结点 %d \n&quot;,del_tree-&gt;key[del_key_index]);</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = del_key_index; i &lt;= del_tree-&gt;key_num - <span class="number">2</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            del_tree-&gt;key[i] = del_tree-&gt;key[i + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        del_tree-&gt;key_num--;</span><br><span class="line">        <span class="keyword">if</span> (del_tree-&gt;parent == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//根节点</span></span><br><span class="line">            <span class="keyword">if</span> (del_tree-&gt;key_num == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">free</span>(tree);</span><br><span class="line">                tree = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//printf(&quot;1 删除成功\n&quot;);</span></span><br><span class="line">        <span class="keyword">return</span> tree;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 删除叶子(非根节点)，但是删除之后小于M</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((del_tree-&gt;key_num &lt; M + <span class="number">1</span>) &amp;&amp; (del_tree-&gt;isleaf == <span class="literal">true</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//printf(&quot;2 删除非叶子结点 %d \n&quot;,del_tree-&gt;key[del_key_index]);</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = del_key_index; i &lt;= del_tree-&gt;key_num - <span class="number">2</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            del_tree-&gt;key[i] = del_tree-&gt;key[i + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        del_tree-&gt;key_num--;</span><br><span class="line">        <span class="comment">//判断左右哪一侧可以借key</span></span><br><span class="line">        <span class="comment">//-1: 左侧是否可以借  1: 右    0：都不可借，只有合并</span></span><br><span class="line">        <span class="keyword">int</span> borrow = <span class="built_in">borrow_direction</span>(del_tree);</span><br><span class="line">        <span class="comment">//左</span></span><br><span class="line">        <span class="keyword">if</span> (borrow == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;borrwo -1\n&quot;</span>);</span><br><span class="line">            <span class="keyword">int</span> index_child = <span class="built_in">childindex</span>(del_tree-&gt;parent, del_tree);</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                index_child--;</span><br><span class="line">                <span class="comment">//将index_child左右两侧进行交换,返回交换过后的左侧结点剩余值</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">l_exchange</span>(del_tree-&gt;parent, index_child) &gt;= M)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//右</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (borrow == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;borrwo 1\n&quot;</span>);</span><br><span class="line">            <span class="comment">//这里的叶子为非根节点</span></span><br><span class="line">            <span class="keyword">int</span> index_child = <span class="built_in">childindex</span>(del_tree-&gt;parent, del_tree) - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                index_child++;</span><br><span class="line">                <span class="comment">//将index_child左右两侧进行交换,返回交换过后的左侧结点剩余值</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">r_exchange</span>(del_tree-&gt;parent, index_child) &gt;= M)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//都不能借，进行合并</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (borrow == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//先合并，合并完成之后判断是否符合标准 返回合并之后的parent,如果是根节点的话就直接返回根节点</span></span><br><span class="line">            del_tree = <span class="built_in">merge</span>(del_tree);</span><br><span class="line">            <span class="comment">//判断是否合格</span></span><br><span class="line">            <span class="keyword">if</span> (del_tree-&gt;key_num &gt;= M || del_tree-&gt;parent == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (del_tree-&gt;parent == <span class="literal">NULL</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//根节点</span></span><br><span class="line">                    <span class="keyword">return</span> del_tree;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> tree;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//不合格 这里的del肯定不指向根节点</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                del_tree = <span class="built_in">borrow_from_parent</span>(del_tree);</span><br><span class="line">                <span class="comment">//现在del_tree 指向借的最后一个结点，判断是否借成功  &gt;=M 或者是根节点</span></span><br><span class="line">                <span class="keyword">if</span> (del_tree-&gt;key_num &gt;= M || del_tree-&gt;parent == <span class="literal">NULL</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> tree;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//没有借成功，说明现在del为根节点的儿子且根节点只有一个key</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">merge_root</span>(tree);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//printf(&quot;2 删除成功\n&quot;);</span></span><br><span class="line">        <span class="keyword">return</span> tree;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//删除非叶子，递归使用后继元素进行替代并且删除后继元素。</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (del_tree-&gt;isleaf == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//printf(&quot;3 删除非叶子结点 %d \n&quot;,del_tree-&gt;key[del_key_index]);</span></span><br><span class="line">        del_tree;</span><br><span class="line">        del_key_index;</span><br><span class="line">        <span class="keyword">int</span> index_success = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">while</span> (del_tree-&gt;isleaf == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            BTree successor = <span class="built_in">success_btree</span>(tree, <span class="literal">true</span>, del_tree, &amp;del_key_index, <span class="number">-1</span>, &amp;index_success);</span><br><span class="line">            <span class="comment">//替换</span></span><br><span class="line">            del_tree-&gt;key[del_key_index] = successor-&gt;key[index_success];</span><br><span class="line">            del_tree = successor;</span><br><span class="line">            del_key_index = index_success;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//del_tree现在指向叶子结点，递归到上两层。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">delete_btree</span>(tree, <span class="literal">true</span>, del_tree, del_key_index, <span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;删除失败\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//寻找后继 即中序遍历中的后面一位</span></span><br><span class="line"><span class="function">BTree <span class="title">success_btree</span><span class="params">(BTree tree, <span class="keyword">bool</span> useindex, BTree tree_source, <span class="keyword">int</span> *index_source, <span class="keyword">int</span> key, <span class="keyword">int</span> *index_success)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//不使用index来表示一个key，而是直接传入一个key值来自动寻找。这样即使树种存在两个相同的key也可以寻找到后继了。</span></span><br><span class="line">    <span class="keyword">if</span> (useindex == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        index_source = (<span class="keyword">int</span> *)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>));</span><br><span class="line">        tree_source = <span class="built_in">search</span>(tree, key, index_source);</span><br><span class="line">    &#125;</span><br><span class="line">    BTree successor = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (tree_source == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *index_success = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果是叶子中非最后一个，则返回其后面的一个数据</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((tree_source-&gt;isleaf == <span class="literal">true</span>) &amp;&amp; ((*index_source) &lt; tree_source-&gt;key_num - <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        *index_success = *index_source + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> tree_source;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//是叶子中的最后一个</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((tree_source-&gt;isleaf == <span class="literal">true</span>) &amp;&amp; ((*index_source) == tree_source-&gt;key_num - <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//递归向上遍历，直到找到一个结点不是其父节点的最后一个孩子</span></span><br><span class="line">        BTree t_up = tree_source;</span><br><span class="line">        <span class="keyword">while</span> (t_up)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> t_up_child_index = <span class="built_in">childindex</span>(t_up-&gt;parent, t_up);</span><br><span class="line">            <span class="keyword">if</span> (t_up_child_index == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//到达根节点,这里肯定是从最右边到达根节点了，所以返回空</span></span><br><span class="line">                *index_success = <span class="number">-1</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (t_up_child_index &lt; t_up-&gt;parent-&gt;key_num)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//找到一个不是其父节点最后一个孩子的结点，返回父节点 key[t_up_child_index]</span></span><br><span class="line">                *index_success = t_up_child_index;</span><br><span class="line">                <span class="keyword">return</span> t_up-&gt;parent;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (t_up_child_index == t_up-&gt;parent-&gt;key_num)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//仍然是其父节点的最后一个孩子，继续向上</span></span><br><span class="line">                t_up = t_up-&gt;parent;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//非叶子</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (tree_source-&gt;isleaf == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//不是叶子的话总会有后继的。即以其右侧孩子为根节点的最小值</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">minimum</span>(tree_source-&gt;child[*index_source + <span class="number">1</span>], index_success);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//判断是第几个孩子</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">childindex</span><span class="params">(BTree pa, BTree son)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((pa == <span class="literal">NULL</span>) || (son == <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= pa-&gt;key_num; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (pa-&gt;child[i] == son)</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">borrow_direction</span><span class="params">(BTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tree == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> borrow_direction = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> index_child = <span class="built_in">childindex</span>(tree-&gt;parent, tree);</span><br><span class="line">    <span class="keyword">if</span> (index_child == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//不可借</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> num_child = tree-&gt;parent-&gt;key_num + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index_child; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (tree-&gt;parent-&gt;child[i]-&gt;key_num &gt;= M + <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//向左借</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = index_child + <span class="number">1</span>; i &lt; num_child; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (tree-&gt;parent-&gt;child[i]-&gt;key_num &gt;= M + <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//向右借</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//将index_key左右两侧进行交换,返回交换过后的左侧结点剩余值</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">l_exchange</span><span class="params">(BTree tree, <span class="keyword">int</span> index_key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BTree left_bro = <span class="literal">NULL</span>;</span><br><span class="line">    BTree right_bro = <span class="literal">NULL</span>;</span><br><span class="line">    left_bro = tree-&gt;child[index_key];</span><br><span class="line">    right_bro = tree-&gt;child[index_key + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> pa_key = tree-&gt;key[index_key];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = right_bro-&gt;key_num; i &gt;= <span class="number">1</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        right_bro-&gt;key[i] = right_bro-&gt;key[i - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    right_bro-&gt;key[<span class="number">0</span>] = pa_key;</span><br><span class="line">    tree-&gt;key[index_key] = left_bro-&gt;key[left_bro-&gt;key_num - <span class="number">1</span>];</span><br><span class="line">    left_bro-&gt;key_num--;</span><br><span class="line">    <span class="keyword">return</span> left_bro-&gt;key_num;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//交换左侧</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">r_exchange</span><span class="params">(BTree tree, <span class="keyword">int</span> index_key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BTree left_bro = <span class="literal">NULL</span>;</span><br><span class="line">    BTree right_bro = <span class="literal">NULL</span>;</span><br><span class="line">    left_bro = tree-&gt;child[index_key];</span><br><span class="line">    right_bro = tree-&gt;child[index_key + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> pa_key = tree-&gt;key[index_key];</span><br><span class="line">    left_bro-&gt;key[left_bro-&gt;key_num++] = pa_key;</span><br><span class="line">    tree-&gt;key[index_key] = right_bro-&gt;key[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= right_bro-&gt;key_num - <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        right_bro-&gt;key[i] = right_bro-&gt;key[i + <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    right_bro-&gt;key_num--;</span><br><span class="line">    <span class="keyword">return</span> right_bro-&gt;key_num;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//合并一个结点及其孩子 用于节点只有一个key,所以只有两个孩子 这里的tree为父节点</span></span><br><span class="line"><span class="function">BTree <span class="title">merge_onekey</span><span class="params">(BTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BTree pa = tree;</span><br><span class="line">    BTree left_bro = tree-&gt;child[<span class="number">0</span>];</span><br><span class="line">    BTree right_bro = tree-&gt;child[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">//right_bro上位 重新插入pa和left</span></span><br><span class="line">    left_bro-&gt;parent = pa-&gt;parent;</span><br><span class="line">    <span class="keyword">if</span> (pa-&gt;parent)</span><br><span class="line">        pa-&gt;parent-&gt;child[<span class="built_in">childindex</span>(pa-&gt;parent, pa)] = right_bro;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        tree = right_bro;</span><br><span class="line">    <span class="comment">//插入</span></span><br><span class="line">    tree = <span class="built_in">insert</span>(tree, pa-&gt;key[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= left_bro-&gt;key_num - <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        tree = <span class="built_in">insert</span>(tree, left_bro-&gt;key[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//合并一个结点 这里的tree 是孩子结点</span></span><br><span class="line"><span class="function">BTree <span class="title">merge</span><span class="params">(BTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tree == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果不是最右边的那个孩子则和右兄弟合并</span></span><br><span class="line">    <span class="keyword">int</span> index_child = <span class="built_in">childindex</span>(tree-&gt;parent, tree);</span><br><span class="line">    <span class="keyword">int</span> pa_key_index = <span class="number">-1</span>;</span><br><span class="line">    BTree left_bro = <span class="literal">NULL</span>;</span><br><span class="line">    BTree right_bro = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//最右边的孩子，和左兄弟在一起</span></span><br><span class="line">    <span class="keyword">if</span> (index_child == tree-&gt;parent-&gt;key_num)</span><br><span class="line">    &#123;</span><br><span class="line">        left_bro = tree-&gt;parent-&gt;child[index_child - <span class="number">1</span>];</span><br><span class="line">        right_bro = tree;</span><br><span class="line">        pa_key_index = tree-&gt;parent-&gt;key_num - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//不是最右边的孩子，则和右兄弟在一起</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        right_bro = tree-&gt;parent-&gt;child[index_child + <span class="number">1</span>];</span><br><span class="line">        left_bro = tree;</span><br><span class="line">        pa_key_index = index_child;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> left_bro_key_num = left_bro-&gt;key_num;</span><br><span class="line">    left_bro-&gt;key[left_bro_key_num++] = tree-&gt;parent-&gt;key[pa_key_index];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= right_bro-&gt;key_num - <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        left_bro-&gt;key[left_bro_key_num++] = right_bro-&gt;key[i];</span><br><span class="line">    &#125;</span><br><span class="line">    left_bro-&gt;key_num = left_bro_key_num;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将父节点key进行整合和</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = pa_key_index; i &lt;= tree-&gt;parent-&gt;key_num - <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        tree-&gt;parent-&gt;key[i] = tree-&gt;parent-&gt;key[i + <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    tree-&gt;parent-&gt;key_num--;</span><br><span class="line">    <span class="comment">//child</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = pa_key_index + <span class="number">1</span>; i &lt;= tree-&gt;parent-&gt;key_num; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        tree-&gt;parent-&gt;child[i] = tree-&gt;parent-&gt;child[i + <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    tree-&gt;parent-&gt;child[tree-&gt;parent-&gt;key_num + <span class="number">1</span>] = <span class="literal">NULL</span>;</span><br><span class="line">    tree-&gt;parent-&gt;child_num = tree-&gt;parent-&gt;key_num + <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">free</span>(right_bro);</span><br><span class="line">    <span class="keyword">if</span> (left_bro-&gt;parent-&gt;key_num == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//说明 left_bro-&gt;parent 为根节点 此时根节点没有key了，只有一个child,所以此时返回 left_bro;</span></span><br><span class="line">        <span class="built_in">free</span>(left_bro-&gt;parent);</span><br><span class="line">        left_bro-&gt;parent = <span class="literal">NULL</span>;</span><br><span class="line">        left_bro-&gt;isleaf = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> left_bro;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回合并后的 parent 以为此时的parent可能key_num&lt;M</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> left_bro-&gt;parent;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//向父节点借孩子 返回能借到结点的最后一个结点</span></span><br><span class="line"><span class="comment">//判断合并到一起的节点数是否超标，若超标则说明可借，则借一个，否则合并到一起</span></span><br><span class="line"><span class="function">BTree <span class="title">borrow_from_parent</span><span class="params">(BTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tree == <span class="literal">NULL</span> || tree-&gt;parent == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> tree;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//直到父节点是根节点且只有一个key</span></span><br><span class="line">    <span class="keyword">if</span> (tree-&gt;parent-&gt;parent == <span class="literal">NULL</span> &amp;&amp; tree-&gt;parent-&gt;key_num == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> tree;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//借到了富有结点的，不用继续了</span></span><br><span class="line">    <span class="keyword">if</span> (tree-&gt;key_num &gt;= M)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> tree;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//是其最后一个孩子 跟左兄弟在一起</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">childindex</span>(tree-&gt;parent, tree) == tree-&gt;parent-&gt;key_num)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> index_child = <span class="built_in">childindex</span>(tree-&gt;parent, tree);</span><br><span class="line">        BTree left_bro = tree-&gt;parent-&gt;child[index_child - <span class="number">1</span>];</span><br><span class="line">        BTree right_bro = tree-&gt;parent-&gt;child[index_child];</span><br><span class="line">        <span class="keyword">int</span> key_num_totle = left_bro-&gt;key_num + right_bro-&gt;key_num + tree-&gt;parent-&gt;key_num;</span><br><span class="line">        <span class="keyword">if</span> (key_num_totle &lt;= <span class="number">2</span> * M)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//可以合并</span></span><br><span class="line">            <span class="built_in">merge_parent</span>(tree-&gt;parent, index_child - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">balance_two_child</span>(tree-&gt;parent, index_child - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">borrow_from_parent</span>(tree-&gt;parent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//不是最后一个孩子</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> index_child = <span class="built_in">childindex</span>(tree-&gt;parent, tree);</span><br><span class="line">        BTree left_bro = tree-&gt;parent-&gt;child[index_child];</span><br><span class="line">        BTree right_bro = tree-&gt;parent-&gt;child[index_child + <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">int</span> key_num_totle = left_bro-&gt;key_num + right_bro-&gt;key_num + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (key_num_totle &lt;= <span class="number">2</span> * M)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//可以合并</span></span><br><span class="line">            <span class="built_in">merge_parent</span>(tree-&gt;parent, index_child);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">balance_two_child</span>(tree-&gt;parent, index_child);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">borrow_from_parent</span>(tree-&gt;parent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">borrow_from_parent</span>(tree-&gt;parent);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//tree 为根节点，合并其与其孩子 事情能到这一步说明tree只有两个孩子了</span></span><br><span class="line"><span class="function">BTree <span class="title">merge_root</span><span class="params">(BTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BTree left_bro = tree-&gt;child[<span class="number">0</span>];</span><br><span class="line">    BTree right_bro = tree-&gt;child[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">//判断总共的key个数</span></span><br><span class="line">    <span class="keyword">int</span> key_num_totle = left_bro-&gt;key_num + right_bro-&gt;key_num + tree-&gt;key_num;</span><br><span class="line">    <span class="keyword">if</span> (key_num_totle &lt;= <span class="number">2</span> * M)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//可以合并到一起</span></span><br><span class="line">        <span class="keyword">int</span> left_bro_key_num = left_bro-&gt;key_num;</span><br><span class="line">        <span class="keyword">int</span> left_bro_child_num = left_bro_key_num + <span class="number">1</span>;</span><br><span class="line">        left_bro-&gt;key[left_bro_key_num++] = tree-&gt;key[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= right_bro-&gt;key_num - <span class="number">1</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            left_bro-&gt;key[left_bro_key_num++] = right_bro-&gt;key[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= right_bro-&gt;key_num; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            right_bro-&gt;child[i]-&gt;parent = left_bro;</span><br><span class="line">            left_bro-&gt;child[left_bro_child_num++] = right_bro-&gt;child[i];</span><br><span class="line">        &#125;</span><br><span class="line">        left_bro-&gt;key_num = left_bro_key_num;</span><br><span class="line">        <span class="built_in">free</span>(tree);</span><br><span class="line">        <span class="built_in">free</span>(right_bro);</span><br><span class="line">        left_bro-&gt;parent = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> left_bro;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//太多了合并不到一起</span></span><br><span class="line">        <span class="comment">//此时结点多的哪一个借一些结点给另一个</span></span><br><span class="line">        <span class="keyword">int</span> left_bro_key_num = left_bro-&gt;key_num;</span><br><span class="line">        <span class="keyword">int</span> right_bro_key_num = right_bro-&gt;key_num;</span><br><span class="line">        <span class="keyword">if</span> (left_bro_key_num &gt; right_bro_key_num)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//左侧KEY多</span></span><br><span class="line">            right_bro-&gt;key_num++;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = right_bro-&gt;key_num - <span class="number">1</span>; i &gt;= <span class="number">1</span>; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                right_bro-&gt;key[i] = right_bro-&gt;key[i - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            right_bro-&gt;key[<span class="number">0</span>] = tree-&gt;key[<span class="number">0</span>];</span><br><span class="line">            tree-&gt;key[<span class="number">0</span>] = left_bro-&gt;key[left_bro-&gt;key_num - <span class="number">1</span>];</span><br><span class="line">            left_bro-&gt;key_num--;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = right_bro-&gt;key_num; i &gt;= <span class="number">1</span>; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                right_bro-&gt;child[i] = right_bro-&gt;child[i - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            right_bro-&gt;child[<span class="number">0</span>] = left_bro-&gt;child[left_bro-&gt;key_num + <span class="number">1</span>];</span><br><span class="line">            right_bro-&gt;child[<span class="number">0</span>]-&gt;parent = right_bro;</span><br><span class="line">            left_bro-&gt;child[left_bro-&gt;key_num + <span class="number">1</span>] = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">return</span> tree;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//右侧key多 从右边向左边移动一个</span></span><br><span class="line">            left_bro-&gt;key[left_bro-&gt;key_num++] = tree-&gt;key[<span class="number">0</span>];</span><br><span class="line">            tree-&gt;key[<span class="number">0</span>] = right_bro-&gt;key[<span class="number">0</span>];</span><br><span class="line">            left_bro-&gt;child[left_bro-&gt;key_num] = right_bro-&gt;child[<span class="number">0</span>];</span><br><span class="line">            right_bro-&gt;child[<span class="number">0</span>]-&gt;parent = left_bro;</span><br><span class="line">            right_bro-&gt;key_num--;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= right_bro-&gt;key_num; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                right_bro-&gt;child[i] = right_bro-&gt;child[i + <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= right_bro-&gt;key_num - <span class="number">1</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                right_bro-&gt;key[i] = right_bro-&gt;key[i + <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            right_bro-&gt;child[right_bro-&gt;key_num + <span class="number">1</span>] = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">return</span> tree;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//协调两个孩子的节点数量 多的给少的一个，这其中当然也要通过parent-&gt;key进行交换</span></span><br><span class="line"><span class="function">BTree <span class="title">balance_two_child</span><span class="params">(BTree tree, <span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//index为父节点的keyindex,协调其左右两侧的孩子</span></span><br><span class="line">    BTree pa = tree;</span><br><span class="line">    BTree left_bro = pa-&gt;child[index];</span><br><span class="line">    BTree right_bro = pa-&gt;child[index + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> (left_bro-&gt;key_num &gt; M &amp;&amp; right_bro-&gt;key_num &lt; M)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//左侧KEY多</span></span><br><span class="line">        <span class="comment">//更新右节点的key</span></span><br><span class="line">        right_bro-&gt;key_num++;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = right_bro-&gt;key_num - <span class="number">1</span>; i &gt;= <span class="number">1</span>; i--)</span><br><span class="line">        &#123;</span><br><span class="line">            right_bro-&gt;key[i] = right_bro-&gt;key[i - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        right_bro-&gt;key[<span class="number">0</span>] = tree-&gt;key[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">//跟新父节点</span></span><br><span class="line">        tree-&gt;key[<span class="number">0</span>] = left_bro-&gt;key[left_bro-&gt;key_num - <span class="number">1</span>];</span><br><span class="line">        <span class="comment">//更新左节点的key_num</span></span><br><span class="line">        left_bro-&gt;key_num--;</span><br><span class="line">        <span class="comment">//更新右节点的child</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = right_bro-&gt;key_num; i &gt;= <span class="number">1</span>; i--)</span><br><span class="line">        &#123;</span><br><span class="line">            right_bro-&gt;child[i] = right_bro-&gt;child[i - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        right_bro-&gt;child[<span class="number">0</span>] = left_bro-&gt;child[left_bro-&gt;key_num + <span class="number">1</span>];</span><br><span class="line">        right_bro-&gt;child[<span class="number">0</span>]-&gt;parent = right_bro;</span><br><span class="line">        left_bro-&gt;child[left_bro-&gt;key_num + <span class="number">1</span>] = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> tree;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((right_bro-&gt;key_num &gt; M &amp;&amp; left_bro-&gt;key_num &lt; M))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//右孩子的key数量多，借给左孩子</span></span><br><span class="line">        <span class="comment">//父节点下移</span></span><br><span class="line">        left_bro-&gt;key[left_bro-&gt;key_num++] = tree-&gt;key[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">//更新父节点</span></span><br><span class="line">        tree-&gt;key[<span class="number">0</span>] = right_bro-&gt;key[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">//更新左节点的孩子</span></span><br><span class="line">        left_bro-&gt;child[left_bro-&gt;key_num] = right_bro-&gt;child[<span class="number">0</span>];</span><br><span class="line">        right_bro-&gt;child[<span class="number">0</span>]-&gt;parent = left_bro;</span><br><span class="line">        <span class="comment">//更新右节点</span></span><br><span class="line">        right_bro-&gt;key_num--;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= right_bro-&gt;key_num; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            right_bro-&gt;child[i] = right_bro-&gt;child[i + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= right_bro-&gt;key_num - <span class="number">1</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            right_bro-&gt;key[i] = right_bro-&gt;key[i + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        right_bro-&gt;child[right_bro-&gt;key_num + <span class="number">1</span>] = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> tree;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//合并tree index 两边的孩子 前提是合并之后不超</span></span><br><span class="line"><span class="function">BTree <span class="title">merge_parent</span><span class="params">(BTree tree, <span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//index为父节点的keyindex,合并其左右两侧的孩子</span></span><br><span class="line">    BTree pa = tree;</span><br><span class="line">    BTree left_bro = pa-&gt;child[index];</span><br><span class="line">    BTree right_bro = pa-&gt;child[index + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    left_bro-&gt;child_num = left_bro-&gt;key_num + <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//整合left</span></span><br><span class="line">    left_bro-&gt;key[left_bro-&gt;key_num++] = pa-&gt;key[index];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= right_bro-&gt;key_num - <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        left_bro-&gt;key[left_bro-&gt;key_num++] = right_bro-&gt;key[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= right_bro-&gt;key_num; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        left_bro-&gt;child[left_bro-&gt;child_num++] = right_bro-&gt;child[i];</span><br><span class="line">        right_bro-&gt;child[i]-&gt;parent = left_bro;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//整合pa</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = index; i &lt;= pa-&gt;key_num - <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        pa-&gt;key[i] = pa-&gt;key[i + <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = index + <span class="number">1</span>; i &lt;= pa-&gt;key_num - <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        pa-&gt;child[i] = pa-&gt;child[i + <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    pa-&gt;child[pa-&gt;key_num--] = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 销毁b树</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">(BTree tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> M 128</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;BTree.c&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//一亿条数据</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ITEM_NUM 1000000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//阶数增大但又不太大 则查询时间增大，其余时间减少</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;效率test 当前阶数为 %d \n&quot;</span>, M);</span><br><span class="line">    <span class="keyword">time_t</span> start, end, t1, t2;</span><br><span class="line"></span><br><span class="line">    start = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    BTree tree = <span class="built_in">BTree_Init</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= ITEM_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        tree = <span class="built_in">insert</span>(tree, i);</span><br><span class="line">    &#125;</span><br><span class="line">    end = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;插入 %d%% 个数用时 %d s\n&quot;</span>, ITEM_NUM, end - start);</span><br><span class="line"></span><br><span class="line">    start = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">preorder</span>(tree);</span><br><span class="line">    <span class="built_in">inorder</span>(tree);</span><br><span class="line">    <span class="built_in">postorder</span>(tree);</span><br><span class="line">    end = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;遍历 %d 个数用时 %d s\n&quot;</span>, ITEM_NUM, end - start);</span><br><span class="line"></span><br><span class="line">    start = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= ITEM_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> index = <span class="number">-1</span>;</span><br><span class="line">        BTree result = <span class="built_in">search</span>(tree, i, &amp;index); <span class="comment">//4782968</span></span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\nsearch: %d index: %d\n&quot;</span>, result-&gt;key[index], index);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n未找到 %d \n&quot;</span>);</span><br><span class="line">            <span class="comment">//exit(EXIT_FAILURE);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    end = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;递归查询 %d 个数用时 %d s\n&quot;</span>, ITEM_NUM, end - start);</span><br><span class="line"></span><br><span class="line">    start = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= ITEM_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> index = <span class="number">-1</span>;</span><br><span class="line">        BTree result = <span class="built_in">search_iterative</span>(tree, i, &amp;index); <span class="comment">//4782968</span></span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//printf(&quot;\nsearch: %d index: %d\n&quot;, result-&gt;key[index],index);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n未找到 %d \n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    end = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;非递归查询 %d 个数用时 %d s\n&quot;</span>, ITEM_NUM, end - start);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;delete test\n&quot;</span>);</span><br><span class="line">    start = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    t1 = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= ITEM_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        t2 = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (t2 - t1 == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;已删除 %f \n&quot;</span>, i * <span class="number">1.0</span> / ITEM_NUM * <span class="number">100.0</span>);</span><br><span class="line">            t1 = t2;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        tree = <span class="built_in">delete_btree</span>(tree, <span class="literal">false</span>, <span class="literal">NULL</span>, <span class="number">-1</span>, i);</span><br><span class="line">        <span class="keyword">int</span> index = <span class="number">-1</span>;</span><br><span class="line">        BTree result = <span class="built_in">search</span>(tree, i, &amp;index); <span class="comment">//4782968</span></span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n 删除失败-----------search: %d index: %d\n&quot;</span>, result-&gt;key[index], index);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//inorder(tree);</span></span><br><span class="line">            <span class="comment">//printf(&quot;\n&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    end = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;删除 %d 个数用时 %d s\n&quot;</span>, ITEM_NUM, end - start);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;delete test finish\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://myblog.cuimouren.cn/2021/07/20/CDB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="崔文耀">
      <meta itemprop="description" content="Hello, here is wenyao's space, how do you come in???">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="这里是文耀的space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="../../2021/07/20/CDB/" class="post-title-link" itemprop="url">CDB</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-20 09:53:11" itemprop="dateCreated datePublished" datetime="2021-07-20T09:53:11+08:00">2021-07-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-31 20:47:25" itemprop="dateModified" datetime="2021-08-31T20:47:25+08:00">2021-08-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/project/" itemprop="url" rel="index"><span itemprop="name">project</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/project/CDB/" itemprop="url" rel="index"><span itemprop="name">CDB</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CDB"><a href="#CDB" class="headerlink" title="CDB"></a>CDB</h1><p>我想学习数据结构，最好的方式就是使用数据结构的知识做出一个系统，而我认为对于目前的我来讲，最好的选择就是做一个小型的数据库引擎。取名为<strong>CDB</strong></p>
<p>学习GitHub上的<a target="_blank" rel="noopener" href="https://cstack.github.io/db_tutorial/">这个</a>项目。</p>
<h2 id="必要技术准备"><a href="#必要技术准备" class="headerlink" title="必要技术准备"></a>必要技术准备</h2><ol>
<li>windows下文件的交互。参考<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/cpp/c-runtime-library/run-time-routines-by-category?view=msvc-160">CRT</a>,微软的这个官方文档真好。</li>
<li>测试技术，这个在json教程中已经学习过。</li>
<li>层次架构，学会对一个项目使用层次架构进行开发。</li>
<li>命令处理，或者说是解析器，即解析命令。</li>
<li>数据库底层数据结构的实现，这里采用B树。</li>
<li>c语言底层内存管理。</li>
<li>对操作系统底层的了解，比如数据库利用操作系统的分页概念进行优化。</li>
</ol>
<h2 id="第一步-数据库的交互框架"><a href="#第一步-数据库的交互框架" class="headerlink" title="第一步 数据库的交互框架"></a>第一步 数据库的交互框架</h2><p>数据库工作的流程为：<br>    1. 打印提示符接受输入<br>    2. 解析输入，得到真实的命令<br>    3. 将解析得到的语义进行数据库底层操作<br>    4. 数据库底层操作很复杂，现在还不懂，懂了再加上</p>
<p>所以首先我们需要解析每一次的输入，并解析为程序可以读懂的信息，根据解析结果进行进一步操作。</p>
<p>所以我们需要一个缓冲区来存储输入。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span>* buffer;</span><br><span class="line">    <span class="keyword">size_t</span> buffer_length;</span><br><span class="line">    <span class="keyword">size_t</span> input_length;</span><br><span class="line">&#125;InputBuffer;</span><br></pre></td></tr></table></figure>

<p>在得到每一次的输入之后还首先需要进行<strong>元命令判断</strong>其结果使用enum进行选择。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    META_COMMAND_EXIT,</span><br><span class="line">    META_COMMAND_SUCCESS,</span><br><span class="line">    META_COMMAND_UNRECOGNIZED_COMMAND</span><br><span class="line">&#125;MetaCommandResult;</span><br></pre></td></tr></table></figure>

<p>元命令目前分为两类，以类是以 <strong>.</strong> 开头的非SQL命令，另一类位SQL命令。</p>
<p>进行元命令判断之后进行处理，目前只有退出一项。</p>
<p>与元命令并行的是SQL命令的处理，其不以 <strong>.</strong> 开头。同理，这种命令的处理也存在几种状态。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	PREPARE_SUCCESS,</span><br><span class="line">	PREPARE_SYNTAX_ERROR,</span><br><span class="line">	PREPARE_UNRECOGNIZED_STATEMENT</span><br><span class="line">&#125; PrepareResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">	STATEMENT_INSERT,</span><br><span class="line">	STATEMENT_SELECT</span><br><span class="line">&#125; StatementType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	StatementType type;</span><br><span class="line">	Row row_to_insert;</span><br><span class="line">&#125; Statement;</span><br></pre></td></tr></table></figure>

<p>程序预处理SQL命令得到这样的状态，根据状态来执行真正的SQL命令。</p>
<p>以上就是数据库的交互框架，就是一个巨大的状态机，虽然我不是很喜欢状态机，可是目前能力不足，只能使用状态机来实现了。希望以后做一个不使用状态机的大项目。</p>
<p>这一步的程序被覆盖掉了。</p>
<h2 id="第二步-数据库的简单插入操作"><a href="#第二步-数据库的简单插入操作" class="headerlink" title="第二步 数据库的简单插入操作"></a>第二步 数据库的简单插入操作</h2><p>这一步要实现数据库与底层的互连，打通和底层内存间的交互。实现简单的insert和使用select打印出数据表。这里全部使用硬编码。</p>
<p>下面讲一下数据库的底层安排。</p>
<p>table使用一个简单的示例：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ROW</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> id;</span><br><span class="line">	<span class="keyword">char</span> username[COLUMN_USERNAME_SIZE];</span><br><span class="line">	<span class="keyword">char</span> email[COLUMN_EMAIL_SIZE];</span><br><span class="line">&#125; Row;</span><br><span class="line"><span class="comment">//Table</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> num_rows;</span><br><span class="line">	<span class="keyword">void</span>* pages[TABLE_MAX_PAGES];</span><br><span class="line">&#125; Table;</span><br></pre></td></tr></table></figure>

<p>将一张表分为数个page，这里的page和操作系统提供的分页机制相吻合，都是4KB大小，这样可以从操作系统层面上提高数据库的效率。在预处理中已经将命令的参数存入一行中了。（statement-&gt;row),现在需要获得数据要存入的内存地址和存入该内存地址的方法。</p>
<p>分配内存：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Row* <span class="title">row_slot</span><span class="params">(Table* table, <span class="keyword">uint32_t</span> row_num)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> page_num = row_num / ROWS_PER_PAGE;</span><br><span class="line">	<span class="keyword">void</span>* page = table-&gt;pages[page_num];</span><br><span class="line">	<span class="keyword">if</span> (page == <span class="literal">NULL</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Allocate memory only when we try to access page</span></span><br><span class="line">		page = table-&gt;pages[page_num] = <span class="built_in">malloc</span>(PAGE_SIZE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">uint32_t</span> row_offset = row_num % ROWS_PER_PAGE;</span><br><span class="line">	<span class="keyword">uint32_t</span> byte_offset = row_offset * ROW_SIZE;</span><br><span class="line">	<span class="comment">//之所以报 “必须是指向完整类型”的错，是因为指针指向类型不确定，则其单位不确定，加上byte_offset后也不知道到底指向哪一块内存。</span></span><br><span class="line">	<span class="comment">//由于 byte_offset 是字节单位，所以page页要变为指向8位内存的指针。所以转化位 uint8_t</span></span><br><span class="line">	<span class="keyword">return</span> (Row*)((<span class="keyword">uint8_t</span>*)page + byte_offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数返回一个指向要插入的内存地址的指针。</p>
<p>插入内存：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将行的信息存储到内存中</span></span><br><span class="line"><span class="comment">//A void pointer can hold address of any type and can be typcasted to any type</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serialize_row</span><span class="params">(Row* source, Row* destination)</span> </span></span><br><span class="line"><span class="function"></span>&#123;	</span><br><span class="line">	<span class="comment">// ID_SIZE 指的是字节数</span></span><br><span class="line">	<span class="built_in">memcpy</span>((<span class="keyword">uint8_t</span>*)destination + ID_OFFSET, &amp;(source-&gt;id), ID_SIZE);</span><br><span class="line">	<span class="built_in">memcpy</span>((<span class="keyword">uint8_t</span>*)destination + USERNAME_OFFSET, &amp;(source-&gt;username), USERNAME_SIZE);</span><br><span class="line">	<span class="built_in">memcpy</span>((<span class="keyword">uint8_t</span>*)destination + EMAIL_OFFSET, &amp;(source-&gt;email), EMAIL_SIZE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里将destination从<strong>row*</strong> 转换为 **(uint8_t*)**来将其单位转化为字节，这样下面加上各个属性的offset之后就正确地指向对应地内存位置了。第三个参数代表赋值地字节数。这里终于意识到c语言指针地强大之处了。</p>
<p>同理该有一个相反地函数用于输出数据:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deserialize_row</span><span class="params">(Row* source, Row* destination)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">memcpy</span>(&amp;(destination-&gt;id), (<span class="keyword">uint8_t</span>*)source + ID_OFFSET, ID_SIZE);</span><br><span class="line">	<span class="built_in">memcpy</span>(&amp;(destination-&gt;username), (<span class="keyword">uint8_t</span>*)source + USERNAME_OFFSET, USERNAME_SIZE);</span><br><span class="line">	<span class="built_in">memcpy</span>(&amp;(destination-&gt;email), (<span class="keyword">uint8_t</span>*)source + EMAIL_OFFSET, EMAIL_SIZE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样与内存的底层交互就完成了，现在只需要得到offset即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COLUMN_USERNAME_SIZE 32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COLUMN_EMAIL_SIZE 255</span></span><br><span class="line"><span class="comment">//表中最大页数</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TABLE_MAX_PAGES 100</span></span><br><span class="line"><span class="comment">//页的大小</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 4096</span></span><br><span class="line"><span class="comment">//定义宏获取size</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> size_of_attribute(Struct, Attribute) sizeof(((Struct*)0)-&gt;Attribute)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取行中每一个元素的size和offset</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> ID_SIZE = <span class="built_in">size_of_attribute</span>(Row, id);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> USERNAME_SIZE = <span class="built_in">size_of_attribute</span>(Row, username);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> EMAIL_SIZE = <span class="built_in">size_of_attribute</span>(Row, email);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> ID_OFFSET = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> USERNAME_OFFSET = <span class="number">0</span> + <span class="built_in">size_of_attribute</span>(Row, id);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> EMAIL_OFFSET = <span class="number">0</span> + <span class="built_in">size_of_attribute</span>(Row, id) + <span class="built_in">size_of_attribute</span>(Row, username);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> ROW_SIZE = <span class="built_in">size_of_attribute</span>(Row, id) + <span class="built_in">size_of_attribute</span>(Row, username) + <span class="built_in">size_of_attribute</span>(Row, email);</span><br><span class="line"><span class="comment">//每一页有多少行</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> ROWS_PER_PAGE = PAGE_SIZE /(<span class="built_in">size_of_attribute</span>(Row, id) + <span class="built_in">size_of_attribute</span>(Row, username) + <span class="built_in">size_of_attribute</span>(Row, email));</span><br><span class="line"><span class="comment">//一张表里面最大行数</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> TABLE_MAX_ROWS = PAGE_SIZE / (<span class="built_in">size_of_attribute</span>(Row, id) + <span class="built_in">size_of_attribute</span>(Row, username) + <span class="built_in">size_of_attribute</span>(Row, email)) * TABLE_MAX_PAGES;</span><br></pre></td></tr></table></figure>

<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><h4 id="CDB-h"><a href="#CDB-h" class="headerlink" title="CDB.h"></a>CDB.h</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COLUMN_USERNAME_SIZE 32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COLUMN_EMAIL_SIZE 255</span></span><br><span class="line"><span class="comment">//表中最大页数</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TABLE_MAX_PAGES 100</span></span><br><span class="line"><span class="comment">//页的大小</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 4096</span></span><br><span class="line"><span class="comment">//定义宏获取size</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> size_of_attribute(Struct, Attribute) sizeof(((Struct*)0)-&gt;Attribute)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//输入缓冲</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">char</span>* buffer;</span><br><span class="line">	<span class="comment">// _int64</span></span><br><span class="line">	<span class="keyword">size_t</span> buffer_length;</span><br><span class="line">	<span class="keyword">size_t</span> input_length;</span><br><span class="line">&#125; InputBuffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断输入得到的命令状态</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	META_COMMAND_EXIT,</span><br><span class="line">	META_COMMAND_SUCCESS,</span><br><span class="line">	META_COMMAND_UNRECOGNIZED_COMMAND</span><br><span class="line">&#125; MetaCommandResult;</span><br><span class="line"></span><br><span class="line"><span class="comment">//预处理得到的状态</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	PREPARE_SUCCESS,</span><br><span class="line">	PREPARE_NEGATIVE_ID,</span><br><span class="line">	PREPARE_SYNTAX_ERROR,</span><br><span class="line">	PREPARE_STRING_TOO_LONG,</span><br><span class="line">	PREPARE_TOO_MANY_PARAMETER,</span><br><span class="line">	PREPARE_UNRECOGNIZED_STATEMENT</span><br><span class="line">&#125; PrepareResult;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理后的状态</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	EXECUTE_SUCCESS,</span><br><span class="line">	EXECUTE_TABLE_FULL</span><br><span class="line">&#125;ExecuteResult;</span><br><span class="line"></span><br><span class="line"><span class="comment">//得到的输入的表达式的状态</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	STATEMENT_INSERT,</span><br><span class="line">	STATEMENT_SELECT</span><br><span class="line">&#125; StatementType;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义 一行 </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> id;</span><br><span class="line">	<span class="comment">//加一是因为c语言需要最后一个字符为0，所以可用字符就减一了。</span></span><br><span class="line">	<span class="comment">//不过即使这样也还需要在输入的时候判断是否大小超界</span></span><br><span class="line">	<span class="keyword">char</span> username[COLUMN_USERNAME_SIZE + <span class="number">1</span>];</span><br><span class="line">	<span class="keyword">char</span> email[COLUMN_EMAIL_SIZE + <span class="number">1</span>];</span><br><span class="line">&#125; Row;</span><br><span class="line"></span><br><span class="line"><span class="comment">//statement</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	StatementType type;</span><br><span class="line">	Row row_to_insert;</span><br><span class="line">&#125; Statement;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取行中每一个元素的size和offset</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> ID_SIZE = <span class="built_in">size_of_attribute</span>(Row, id);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> USERNAME_SIZE = <span class="built_in">size_of_attribute</span>(Row, username);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> EMAIL_SIZE = <span class="built_in">size_of_attribute</span>(Row, email);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> ID_OFFSET = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> USERNAME_OFFSET = <span class="number">0</span> + <span class="built_in">size_of_attribute</span>(Row, id);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> EMAIL_OFFSET = <span class="number">0</span> + <span class="built_in">size_of_attribute</span>(Row, id) + <span class="built_in">size_of_attribute</span>(Row, username);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> ROW_SIZE = <span class="built_in">size_of_attribute</span>(Row, id) + <span class="built_in">size_of_attribute</span>(Row, username) + <span class="built_in">size_of_attribute</span>(Row, email);</span><br><span class="line"><span class="comment">//每一页有多少行</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> ROWS_PER_PAGE = PAGE_SIZE / (<span class="built_in">size_of_attribute</span>(Row, id) + <span class="built_in">size_of_attribute</span>(Row, username) + <span class="built_in">size_of_attribute</span>(Row, email));</span><br><span class="line"><span class="comment">//一张表里面最大行数</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> TABLE_MAX_ROWS = PAGE_SIZE / (<span class="built_in">size_of_attribute</span>(Row, id) + <span class="built_in">size_of_attribute</span>(Row, username) + <span class="built_in">size_of_attribute</span>(Row, email)) * TABLE_MAX_PAGES;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一张表</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> num_rows;</span><br><span class="line">	<span class="keyword">void</span>* pages[TABLE_MAX_PAGES];</span><br><span class="line">&#125; Table;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化一个input_buffer</span></span><br><span class="line"><span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//打印命令提示符</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_prompt</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 获取一行的输入，以换行符为终结</span></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">getline</span><span class="params">(<span class="keyword">char</span>** buffer, <span class="keyword">size_t</span>* n)</span></span>;</span><br><span class="line"><span class="comment">//读取输入</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_input</span><span class="params">(InputBuffer* input_buffer)</span></span>;</span><br><span class="line"><span class="comment">//关闭输入</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span></span>;</span><br><span class="line"><span class="comment">// 判断是何种命令</span></span><br><span class="line"><span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer)</span></span>;</span><br><span class="line"><span class="comment">//预处理结果</span></span><br><span class="line"><span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer, Statement* statement)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_trim</span><span class="params">(InputBuffer* input_buffer)</span></span>;</span><br><span class="line"><span class="function">PrepareResult <span class="title">prepare_insert</span><span class="params">(InputBuffer* input_buffer, Statement* statement)</span></span>;</span><br><span class="line"><span class="comment">//执行命令 根据 statement 来执行相应的命令</span></span><br><span class="line"><span class="function">ExecuteResult <span class="title">execute_statement</span><span class="params">(Statement* statement, Table* table)</span></span>;</span><br><span class="line"><span class="function">ExecuteResult <span class="title">execute_insert</span><span class="params">(Statement* statement, Table* table)</span></span>;</span><br><span class="line"><span class="function">ExecuteResult <span class="title">execute_select</span><span class="params">(Statement* statement, Table* table)</span></span>;</span><br><span class="line"><span class="comment">//将行的信息存储到内存中</span></span><br><span class="line"><span class="comment">//A void pointer can hold address of any type and can be typcasted to any type</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serialize_row</span><span class="params">(Row* source, Row* destination)</span></span>;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deserialize_row</span><span class="params">(Row* source, Row* destination)</span></span>;</span><br><span class="line"><span class="comment">//插入前判断插入的内存位置 以及适时分配内存 </span></span><br><span class="line"><span class="function">Row* <span class="title">row_slot</span><span class="params">(Table* table, <span class="keyword">uint32_t</span> row_num)</span></span>;</span><br><span class="line"><span class="function">Table* <span class="title">new_table</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_table</span><span class="params">(Table* table)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_row</span><span class="params">(Row* row)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="CDB-c"><a href="#CDB-c" class="headerlink" title="CDB.c"></a>CDB.c</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="comment">//在最前面加上这个宏</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CDB.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	InputBuffer* input_buffer = (InputBuffer*)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(InputBuffer));</span><br><span class="line">	<span class="keyword">if</span> (input_buffer)</span><br><span class="line">	&#123;</span><br><span class="line">		input_buffer-&gt;buffer = <span class="literal">NULL</span>;</span><br><span class="line">		input_buffer-&gt;buffer_length = <span class="number">0</span>;</span><br><span class="line">		input_buffer-&gt;input_length = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span> input_buffer;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_prompt</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;CDB &gt;&gt; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取一行的输入，以换行符为终结</span></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">getline</span><span class="params">(<span class="keyword">char</span>** buffer, <span class="keyword">size_t</span>* n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> c = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">size_t</span> bytes_read = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//一行最多不超过80个字符</span></span><br><span class="line">	<span class="keyword">uint32_t</span> COLUMN_MAX_SIZE = COLUMN_USERNAME_SIZE + COLUMN_EMAIL_SIZE + <span class="number">100</span>;</span><br><span class="line">	<span class="keyword">char</span>* buffer_temp = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(COLUMN_MAX_SIZE * <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">char</span>));</span><br><span class="line">	<span class="keyword">if</span> (buffer_temp == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span> ((c = <span class="built_in">getchar</span>()) &amp;&amp; c != <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		*(buffer_temp + bytes_read++) = c;</span><br><span class="line">		<span class="keyword">if</span> (bytes_read == COLUMN_MAX_SIZE)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;too long\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	*buffer = buffer_temp;</span><br><span class="line">	<span class="keyword">return</span> bytes_read;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_input</span><span class="params">(InputBuffer* input_buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// void 对于所有类型都非法 </span></span><br><span class="line">	<span class="comment">// 返回读取得到的字节数量</span></span><br><span class="line">	<span class="keyword">size_t</span> bytes_read = <span class="built_in">getline</span>(&amp;(input_buffer-&gt;buffer), &amp;(input_buffer-&gt;buffer_length));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//printf(&quot;这次读取到的字节数量为 %llu\n&quot;, bytes_read);</span></span><br><span class="line">	<span class="keyword">if</span> (bytes_read &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Error reading input\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Ignore trailing newline    </span></span><br><span class="line">	input_buffer-&gt;input_length = bytes_read;</span><br><span class="line">	input_buffer-&gt;buffer[bytes_read] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//关闭输入</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">free</span>(input_buffer-&gt;buffer);</span><br><span class="line">	<span class="built_in">free</span>(input_buffer);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;关闭输入\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是何种命令</span></span><br><span class="line"><span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//退出</span></span><br><span class="line">		<span class="keyword">return</span> META_COMMAND_EXIT;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.q&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//退出</span></span><br><span class="line">		<span class="keyword">return</span> META_COMMAND_EXIT;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.v&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//显示当前版本</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CDB version 0.1\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> META_COMMAND_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//不可解析</span></span><br><span class="line">		<span class="keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//预处理，就是前缀命令识别</span></span><br><span class="line"><span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer, Statement* statement)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">prepare_trim</span>(input_buffer);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;insert&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">prepare_insert</span>(input_buffer, statement);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;select&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		statement-&gt;type = STATEMENT_SELECT;</span><br><span class="line">		<span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> PREPARE_UNRECOGNIZED_STATEMENT;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//预处理的预处理 去掉多余的空格</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_trim</span><span class="params">(InputBuffer* input_buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span>* temp = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(input_buffer-&gt;buffer) * <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">char</span>));</span><br><span class="line">	<span class="keyword">char</span>* p1 = temp;</span><br><span class="line">	<span class="keyword">char</span>* p2 = input_buffer-&gt;buffer;</span><br><span class="line">	<span class="comment">//首先去掉前面的空格</span></span><br><span class="line">	<span class="keyword">while</span> ((*p2) == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		p2++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//现在p2指向真正的命令起始</span></span><br><span class="line">	<span class="comment">//去掉文本中间多余的空格</span></span><br><span class="line">	<span class="keyword">bool</span> flag = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">while</span> ((*p2) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (((*p2) == <span class="string">&#x27; &#x27;</span>) &amp;&amp; (flag == <span class="literal">true</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			*p1 = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">			p1++;</span><br><span class="line">			p2++;</span><br><span class="line">			flag = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((*p2) != <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			*p1 = *p2;</span><br><span class="line">			p1++;</span><br><span class="line">			p2++;</span><br><span class="line">			flag = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			p2++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//此时 p1 指向最后，需要变为0</span></span><br><span class="line">	*p1 = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">free</span>(input_buffer-&gt;buffer);</span><br><span class="line">	input_buffer-&gt;buffer = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">PrepareResult <span class="title">prepare_insert</span><span class="params">(InputBuffer* input_buffer, Statement* statement)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">	<span class="comment">//这里应该可以去掉开头的空格，目前还不可以</span></span><br><span class="line">	<span class="keyword">char</span>* keyword = <span class="built_in">strtok</span>(input_buffer-&gt;buffer, <span class="string">&quot; &quot;</span>);</span><br><span class="line">	<span class="keyword">char</span>* id_string = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">	<span class="keyword">char</span>* username = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">	<span class="keyword">char</span>* email = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">	<span class="keyword">char</span>* test_parameter = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (id_string == <span class="literal">NULL</span> || username == <span class="literal">NULL</span> || email == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> PREPARE_SYNTAX_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (test_parameter != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> PREPARE_TOO_MANY_PARAMETER;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> id = <span class="built_in">atoi</span>(id_string);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strlen</span>(username) &gt; COLUMN_USERNAME_SIZE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> PREPARE_STRING_TOO_LONG;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strlen</span>(email) &gt; COLUMN_EMAIL_SIZE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> PREPARE_STRING_TOO_LONG;</span><br><span class="line">	&#125;</span><br><span class="line">	statement-&gt;row_to_insert.id = id;</span><br><span class="line">	<span class="built_in">strcpy</span>(statement-&gt;row_to_insert.username, username);</span><br><span class="line">	<span class="built_in">strcpy</span>(statement-&gt;row_to_insert.email, email);</span><br><span class="line">	<span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行命令</span></span><br><span class="line"><span class="function">ExecuteResult <span class="title">execute_statement</span><span class="params">(Statement* statement, Table* table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in"><span class="keyword">switch</span></span> (statement-&gt;type)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="built_in"><span class="keyword">case</span></span> (STATEMENT_INSERT):</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">execute_insert</span>(statement, table);</span><br><span class="line">	<span class="built_in"><span class="keyword">case</span></span> (STATEMENT_SELECT):</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">execute_select</span>(statement, table);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">ExecuteResult <span class="title">execute_insert</span><span class="params">(Statement* statement, Table* table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (table-&gt;num_rows &gt;= TABLE_MAX_ROWS)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> EXECUTE_TABLE_FULL;</span><br><span class="line">	&#125;</span><br><span class="line">	Row* row_to_insert = &amp;(statement-&gt;row_to_insert);</span><br><span class="line">	<span class="comment">//将一行存入内存</span></span><br><span class="line">	<span class="built_in">serialize_row</span>(row_to_insert, <span class="built_in">row_slot</span>(table, table-&gt;num_rows));</span><br><span class="line">	table-&gt;num_rows += <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> EXECUTE_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">ExecuteResult <span class="title">execute_select</span><span class="params">(Statement* statement, Table* table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Row row;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; table-&gt;num_rows; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//解析出一行</span></span><br><span class="line">		<span class="built_in">deserialize_row</span>(<span class="built_in">row_slot</span>(table, i), &amp;row);</span><br><span class="line">		<span class="built_in">print_row</span>(&amp;row);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> EXECUTE_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//将行的信息存储到内存中</span></span><br><span class="line"><span class="comment">//A void pointer can hold address of any type and can be typcasted to any type</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serialize_row</span><span class="params">(Row* source, Row* destination)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// ID_SIZE 指的是字节数</span></span><br><span class="line">	<span class="built_in">memcpy</span>((<span class="keyword">uint8_t</span>*)destination + ID_OFFSET, &amp;(source-&gt;id), ID_SIZE);</span><br><span class="line">	<span class="built_in">memcpy</span>((<span class="keyword">uint8_t</span>*)destination + USERNAME_OFFSET, &amp;(source-&gt;username), USERNAME_SIZE);</span><br><span class="line">	<span class="built_in">memcpy</span>((<span class="keyword">uint8_t</span>*)destination + EMAIL_OFFSET, &amp;(source-&gt;email), EMAIL_SIZE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deserialize_row</span><span class="params">(Row* source, Row* destination)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">memcpy</span>(&amp;(destination-&gt;id), (<span class="keyword">uint8_t</span>*)source + ID_OFFSET, ID_SIZE);</span><br><span class="line">	<span class="built_in">memcpy</span>(&amp;(destination-&gt;username), (<span class="keyword">uint8_t</span>*)source + USERNAME_OFFSET, USERNAME_SIZE);</span><br><span class="line">	<span class="built_in">memcpy</span>(&amp;(destination-&gt;email), (<span class="keyword">uint8_t</span>*)source + EMAIL_OFFSET, EMAIL_SIZE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//插入前判断插入的内存位置 以及适时分配内存 </span></span><br><span class="line"><span class="function">Row* <span class="title">row_slot</span><span class="params">(Table* table, <span class="keyword">uint32_t</span> row_num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> page_num = row_num / ROWS_PER_PAGE;</span><br><span class="line">	<span class="keyword">void</span>* page = table-&gt;pages[page_num];</span><br><span class="line">	<span class="keyword">if</span> (page == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Allocate memory only when we try to access page</span></span><br><span class="line">		page = table-&gt;pages[page_num] = <span class="built_in">malloc</span>(PAGE_SIZE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">uint32_t</span> row_offset = row_num % ROWS_PER_PAGE;</span><br><span class="line">	<span class="keyword">uint32_t</span> byte_offset = row_offset * ROW_SIZE;</span><br><span class="line">	<span class="comment">//之所以报 “必须是指向完整类型”的错，是因为指针指向类型不确定，则其单位不确定，加上byte_offset后也不知道到底指向哪一块内存。</span></span><br><span class="line">	<span class="comment">//由于 byte_offset 是字节单位，所以page页要变为指向8位内存的指针。所以转化位 uint8_t</span></span><br><span class="line">	<span class="keyword">return</span> (Row*)((<span class="keyword">uint8_t</span>*)page + byte_offset);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Table* <span class="title">new_table</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Table* table = (Table*)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(Table));</span><br><span class="line">	table-&gt;num_rows = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; TABLE_MAX_PAGES; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		table-&gt;pages[i] = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> table;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_table</span><span class="params">(Table* table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; table-&gt;pages[i]; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">free</span>(table-&gt;pages[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">free</span>(table);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_row</span><span class="params">(Row* row)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;| id: %u username: %s email: %s |\n&quot;</span>, row-&gt;id, row-&gt;username, row-&gt;email);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CDB.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Table* table = <span class="built_in">new_table</span>();</span><br><span class="line">	InputBuffer* input_buffer = <span class="built_in">new_input_buffer</span>();</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">print_prompt</span>();</span><br><span class="line">		<span class="built_in">read_input</span>(input_buffer);</span><br><span class="line">		<span class="comment">//判断是否有输入，若是回车直接 continue</span></span><br><span class="line">		<span class="keyword">if</span> (input_buffer-&gt;input_length == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//以 . 开头则为非 sql 命令</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (input_buffer-&gt;buffer[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in"><span class="keyword">switch</span></span> (<span class="built_in">do_meta_command</span>(input_buffer))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//退出</span></span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (META_COMMAND_EXIT):</span><br><span class="line">				<span class="comment">//printf(&quot;META_COMMAND_EXIT&quot;);</span></span><br><span class="line">				<span class="built_in">close_input_buffer</span>(input_buffer);</span><br><span class="line">				<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">				<span class="comment">//此命令可以解析</span></span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (META_COMMAND_SUCCESS):</span><br><span class="line">				<span class="comment">//printf(&quot;META_COMMAND_SUCCESS&quot;);</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">				<span class="comment">//命令不可解析</span></span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (META_COMMAND_UNRECOGNIZED_COMMAND):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Unrecognized command &#x27;%s&#x27;\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//sql命令</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (input_buffer-&gt;buffer[<span class="number">0</span>] != <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//进行预处理  即判断 insert create 等命令</span></span><br><span class="line">			Statement statement;</span><br><span class="line">			<span class="built_in"><span class="keyword">switch</span></span> (<span class="built_in">prepare_statement</span>(input_buffer, &amp;statement))</span><br><span class="line">			&#123;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (PREPARE_SUCCESS):</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (PREPARE_STRING_TOO_LONG):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;String is too long.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span>(PREPARE_NEGATIVE_ID):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;your id id negative.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span>(PREPARE_TOO_MANY_PARAMETER):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;too many parameter.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (PREPARE_UNRECOGNIZED_STATEMENT):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Unrecognized keyword at start of &#x27;%s&#x27;.\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">				<span class="comment">//break 会break switch本身， 而continue 会continue 上一层，而忽略掉 switch</span></span><br><span class="line">				<span class="comment">//这里直接continue 到while(true)</span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span>(PREPARE_SYNTAX_ERROR):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Syntax error. Could not parse statement.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in"><span class="keyword">switch</span></span> (<span class="built_in">execute_statement</span>(&amp;statement, table))</span><br><span class="line">			&#123;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (EXECUTE_SUCCESS):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Executed.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (EXECUTE_TABLE_FULL):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Error: Table full.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;error\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第三步-保存到硬盘"><a href="#第三步-保存到硬盘" class="headerlink" title="第三步 保存到硬盘"></a>第三步 保存到硬盘</h2><p>这一步，我们要将内存中的数据库存入磁盘中。</p>
<h3 id="数据定义"><a href="#数据定义" class="headerlink" title="数据定义"></a>数据定义</h3><p>首先从程序入口处得知数据库的文件名，当前一个数据库只有一张表，一个文件。即这样：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (argc &lt;= <span class="number">1</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Must supply a database filename.\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">char</span>* filename = argv[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行如下定义：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//存储page   这里page和table的关系也说明了一张表可以使用很多文件来存储</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">int</span> file_descriptor;</span><br><span class="line">	<span class="keyword">uint32_t</span> file_length;</span><br><span class="line">	<span class="keyword">void</span>* pages[TABLE_MAX_PAGES];</span><br><span class="line">&#125; Pager;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一张表</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> num_rows;</span><br><span class="line">	Pager* pager;</span><br><span class="line">&#125; Table;</span><br></pre></td></tr></table></figure>

<p>一个表内包含一个pager用来管理数据库中的page，另外还需要存储数据库中的条目数量。一个pager就是一个文件的索引，负责存储对应的文件句柄，并且存储pages,一张表可以用有很多个pager,一个pager存储一个文件，这样就可以让一张表使用多个文件来存储了。另外，这里pager用到了操作系统中缓存的概念，其中每一个page都指向内存中的一块区域，但是如果对应的page没有在内存中（NULL）就需要进行内存和和硬盘的交换。</p>
<h3 id="初始化table-amp-amp-pager"><a href="#初始化table-amp-amp-pager" class="headerlink" title="初始化table &amp;&amp; pager"></a>初始化table &amp;&amp; pager</h3><p>程序要连接数据库，因为目前数据库中只有一张表故连接这一张表就好。所以 <strong>db_open</strong> 自然就是 <strong>table_open</strong>. </p>
<p>table中的pager需要先进行初始化，然后利用pager中的file_length就可以得到table中的 num_rows.</p>
<p>对于pager,首先需要根据上层传来的filename打开文件，然后根据文件信息算出来 file_length, 由此得出 page的数量，根据数量将 void* pages[TABLE_MAX_PAGES]; 全部指向null,因为当前内存中含没有任何数据库数据。</p>
<p>这杨初始化的工作就完成了。</p>
<h3 id="内存替换"><a href="#内存替换" class="headerlink" title="内存替换"></a>内存替换</h3><p>这里实现了一个简单的抽象内存管理模块，入口：pager page_num  出口：在内存中找到或者开辟一块page区域，并以指针的形式返回。</p>
<p>加入要使用的页（根据页号来判断）不在内存中则发生缺页中断，这时在内存中开辟一个页空间，并且判断磁盘中是否有该页（根据该页号和磁盘中的页数量作比较），若有的话则读取磁盘内容填充该页的内容，若没有的话则什么都不做直接饭返回这个空页即可。</p>
<p>这样就在内存中得到了想要的页。</p>
<p>同理，反过来在结束程序的时候还需要将内存中更新的页和磁盘中的相同步。</p>
<h3 id="程序抽象"><a href="#程序抽象" class="headerlink" title="程序抽象"></a>程序抽象</h3><p>现在使用光标进行程序的抽象，即使用光标标识某一个行，使用一个函数获取该光标真实表示的行（在内存中），当然，若内存中本就不存在的话则使用上面提到的内存替换策略。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一张表</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> num_rows;</span><br><span class="line">	Pager* pager;</span><br><span class="line">&#125; Table;</span><br><span class="line"></span><br><span class="line"><span class="comment">//光标指针</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	Table* table;</span><br><span class="line">	<span class="keyword">uint32_t</span> row_num;</span><br><span class="line">	<span class="keyword">bool</span> end_of_table;  <span class="comment">// Indicates a position one past the last element</span></span><br><span class="line">&#125; Cursor;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//插入前判断插入的内存位置 以及适时分配内存 光标指针的作用就是指示某个table中的某一行，并表明该行是否为最后一行。</span></span><br><span class="line"><span class="comment">//入口：一个光标指针   出口：指向内存中光标指针对应行的指针</span></span><br><span class="line"><span class="function">Row* <span class="title">cursor_value</span><span class="params">(Cursor* cursor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> row_num = cursor-&gt;row_num;</span><br><span class="line">	<span class="keyword">uint32_t</span> page_num = row_num / ROWS_PER_PAGE;</span><br><span class="line">	<span class="comment">//算出来吧光标指针指向哪一个page  并获取这一页</span></span><br><span class="line">	<span class="keyword">void</span>* page = <span class="built_in">get_page</span>(cursor-&gt;table-&gt;pager, page_num);</span><br><span class="line">	<span class="keyword">uint32_t</span> row_offset = row_num % ROWS_PER_PAGE;</span><br><span class="line">	<span class="keyword">uint32_t</span> byte_offset = row_offset * ROW_SIZE;</span><br><span class="line">	<span class="comment">//之所以报 “必须是指向完整类型”的错，是因为指针指向类型不确定，则其单位不确定，加上byte_offset后也不知道到底指向哪一块内存。</span></span><br><span class="line">	<span class="comment">//由于 byte_offset 是字节单位，所以page页要变为指向8位内存的指针。所以转化位 uint8_t</span></span><br><span class="line">	<span class="keyword">return</span> (Row*)((<span class="keyword">uint8_t</span>*)page + byte_offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h3><h4 id="CDB-h-1"><a href="#CDB-h-1" class="headerlink" title="CDB.h"></a>CDB.h</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COLUMN_USERNAME_SIZE 32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COLUMN_EMAIL_SIZE 255</span></span><br><span class="line"><span class="comment">//表中最大页数</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TABLE_MAX_PAGES 100</span></span><br><span class="line"><span class="comment">//页的大小</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 4096</span></span><br><span class="line"><span class="comment">//定义宏获取size</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> size_of_attribute(Struct, Attribute) sizeof(((Struct*)0)-&gt;Attribute)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//输入缓冲</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">char</span>* buffer;</span><br><span class="line">	<span class="comment">// _int64</span></span><br><span class="line">	<span class="keyword">size_t</span> buffer_length;</span><br><span class="line">	<span class="keyword">size_t</span> input_length;</span><br><span class="line">&#125; InputBuffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断输入得到的命令状态</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	META_COMMAND_EXIT,</span><br><span class="line">	META_COMMAND_SUCCESS,</span><br><span class="line">	META_COMMAND_UNRECOGNIZED_COMMAND</span><br><span class="line">&#125; MetaCommandResult;</span><br><span class="line"></span><br><span class="line"><span class="comment">//预处理得到的状态</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	PREPARE_SUCCESS,</span><br><span class="line">	PREPARE_NEGATIVE_ID,</span><br><span class="line">	PREPARE_SYNTAX_ERROR,</span><br><span class="line">	PREPARE_STRING_TOO_LONG,</span><br><span class="line">	PREPARE_TOO_MANY_PARAMETER,</span><br><span class="line">	PREPARE_UNRECOGNIZED_STATEMENT</span><br><span class="line">&#125; PrepareResult;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理后的状态</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	EXECUTE_SUCCESS,</span><br><span class="line">	EXECUTE_TABLE_FULL</span><br><span class="line">&#125;ExecuteResult;</span><br><span class="line"></span><br><span class="line"><span class="comment">//得到的输入的表达式的状态</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	STATEMENT_INSERT,</span><br><span class="line">	STATEMENT_SELECT</span><br><span class="line">&#125; StatementType;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义 一行 </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> id;</span><br><span class="line">	<span class="comment">//加一是因为c语言需要最后一个字符为0，所以可用字符就减一了。</span></span><br><span class="line">	<span class="comment">//不过即使这样也还需要在输入的时候判断是否大小超界</span></span><br><span class="line">	<span class="keyword">char</span> username[COLUMN_USERNAME_SIZE + <span class="number">1</span>];</span><br><span class="line">	<span class="keyword">char</span> email[COLUMN_EMAIL_SIZE + <span class="number">1</span>];</span><br><span class="line">&#125; Row;</span><br><span class="line"></span><br><span class="line"><span class="comment">//statement</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	StatementType type;</span><br><span class="line">	Row row_to_insert;</span><br><span class="line">&#125; Statement;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取行中每一个元素的size和offset</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> ID_SIZE = <span class="built_in">size_of_attribute</span>(Row, id);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> USERNAME_SIZE = <span class="built_in">size_of_attribute</span>(Row, username);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> EMAIL_SIZE = <span class="built_in">size_of_attribute</span>(Row, email);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> ID_OFFSET = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> USERNAME_OFFSET = <span class="number">0</span> + <span class="built_in">size_of_attribute</span>(Row, id);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> EMAIL_OFFSET = <span class="number">0</span> + <span class="built_in">size_of_attribute</span>(Row, id) + <span class="built_in">size_of_attribute</span>(Row, username);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> ROW_SIZE = <span class="built_in">size_of_attribute</span>(Row, id) + <span class="built_in">size_of_attribute</span>(Row, username) + <span class="built_in">size_of_attribute</span>(Row, email);</span><br><span class="line"><span class="comment">//每一页有多少行</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> ROWS_PER_PAGE = PAGE_SIZE / (<span class="built_in">size_of_attribute</span>(Row, id) + <span class="built_in">size_of_attribute</span>(Row, username) + <span class="built_in">size_of_attribute</span>(Row, email));</span><br><span class="line"><span class="comment">//一张表里面最大行数</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> TABLE_MAX_ROWS = PAGE_SIZE / (<span class="built_in">size_of_attribute</span>(Row, id) + <span class="built_in">size_of_attribute</span>(Row, username) + <span class="built_in">size_of_attribute</span>(Row, email)) * TABLE_MAX_PAGES;</span><br><span class="line"></span><br><span class="line"><span class="comment">//存储page   这里page和table的关系也说明了一张表可以使用很多文件来存储</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">int</span> file_descriptor;</span><br><span class="line">	<span class="keyword">uint32_t</span> file_length;</span><br><span class="line">	<span class="keyword">void</span>* pages[TABLE_MAX_PAGES];</span><br><span class="line">&#125; Pager;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一张表</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> num_rows;</span><br><span class="line">	Pager* pager;</span><br><span class="line">&#125; Table;</span><br><span class="line"></span><br><span class="line"><span class="comment">//光标指针</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	Table* table;</span><br><span class="line">	<span class="keyword">uint32_t</span> row_num;</span><br><span class="line">	<span class="keyword">bool</span> end_of_table;  <span class="comment">// Indicates a position one past the last element</span></span><br><span class="line">&#125; Cursor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化一个input_buffer</span></span><br><span class="line"><span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//打印命令提示符</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_prompt</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 获取一行的输入，以换行符为终结</span></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">getline</span><span class="params">(<span class="keyword">char</span>** buffer, <span class="keyword">size_t</span>* n)</span></span>;</span><br><span class="line"><span class="comment">//读取输入</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_input</span><span class="params">(InputBuffer* input_buffer)</span></span>;</span><br><span class="line"><span class="comment">//关闭输入</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span></span>;</span><br><span class="line"><span class="comment">// 判断是何种命令</span></span><br><span class="line"><span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer, Table* table)</span></span>;</span><br><span class="line"><span class="comment">//预处理结果</span></span><br><span class="line"><span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer, Statement* statement)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_trim</span><span class="params">(InputBuffer* input_buffer)</span></span>;</span><br><span class="line"><span class="function">PrepareResult <span class="title">prepare_insert</span><span class="params">(InputBuffer* input_buffer, Statement* statement)</span></span>;</span><br><span class="line"><span class="comment">//执行命令 根据 statement 来执行相应的命令</span></span><br><span class="line"><span class="function">ExecuteResult <span class="title">execute_statement</span><span class="params">(Statement* statement, Table* table)</span></span>;</span><br><span class="line"><span class="function">ExecuteResult <span class="title">execute_insert</span><span class="params">(Statement* statement, Table* table)</span></span>;</span><br><span class="line"><span class="function">ExecuteResult <span class="title">execute_select</span><span class="params">(Statement* statement, Table* table)</span></span>;</span><br><span class="line"><span class="comment">//将行的信息存储到内存中</span></span><br><span class="line"><span class="comment">//A void pointer can hold address of any type and can be typcasted to any type</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serialize_row</span><span class="params">(Row* source, Row* destination)</span></span>;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deserialize_row</span><span class="params">(Row* source, Row* destination)</span></span>;</span><br><span class="line"><span class="comment">//插入前判断插入的内存位置 以及适时分配内存 </span></span><br><span class="line"><span class="function">Row* <span class="title">cursor_value</span><span class="params">(Cursor* cursor)</span></span>;</span><br><span class="line"><span class="comment">//从磁盘中获取page</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">get_page</span><span class="params">(Pager* pager, <span class="keyword">uint32_t</span> page_num)</span></span>;</span><br><span class="line"><span class="comment">//同步内存中的额数据和磁盘中的数据</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pager_flush</span><span class="params">(Pager* pager, <span class="keyword">uint32_t</span> page_num, <span class="keyword">uint32_t</span> size)</span></span>;</span><br><span class="line"><span class="comment">//连接数据库  使用文件名</span></span><br><span class="line"><span class="function">Table* <span class="title">db_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* filename)</span></span>;</span><br><span class="line"><span class="function">Pager* <span class="title">pager_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* filename)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">db_close</span><span class="params">(Table* table)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_table</span><span class="params">(Table* table)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_row</span><span class="params">(Row* row)</span></span>;</span><br><span class="line"><span class="comment">//指向表的开头 第一行</span></span><br><span class="line"><span class="function">Cursor* <span class="title">table_start</span><span class="params">(Table* table)</span></span>;</span><br><span class="line"><span class="comment">//指向当前要插入的一行</span></span><br><span class="line"><span class="function">Cursor* <span class="title">table_end</span><span class="params">(Table* table)</span></span>;</span><br><span class="line"><span class="comment">//更新 cursor</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cursor_advance</span><span class="params">(Cursor* cursor)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="CDB-cpp"><a href="#CDB-cpp" class="headerlink" title="CDB.cpp"></a>CDB.cpp</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="comment">//在最前面加上这个宏</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CDB.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	InputBuffer* input_buffer = (InputBuffer*)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(InputBuffer));</span><br><span class="line">	<span class="keyword">if</span> (input_buffer)</span><br><span class="line">	&#123;</span><br><span class="line">		input_buffer-&gt;buffer = <span class="literal">NULL</span>;</span><br><span class="line">		input_buffer-&gt;buffer_length = <span class="number">0</span>;</span><br><span class="line">		input_buffer-&gt;input_length = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span> input_buffer;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_prompt</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;CDB &gt;&gt; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取一行的输入，以换行符为终结</span></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">getline</span><span class="params">(<span class="keyword">char</span>** buffer, <span class="keyword">size_t</span>* n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> c = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">size_t</span> bytes_read = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//一行最多不超过80个字符</span></span><br><span class="line">	<span class="keyword">uint32_t</span> COLUMN_MAX_SIZE = COLUMN_USERNAME_SIZE + COLUMN_EMAIL_SIZE + <span class="number">100</span>;</span><br><span class="line">	<span class="keyword">char</span>* buffer_temp = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(COLUMN_MAX_SIZE * <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">char</span>));</span><br><span class="line">	<span class="keyword">if</span> (buffer_temp == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span> ((c = <span class="built_in">getchar</span>()) &amp;&amp; c != <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		*(buffer_temp + bytes_read++) = c;</span><br><span class="line">		<span class="keyword">if</span> (bytes_read == COLUMN_MAX_SIZE)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;too long\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	*buffer = buffer_temp;</span><br><span class="line">	<span class="keyword">return</span> bytes_read;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_input</span><span class="params">(InputBuffer* input_buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// void 对于所有类型都非法 </span></span><br><span class="line">	<span class="comment">// 返回读取得到的字节数量</span></span><br><span class="line">	<span class="keyword">size_t</span> bytes_read = <span class="built_in">getline</span>(&amp;(input_buffer-&gt;buffer), &amp;(input_buffer-&gt;buffer_length));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//printf(&quot;这次读取到的字节数量为 %llu\n&quot;, bytes_read);</span></span><br><span class="line">	<span class="keyword">if</span> (bytes_read &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Error reading input\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Ignore trailing newline    </span></span><br><span class="line">	input_buffer-&gt;input_length = bytes_read;</span><br><span class="line">	input_buffer-&gt;buffer[bytes_read] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//关闭输入</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">free</span>(input_buffer-&gt;buffer);</span><br><span class="line">	<span class="built_in">free</span>(input_buffer);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;关闭输入\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是何种命令</span></span><br><span class="line"><span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer, Table* table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//退出</span></span><br><span class="line">		<span class="built_in">db_close</span>(table);</span><br><span class="line">		<span class="keyword">return</span> META_COMMAND_EXIT;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.q&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//退出</span></span><br><span class="line">		<span class="built_in">db_close</span>(table);</span><br><span class="line">		<span class="keyword">return</span> META_COMMAND_EXIT;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.v&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//显示当前版本</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CDB version 0.1\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> META_COMMAND_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//不可解析</span></span><br><span class="line">		<span class="keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//预处理，就是前缀命令识别</span></span><br><span class="line"><span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer, Statement* statement)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">prepare_trim</span>(input_buffer);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;insert&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">prepare_insert</span>(input_buffer, statement);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;select&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		statement-&gt;type = STATEMENT_SELECT;</span><br><span class="line">		<span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> PREPARE_UNRECOGNIZED_STATEMENT;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//预处理的预处理 去掉多余的空格</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_trim</span><span class="params">(InputBuffer* input_buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span>* temp = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(input_buffer-&gt;buffer) * <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">char</span>));</span><br><span class="line">	<span class="keyword">char</span>* p1 = temp;</span><br><span class="line">	<span class="keyword">char</span>* p2 = input_buffer-&gt;buffer;</span><br><span class="line">	<span class="comment">//首先去掉前面的空格</span></span><br><span class="line">	<span class="keyword">while</span> ((*p2) == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		p2++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//现在p2指向真正的命令起始</span></span><br><span class="line">	<span class="comment">//去掉文本中间多余的空格</span></span><br><span class="line">	<span class="keyword">bool</span> flag = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">while</span> ((*p2) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (((*p2) == <span class="string">&#x27; &#x27;</span>) &amp;&amp; (flag == <span class="literal">true</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			*p1 = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">			p1++;</span><br><span class="line">			p2++;</span><br><span class="line">			flag = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((*p2) != <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			*p1 = *p2;</span><br><span class="line">			p1++;</span><br><span class="line">			p2++;</span><br><span class="line">			flag = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			p2++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//此时 p1 指向最后，需要变为0</span></span><br><span class="line">	*p1 = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">free</span>(input_buffer-&gt;buffer);</span><br><span class="line">	input_buffer-&gt;buffer = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">PrepareResult <span class="title">prepare_insert</span><span class="params">(InputBuffer* input_buffer, Statement* statement)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">	<span class="comment">//这里应该可以去掉开头的空格，目前还不可以</span></span><br><span class="line">	<span class="keyword">char</span>* keyword = <span class="built_in">strtok</span>(input_buffer-&gt;buffer, <span class="string">&quot; &quot;</span>);</span><br><span class="line">	<span class="keyword">char</span>* id_string = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">	<span class="keyword">char</span>* username = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">	<span class="keyword">char</span>* email = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">	<span class="keyword">char</span>* test_parameter = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (id_string == <span class="literal">NULL</span> || username == <span class="literal">NULL</span> || email == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> PREPARE_SYNTAX_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (test_parameter != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> PREPARE_TOO_MANY_PARAMETER;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> id = <span class="built_in">atoi</span>(id_string);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strlen</span>(username) &gt; COLUMN_USERNAME_SIZE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> PREPARE_STRING_TOO_LONG;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strlen</span>(email) &gt; COLUMN_EMAIL_SIZE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> PREPARE_STRING_TOO_LONG;</span><br><span class="line">	&#125;</span><br><span class="line">	statement-&gt;row_to_insert.id = id;</span><br><span class="line">	<span class="built_in">strcpy</span>(statement-&gt;row_to_insert.username, username);</span><br><span class="line">	<span class="built_in">strcpy</span>(statement-&gt;row_to_insert.email, email);</span><br><span class="line">	<span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行命令</span></span><br><span class="line"><span class="function">ExecuteResult <span class="title">execute_statement</span><span class="params">(Statement* statement, Table* table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in"><span class="keyword">switch</span></span> (statement-&gt;type)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="built_in"><span class="keyword">case</span></span> (STATEMENT_INSERT):</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">execute_insert</span>(statement, table);</span><br><span class="line">	<span class="built_in"><span class="keyword">case</span></span> (STATEMENT_SELECT):</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">execute_select</span>(statement, table);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">ExecuteResult <span class="title">execute_insert</span><span class="params">(Statement* statement, Table* table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (table-&gt;num_rows &gt;= TABLE_MAX_ROWS)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> EXECUTE_TABLE_FULL;</span><br><span class="line">	&#125;</span><br><span class="line">	Row* row_to_insert = &amp;(statement-&gt;row_to_insert);</span><br><span class="line">	Cursor* cursor = <span class="built_in">table_end</span>(table);</span><br><span class="line">	<span class="comment">//将一行存入内存</span></span><br><span class="line">	<span class="built_in">serialize_row</span>(row_to_insert, <span class="built_in">cursor_value</span>(cursor));</span><br><span class="line">	table-&gt;num_rows += <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> EXECUTE_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">ExecuteResult <span class="title">execute_select</span><span class="params">(Statement* statement, Table* table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Cursor* cursor = <span class="built_in">table_start</span>(table);</span><br><span class="line">	Row row;</span><br><span class="line">	<span class="keyword">while</span> (!(cursor-&gt;end_of_table)) &#123;</span><br><span class="line">		<span class="built_in">deserialize_row</span>(<span class="built_in">cursor_value</span>(cursor), &amp;row);</span><br><span class="line">		<span class="built_in">print_row</span>(&amp;row);</span><br><span class="line">		<span class="built_in">cursor_advance</span>(cursor);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">free</span>(cursor);</span><br><span class="line">	<span class="keyword">return</span> EXECUTE_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//将行的信息存储到内存中</span></span><br><span class="line"><span class="comment">//A void pointer can hold address of any type and can be typcasted to any type</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serialize_row</span><span class="params">(Row* source, Row* destination)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// ID_SIZE 指的是字节数</span></span><br><span class="line">	<span class="built_in">memcpy</span>((<span class="keyword">uint8_t</span>*)destination + ID_OFFSET, &amp;(source-&gt;id), ID_SIZE);</span><br><span class="line">	<span class="built_in">memcpy</span>((<span class="keyword">uint8_t</span>*)destination + USERNAME_OFFSET, &amp;(source-&gt;username), USERNAME_SIZE);</span><br><span class="line">	<span class="built_in">memcpy</span>((<span class="keyword">uint8_t</span>*)destination + EMAIL_OFFSET, &amp;(source-&gt;email), EMAIL_SIZE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deserialize_row</span><span class="params">(Row* source, Row* destination)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">memcpy</span>(&amp;(destination-&gt;id), (<span class="keyword">uint8_t</span>*)source + ID_OFFSET, ID_SIZE);</span><br><span class="line">	<span class="built_in">memcpy</span>(&amp;(destination-&gt;username), (<span class="keyword">uint8_t</span>*)source + USERNAME_OFFSET, USERNAME_SIZE);</span><br><span class="line">	<span class="built_in">memcpy</span>(&amp;(destination-&gt;email), (<span class="keyword">uint8_t</span>*)source + EMAIL_OFFSET, EMAIL_SIZE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//插入前判断插入的内存位置 以及适时分配内存 光标指针的作用就是指示某个table中的某一行，并表明该行是否为最后一行。</span></span><br><span class="line"><span class="comment">//入口：一个光标指针   出口：指向内存中光标指针对应行的指针</span></span><br><span class="line"><span class="function">Row* <span class="title">cursor_value</span><span class="params">(Cursor* cursor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> row_num = cursor-&gt;row_num;</span><br><span class="line">	<span class="keyword">uint32_t</span> page_num = row_num / ROWS_PER_PAGE;</span><br><span class="line">	<span class="comment">//算出来吧光标指针指向哪一个page  并获取这一页</span></span><br><span class="line">	<span class="keyword">void</span>* page = <span class="built_in">get_page</span>(cursor-&gt;table-&gt;pager, page_num);</span><br><span class="line">	<span class="keyword">uint32_t</span> row_offset = row_num % ROWS_PER_PAGE;</span><br><span class="line">	<span class="keyword">uint32_t</span> byte_offset = row_offset * ROW_SIZE;</span><br><span class="line">	<span class="comment">//之所以报 “必须是指向完整类型”的错，是因为指针指向类型不确定，则其单位不确定，加上byte_offset后也不知道到底指向哪一块内存。</span></span><br><span class="line">	<span class="comment">//由于 byte_offset 是字节单位，所以page页要变为指向8位内存的指针。所以转化位 uint8_t</span></span><br><span class="line">	<span class="keyword">return</span> (Row*)((<span class="keyword">uint8_t</span>*)page + byte_offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//从磁盘中获取page  </span></span><br><span class="line"><span class="comment">//入口：pager page_num  出口：在内存中找到或者开辟一块page区域，并以指针的形式返回。</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">get_page</span><span class="params">(Pager* pager, <span class="keyword">uint32_t</span> page_num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (page_num &gt; TABLE_MAX_PAGES)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Tried to fetch page number out of bounds. %d &gt; %d\n&quot;</span>, page_num, TABLE_MAX_PAGES);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (pager-&gt;pages[page_num] == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Cache miss. Allocate memory and load from file.</span></span><br><span class="line">		<span class="keyword">void</span>* page = <span class="built_in">malloc</span>(PAGE_SIZE);</span><br><span class="line">		<span class="keyword">if</span> (!page)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;load page error.\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//pager中没有存储page的数量，所以才需要在这里算出来</span></span><br><span class="line">		<span class="keyword">uint32_t</span> num_pages = pager-&gt;file_length / PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// We might save a partial page at the end of the file</span></span><br><span class="line">		<span class="keyword">if</span> (pager-&gt;file_length % PAGE_SIZE)</span><br><span class="line">		&#123;</span><br><span class="line">			num_pages += <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//这里应为 num_pages-1 因为都是从零开始，num_pages算出来的是真实的page数量，比下标大一</span></span><br><span class="line">		<span class="keyword">if</span> (page_num &lt;= num_pages - <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//设定文件指针位置</span></span><br><span class="line">			_lseek(pager-&gt;file_descriptor, page_num * PAGE_SIZE, SEEK_SET);</span><br><span class="line">			<span class="comment">//获取一个page到内存中。并将读取到的字节数存储到bytes_read中</span></span><br><span class="line">			<span class="keyword">size_t</span> bytes_read = _read(pager-&gt;file_descriptor, page, PAGE_SIZE);</span><br><span class="line">			<span class="keyword">if</span> (bytes_read == <span class="number">-1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//打印出程序错误代码，目前我还不会用。</span></span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Error reading file: %d\n&quot;</span>, errno);</span><br><span class="line">				<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//如果大于当前文件中的页数，则说明文件中没有这个页，这是一个新页，直接使用即可。</span></span><br><span class="line">		pager-&gt;pages[page_num] = page;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> pager-&gt;pages[page_num];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//目前数据库中只有一张表</span></span><br><span class="line"><span class="function">Table* <span class="title">db_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Pager* pager = <span class="built_in">pager_open</span>(filename);</span><br><span class="line">	<span class="comment">//当前存储的行数，因为现在一张表只用一个文件来存储故这样是也可以的。</span></span><br><span class="line">	<span class="keyword">uint32_t</span> num_rows = pager-&gt;file_length / ROW_SIZE;</span><br><span class="line">	Table* table = (Table*)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(Table));</span><br><span class="line">	table-&gt;pager = pager;</span><br><span class="line">	table-&gt;num_rows = num_rows;</span><br><span class="line">	<span class="keyword">return</span> table;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Pager* <span class="title">pager_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		int fd = open(filename,</span></span><br><span class="line"><span class="comment">		O_RDWR |      // Read/Write mode</span></span><br><span class="line"><span class="comment">		O_CREAT,  // Create file if it does not exist</span></span><br><span class="line"><span class="comment">		S_IWUSR |     // User write permission</span></span><br><span class="line"><span class="comment">		S_IRUSR   // User read permission</span></span><br><span class="line"><span class="comment">		);</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="comment">//Read/Write mode Create file if it does not exist</span></span><br><span class="line">	<span class="keyword">int</span> fd = _open(filename, O_RDWR | O_CREAT, _S_IREAD | _S_IWRITE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Unable to open file\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//long  文件中的偏移地址从0到seek_end的长度即为文件的长度</span></span><br><span class="line">	<span class="comment">//returns the offset, in bytes, of the new position from the beginning of the file</span></span><br><span class="line">	<span class="comment">//将文件指针从 SEEK_END向后移动0为，并返回新的文件指针相对于文件起始 SEEK_SET 的偏移量，即文件大小</span></span><br><span class="line">	<span class="keyword">off_t</span> file_length = _lseek(fd, <span class="number">0</span>, SEEK_END);</span><br><span class="line">	<span class="comment">//初始化pager</span></span><br><span class="line">	Pager* pager = (Pager*)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(Pager));</span><br><span class="line">	pager-&gt;file_descriptor = fd;</span><br><span class="line">	pager-&gt;file_length = file_length;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; TABLE_MAX_PAGES; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		pager-&gt;pages[i] = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> pager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//将某一页存储到硬盘中</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pager_flush</span><span class="params">(Pager* pager, <span class="keyword">uint32_t</span> page_num, <span class="keyword">uint32_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (pager-&gt;pages[page_num] == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Tried to flush null page\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//SEEK_SET: Beginning of the file.  将文件指针指向对应位置，下一次操控文件就从这里开始了</span></span><br><span class="line">	<span class="keyword">off_t</span> offset = _lseek(pager-&gt;file_descriptor, page_num * PAGE_SIZE, SEEK_SET);</span><br><span class="line">	<span class="keyword">if</span> (offset == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Error seeking: %d\n&quot;</span>, errno);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//从当前文件指针位置写入 大小为size的内存 内存起始为pager-&gt;pages[page_num]</span></span><br><span class="line">	<span class="keyword">size_t</span> bytes_written = _write(pager-&gt;file_descriptor, pager-&gt;pages[page_num], size);</span><br><span class="line">	<span class="keyword">if</span> (bytes_written == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Error writing: %d\n&quot;</span>, errno);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//关闭数据库连接</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">db_close</span><span class="params">(Table* table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Pager* pager = table-&gt;pager;</span><br><span class="line">	<span class="comment">//满的 page</span></span><br><span class="line">	<span class="keyword">uint32_t</span> num_full_pages = table-&gt;num_rows / ROWS_PER_PAGE;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; num_full_pages; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//判断page是否在内存中，不在的话就从内存中更新到硬盘上。并释放内存</span></span><br><span class="line">		<span class="keyword">if</span> (pager-&gt;pages[i] == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">pager_flush</span>(pager, i, PAGE_SIZE);</span><br><span class="line">		<span class="built_in">free</span>(pager-&gt;pages[i]);</span><br><span class="line">		pager-&gt;pages[i] = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// There may be a partial page to write to the end of the file</span></span><br><span class="line">	<span class="comment">// This should not be needed after we switch to a B-tree</span></span><br><span class="line">	<span class="keyword">uint32_t</span> num_additional_rows = table-&gt;num_rows % ROWS_PER_PAGE;</span><br><span class="line">	<span class="keyword">if</span> (num_additional_rows &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">uint32_t</span> page_num = num_full_pages;</span><br><span class="line">		<span class="comment">//剩下不足一个page的行所在的page_num</span></span><br><span class="line">		<span class="keyword">if</span> (pager-&gt;pages[page_num] != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">pager_flush</span>(pager, page_num, num_additional_rows * ROW_SIZE);</span><br><span class="line">			<span class="built_in">free</span>(pager-&gt;pages[page_num]);</span><br><span class="line">			pager-&gt;pages[page_num] = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> result = _close(pager-&gt;file_descriptor);</span><br><span class="line">	<span class="keyword">if</span> (result == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Error closing db file.\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; TABLE_MAX_PAGES; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">void</span>* page = pager-&gt;pages[i];</span><br><span class="line">		<span class="keyword">if</span> (page)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">free</span>(page);</span><br><span class="line">			pager-&gt;pages[i] = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">free</span>(pager);</span><br><span class="line">	<span class="built_in">free</span>(table);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_table</span><span class="params">(Table* table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; table-&gt;pager-&gt;pages[i]; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">free</span>(table-&gt;pager-&gt;pages[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">free</span>(table-&gt;pager);</span><br><span class="line">	<span class="built_in">free</span>(table);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_row</span><span class="params">(Row* row)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;| id: %u username: %s email: %s |\n&quot;</span>, row-&gt;id, row-&gt;username, row-&gt;email);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//指向表的开头 第一行</span></span><br><span class="line"><span class="function">Cursor* <span class="title">table_start</span><span class="params">(Table* table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Cursor* cursor = (Cursor*)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(Cursor));</span><br><span class="line">	cursor-&gt;table = table;</span><br><span class="line">	cursor-&gt;row_num = <span class="number">0</span>;</span><br><span class="line">	cursor-&gt;end_of_table = (table-&gt;num_rows == <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> cursor;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//指向当前要插入的一行</span></span><br><span class="line"><span class="function">Cursor* <span class="title">table_end</span><span class="params">(Table* table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Cursor* cursor = (Cursor*)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(Cursor));</span><br><span class="line">	cursor-&gt;table = table;</span><br><span class="line">	cursor-&gt;row_num = table-&gt;num_rows;</span><br><span class="line">	cursor-&gt;end_of_table = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">return</span> cursor;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//更新 cursor</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cursor_advance</span><span class="params">(Cursor* cursor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cursor-&gt;row_num += <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (cursor-&gt;row_num &gt;= cursor-&gt;table-&gt;num_rows)</span><br><span class="line">	&#123;</span><br><span class="line">		cursor-&gt;end_of_table = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="main-c-1"><a href="#main-c-1" class="headerlink" title="main.c"></a>main.c</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CDB.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (argc &lt;= <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Must supply a database filename.\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">char</span>* filename = argv[<span class="number">1</span>];</span><br><span class="line">	Table* table = <span class="built_in">db_open</span>(filename);</span><br><span class="line">	InputBuffer* input_buffer = <span class="built_in">new_input_buffer</span>();</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">print_prompt</span>();</span><br><span class="line">		<span class="built_in">read_input</span>(input_buffer);</span><br><span class="line">		<span class="comment">//判断是否有输入，若是回车直接 continue</span></span><br><span class="line">		<span class="keyword">if</span> (input_buffer-&gt;input_length == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//以 . 开头则为非 sql 命令</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (input_buffer-&gt;buffer[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in"><span class="keyword">switch</span></span> (<span class="built_in">do_meta_command</span>(input_buffer, table))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//退出</span></span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (META_COMMAND_EXIT):</span><br><span class="line">				<span class="comment">//printf(&quot;META_COMMAND_EXIT&quot;);</span></span><br><span class="line">				<span class="built_in">close_input_buffer</span>(input_buffer);</span><br><span class="line">				<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">				<span class="comment">//此命令可以解析</span></span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (META_COMMAND_SUCCESS):</span><br><span class="line">				<span class="comment">//printf(&quot;META_COMMAND_SUCCESS&quot;);</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">				<span class="comment">//命令不可解析</span></span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (META_COMMAND_UNRECOGNIZED_COMMAND):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Unrecognized command &#x27;%s&#x27;\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//sql命令</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (input_buffer-&gt;buffer[<span class="number">0</span>] != <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//进行预处理  即判断 insert create 等命令</span></span><br><span class="line">			Statement statement;</span><br><span class="line">			<span class="built_in"><span class="keyword">switch</span></span> (<span class="built_in">prepare_statement</span>(input_buffer, &amp;statement))</span><br><span class="line">			&#123;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (PREPARE_SUCCESS):</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (PREPARE_STRING_TOO_LONG):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;String is too long.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span>(PREPARE_NEGATIVE_ID):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;your id id negative.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span>(PREPARE_TOO_MANY_PARAMETER):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;too many parameter.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (PREPARE_UNRECOGNIZED_STATEMENT):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Unrecognized keyword at start of &#x27;%s&#x27;.\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">				<span class="comment">//break 会break switch本身， 而continue 会continue 上一层，而忽略掉 switch</span></span><br><span class="line">				<span class="comment">//这里直接continue 到while(true)</span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span>(PREPARE_SYNTAX_ERROR):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Syntax error. Could not parse statement.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in"><span class="keyword">switch</span></span> (<span class="built_in">execute_statement</span>(&amp;statement, table))</span><br><span class="line">			&#123;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (EXECUTE_SUCCESS):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Executed.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="built_in"><span class="keyword">case</span></span> (EXECUTE_TABLE_FULL):</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Error: Table full.\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;error\n&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第三步-使用-B-TREE"><a href="#第三步-使用-B-TREE" class="headerlink" title="第三步 使用 B TREE"></a>第三步 使用 B TREE</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://myblog.cuimouren.cn/2021/07/17/%E5%BE%AE%E6%9C%BA%E4%B8%8E%E6%B1%87%E7%BC%96%E6%8E%A5%E5%8F%A3%E5%AE%9E%E9%AA%8C%E7%BB%93%E9%A2%98%E6%8A%A5%E5%91%8A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="崔文耀">
      <meta itemprop="description" content="Hello, here is wenyao's space, how do you come in???">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="这里是文耀的space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="../../2021/07/17/%E5%BE%AE%E6%9C%BA%E4%B8%8E%E6%B1%87%E7%BC%96%E6%8E%A5%E5%8F%A3%E5%AE%9E%E9%AA%8C%E7%BB%93%E9%A2%98%E6%8A%A5%E5%91%8A/" class="post-title-link" itemprop="url">贪吃蛇结题报告</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-17 19:11:57" itemprop="dateCreated datePublished" datetime="2021-07-17T19:11:57+08:00">2021-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-18 17:21:23" itemprop="dateModified" datetime="2021-07-18T17:21:23+08:00">2021-07-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/%E5%BE%AE%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">微机</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="贪吃蛇结题报告"><a href="#贪吃蛇结题报告" class="headerlink" title="贪吃蛇结题报告"></a>贪吃蛇结题报告</h1><p><a href="/file/%E5%BE%AE%E6%9C%BA%E4%B8%8E%E6%B1%87%E7%BC%96%E6%8E%A5%E5%8F%A3%E5%AE%9E%E9%AA%8C/%E5%BE%AE%E6%9C%BA%E4%B8%8E%E6%B1%87%E7%BC%96%E6%8E%A5%E5%8F%A3%E5%AE%9E%E9%AA%8C.zip">代码</a></p>
<h2 id="题目意义"><a href="#题目意义" class="headerlink" title="题目意义"></a>题目意义</h2><p>这次微机实验，我们选择的题目是贪吃蛇街机小游戏。简单来讲就是使用微机试验台上的led点阵作为显示屏，配合计数操作显示得分情况，利用键盘进行IO操作的贪吃蛇小游戏。之所以选择这个题目是因为我想在有限的实验条件上极可能的做出一个比较有趣的项目。由此可见，此题目的意义就是探求自己在简陋的实验环境中做出复杂工程的能力，同时也是在检验自己在微机课程中所学到的知识是否扎实。</p>
<h2 id="设计思想"><a href="#设计思想" class="headerlink" title="设计思想"></a>设计思想</h2><ol>
<li>图像显示<br> 使用led点阵将贪吃蛇的位置和食物的位置显示出来，首先我们必须提供一个底层的方法来方便地将led灯进行点亮，这就促使我们引入了缓存地概念（下面再说）和一个读取缓存地内容进行点亮灯的方法。</li>
<li>图像显示的缓存<br> 为了方便的进行led的显示，我门引入了缓存的概念，即将要显示的led点阵的信息以比特的形式存储在内存中，命名为red_buffer和green_buffer</li>
<li>图像操控<br> 为了方便的修改缓存中的信息，我们实现了一个函数将特定位置的额灯的颜色置红，值绿或者置暗。</li>
<li>中断<br> 使用8253产生定时中断为系统提供时间基准。</li>
<li>IO输入<br> 由中断驱动进行IO操作，将键盘等的输入存入内存。</li>
<li>时分复用<br> 由于试验台上的输出端口不够用了，所以为了添加数码管功能，我们引入了时分复用的概念，即利用led点阵灭的那一瞬间将数码管点亮，这样既不会影响led点阵也可以实现点亮数码管。</li>
</ol>
<h2 id="采用的主要技术，遇到的难点和解决方法"><a href="#采用的主要技术，遇到的难点和解决方法" class="headerlink" title="采用的主要技术，遇到的难点和解决方法"></a>采用的主要技术，遇到的难点和解决方法</h2><ol>
<li><p>led点阵驱动<br> led点阵驱动提供了make_it_red、make_it_green、make_it_dark等底层方法来供上层控制led点阵的缓冲区内容，而led点阵驱动的硬件交互部分又通过读取缓冲区的内容来按照用户设想的方式亮灯。</p>
<ol>
<li>难点<br> 操作内存与硬件底层相衔接的问题。即如何方便的在软件层面上控制底层led亮。</li>
<li>解决方法<br> 引入了缓冲区的概念，系统存在两个led点阵的缓冲区，分别为ren_buffer和green_buffer，分别用来存储led点阵上灯亮的信息，这两个缓冲区都为8字节的数据，其中每一个比特控制每一个灯的亮的情况，利用这两个缓冲区就可以将led灯亮的信息存储在内存中，led底层控制模块只需要读取这两个内存区就可以将led点阵按预设的点亮了。</li>
<li>难点<br> 没有足够的端口点亮数码管</li>
<li>解决方法<br> 引用了时分复用的概念，将led点阵和数码管点亮的过程时分复用，解决了输出端口不够的问题。由于每一次led点阵点亮过后，存在一段时间led点阵的所有列信息为零，所以此时复用使用的8255PA连接数码管的段码显示，就可以利用有限的端口点亮数码管了。</li>
</ol>
</li>
<li><p>IO输入控制<br> IO输入控制负责定时的读取外设的输入信息，并且将其信息存储到内存中的缓冲区。</p>
<ol>
<li>难点<br> 如何定时的获取输入内容</li>
<li>解决方法<br> 使用8253设置定时中断连接在IRQ10上，由此可以实现定时的扫描键盘等外设的输入，键盘输入程序中使用BIOS提供的16号中断获取键盘输入数据。</li>
<li>难点<br> 如何在将外设的输入存储到内存中。</li>
<li>解决方法<br> 以键盘为例，在内存中开辟一个键盘输入的缓冲区，keyboard_input，其为16位的字，低1位到第9位存储了1-9按键是否被按下的信息。10-13存储WASD按键的信息。</li>
</ol>
</li>
<li><p>时间同步<br> 程序需要一个全局的同步时间量来控制每一个模块进行同步操作。</p>
<ol>
<li>难点<br> 如何获取当前时间呢。</li>
<li>解决方法<br> 在上文提到的额中断程序中加上时间量处理，即每一次中断将全局的时间同步量加一。</li>
</ol>
</li>
<li><p>状态机<br> 整个程序就是一个巨大的状态机。</p>
<ol>
<li>难点<br> 控制每一个状态的转换</li>
<li>解决方法<br> 使用一个缓冲区status来存储当前状态信息，程序利用该内存数据进行状态的转移。</li>
</ol>
</li>
</ol>
<h2 id="实现的主要功能和系统结构"><a href="#实现的主要功能和系统结构" class="headerlink" title="实现的主要功能和系统结构"></a>实现的主要功能和系统结构</h2><h3 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h3><ol>
<li><p>状态机。<br> 整个程序就是一个巨大的状态机。使用一个缓冲区status来存储当前状态信息，程序利用该内存数据进行状态的转移。</p>
</li>
<li><p>键盘输入。<br> 读取键盘输入并存储</p>
</li>
<li><p>点亮数码管。<br> 将游戏的得分信息在使用数码管进行显示。</p>
</li>
<li><p>控制led点阵任一灯的亮暗。</p>
</li>
<li><p>控制led点阵按预定信息亮。</p>
</li>
<li><p>贪吃蛇主体程序</p>
</li>
<li><p>输入信息处理程序</p>
</li>
<li><p>时间同步程序</p>
</li>
</ol>
<h3 id="系统结构"><a href="#系统结构" class="headerlink" title="系统结构"></a>系统结构</h3><p>时间同步程序为所有的程序提供一个时间的基本量，中断程序为负责定时读取输入和更新时间同步量，向上提供输入和同步，状态处理模块负责读取输入信息和状态信息进行状态的控制操作。在进入贪吃蛇主体程序之后，程序通过读取外设的输入信息控制贪吃蛇的移动，并通过贪吃蛇的逻辑控制来控制贪吃蛇的状态信息，并且实时的调用led点阵来动态显示贪吃蛇的位置以及使用数码管动态显示贪吃蛇得分信息。</p>
<h2 id="相关技术说明"><a href="#相关技术说明" class="headerlink" title="相关技术说明"></a>相关技术说明</h2><ol>
<li><p>缓冲区<br> 程序的所有所欲信息和状态都存储在缓冲区中，功能之间上下游分别负责存入和读取改变缓冲区，由此来驱动程序的运行。</p>
 <figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;红色   颜色是通过列线进行输出的</span></span><br><span class="line">red_buffer   <span class="keyword">byte </span><span class="number">8</span> dup(<span class="number">0</span>)</span><br><span class="line"><span class="comment">;绿色</span></span><br><span class="line">green_buffer <span class="keyword">byte </span><span class="number">8</span> dup(<span class="number">0</span>)</span><br><span class="line"><span class="comment">;infrared_input_buffer  存储红外线输入的缓冲区  每一个bit可以自由定义其含义</span></span><br><span class="line">infrared_input_buffer word <span class="number">0</span></span><br><span class="line"><span class="comment">;keyboard_input_buffer 存储键盘输入的缓冲区  每一个bit可以自由定义其含义</span></span><br><span class="line">keyboard_input_buffer word <span class="number">0</span></span><br><span class="line"><span class="comment">;Status buffer 状态缓冲区，用来存放程序运行的各种状态</span></span><br><span class="line">status_buffer word <span class="number">0</span></span><br><span class="line"><span class="comment">;时间缓冲区，负责提供同步信息 由中断程序每隔10ms加一</span></span><br><span class="line"><span class="keyword">sync_time_buffer </span>word <span class="number">0</span></span><br><span class="line"><span class="comment">;蛇身位置 不包含蛇头 蛇的每一个位置需要两个字节，8*8*2=128B</span></span><br><span class="line">snake_body_buffer <span class="keyword">byte </span><span class="number">128</span> dup(<span class="number">0</span>)</span><br><span class="line"><span class="comment">;蛇身的长度，不包括蛇头，也是当前的分数</span></span><br><span class="line">snake_body_length word <span class="number">0</span></span><br><span class="line"><span class="comment">;蛇头位置</span></span><br><span class="line">snake_head_position_x <span class="keyword">byte </span><span class="number">0</span></span><br><span class="line">snake_head_position_y <span class="keyword">byte </span><span class="number">0</span></span><br><span class="line"><span class="comment">;蛇尾位置</span></span><br><span class="line">snake_tail_position_x <span class="keyword">byte </span><span class="number">0</span></span><br><span class="line">snake_tail_position_y <span class="keyword">byte </span><span class="number">0</span></span><br><span class="line"><span class="comment">;食物位置</span></span><br><span class="line">food_x <span class="keyword">byte </span><span class="number">0</span></span><br><span class="line">food_y <span class="keyword">byte </span><span class="number">0</span></span><br><span class="line"><span class="comment">;是否吃了食物 0:没有 1:吃了</span></span><br><span class="line">food_eaten <span class="keyword">byte </span><span class="number">0</span></span><br><span class="line"><span class="comment">;碰撞与否</span></span><br><span class="line">collision <span class="keyword">byte </span><span class="number">0</span></span><br><span class="line"><span class="comment">;蛇的前近方向 2:上 0：下 2;左 1：右</span></span><br><span class="line">snake_direction <span class="keyword">byte </span><span class="number">0</span></span><br><span class="line"><span class="comment">;保存原中断程序入口</span></span><br><span class="line">int_<span class="symbol">0b</span>_seg word <span class="number">0</span></span><br><span class="line">int_<span class="symbol">0b</span>_off word <span class="number">0</span></span><br><span class="line"><span class="comment">;蛇的时间量，每经过100个全局时间量 加一，即蛇每1s移动一次 </span></span><br><span class="line">snake_time word <span class="number">0</span></span><br><span class="line"><span class="comment">;数码管</span></span><br><span class="line">ledtb <span class="keyword">byte </span><span class="number">3</span>fh,<span class="number">06</span>h,<span class="number">5</span>bh,<span class="number">4</span>fh,<span class="number">66</span>h,<span class="number">6</span>dh,<span class="number">7</span>dh,<span class="number">07</span>h,<span class="number">7</span>fh,<span class="number">6</span>fh</span><br><span class="line"><span class="comment">;得分（当前长度减去初始长度）存储  分别存储四个数码管的数字</span></span><br><span class="line">lednum <span class="keyword">byte </span><span class="number">4</span> dup(<span class="number">0</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>状态机。<br> 整个程序就是一个巨大的状态机。使用一个缓冲区status来存储当前状态信息，程序利用该内存数据进行状态的转移。</p>
</li>
<li><p>IO输入控制<br> IO输入控制负责定时的读取外设的输入信息，并且将其信息存储到内存中的缓冲区。<br> 使用8253设置定时中断连接在IRQ10上，由此可以实现定时的扫描键盘等外设的输入，键盘输入程序中使用BIOS提供的16号中断获取键盘输入数据。在内存中开辟一个键盘输入的缓冲区，keyboard_input，其为16位的字，低1位到第9位存储了1-9按键是否被按下的信息。10-13存储WASD按键的信息。</p>
</li>
<li><p>led点阵驱动<br> led点阵驱动提供了make_it_red、make_it_green、make_it_dark等底层方法来供上层控制led点阵的缓冲区内容，而led点阵驱动的硬件交互部分又通过读取缓冲区的内容来按照用户设想的方式亮灯。系统存在两个led点阵的缓冲区，分别为ren_buffer和green_buffer，分别用来存储led点阵上灯亮的信息，这两个缓冲区都为8字节的数据，其中每一个比特控制每一个灯的亮的情况，利用这两个缓冲区就可以将led灯亮的信息存储在内存中，led底层控制模块只需要读取这两个内存区就可以将led点阵按预设的点亮了。将led点阵和数码管点亮的过程时分复用，解决了输出端口不够的问题。由于每一次led点阵点亮过后，存在一段时间led点阵的所有列信息为零，所以此时复用使用的8255PA连接数码管的段码显示，就可以利用有限的端口点亮数码管了。</p>
</li>
</ol>
<h2 id="总结和体会"><a href="#总结和体会" class="headerlink" title="总结和体会"></a>总结和体会</h2><p>计算机领域的知识都是相通的，之前在操作系统学到了复用的概念于是在本次实验中就利用复用解决了输出端口不够的问题。还有缓冲区的概念和封装的和概念。程序将分散的功能封装为一个一个小模块，使得程序的调用更加方便了。缓冲区为个模块提供信息交互的通道。</p>
<p>计算机知识博大精深，要好好学习。不要沉迷于上层技术，其实底层原理是更加令人着迷的，只要学好了计算机的底层原理，使用计算机底层原理的方式进行思考问题往往会获得意想不到的结果。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://myblog.cuimouren.cn/2021/07/13/cmake-%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="崔文耀">
      <meta itemprop="description" content="Hello, here is wenyao's space, how do you come in???">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="这里是文耀的space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="../../2021/07/13/cmake-%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">cmake 使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-13 13:47:11" itemprop="dateCreated datePublished" datetime="2021-07-13T13:47:11+08:00">2021-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-19 20:20:00" itemprop="dateModified" datetime="2021-07-19T20:20:00+08:00">2021-07-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/tools/" itemprop="url" rel="index"><span itemprop="name">tools</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/tools/cmake/" itemprop="url" rel="index"><span itemprop="name">cmake</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CMmake"><a href="#CMmake" class="headerlink" title="CMmake"></a>CMmake</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>简单来讲，cmake是一个跨平台的makefile生成器。大型项目的额makefile实在是太繁琐了。学习cmake就是在学习其语法。一般来讲，只有在使用c/c++做一个大项目的时候才用得到cmake</p>
<h2 id="基本命令简介"><a href="#基本命令简介" class="headerlink" title="基本命令简介"></a>基本命令简介</h2><h3 id="project"><a href="#project" class="headerlink" title="project"></a>project</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PROJECT(&lt;projectname&gt; <span class="selector-attr">[CXX]</span> <span class="selector-attr">[C]</span> <span class="selector-attr">[Java]</span>)</span><br></pre></td></tr></table></figure>

<p>指定生成项目的名字，可选项目语言（默认位全选）<br>同时 cmake 系统也帮助我们预定义了<br>PROJECT_BINARY_DIR 指向生成的项目的路径（build） 和<br>PROJECT_SOURCE_DIR  指向项目源文件的路径(source)</p>
<h3 id="MESSAGE"><a href="#MESSAGE" class="headerlink" title="MESSAGE"></a>MESSAGE</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">MESSAGE</span><span class="params">([SEND_ERROR | STATUS | FATAL_ERROR] <span class="string">&quot;message to display&quot;</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>这个指令用于向终端输出用户定义的信息，包含了三种类型:</p>
<ol>
<li>SEND_ERROR，产生错误，生成过程被跳过。</li>
<li>SATUS，输出前缀为—的信息。</li>
<li>FATAL_ERROR，立即终止所有 cmake 过程. </li>
</ol>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MESSAGE</span>(STATUS <span class="string">&quot;build &quot;</span> <span class="variable">$&#123;PROJECT_BINARY_DIR&#125;</span> <span class="string">&quot; source &quot;</span> <span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="SET"><a href="#SET" class="headerlink" title="SET"></a>SET</h3><p>显式地定义变量</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor">SET(SRC_LIST <span class="params">main</span>.<span class="params">c</span> <span class="params">t1</span>.<span class="params">c</span> <span class="params">t2</span>.<span class="params">c</span>)</span></span><br></pre></td></tr></table></figure>

<p>将 main.c t1.c t2.c 定义为源文件列表</p>
<h3 id="ADD-EXECUTABLE"><a href="#ADD-EXECUTABLE" class="headerlink" title="ADD_EXECUTABLE"></a>ADD_EXECUTABLE</h3><p>生成可执行文件</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">ADD_EXECUTABLE</span><span class="params">(hello $&#123;SRC_LIST&#125;)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="ADD-SUBDIRECTORY"><a href="#ADD-SUBDIRECTORY" class="headerlink" title="ADD_SUBDIRECTORY"></a>ADD_SUBDIRECTORY</h3><p>位当前目录添加一个子目录 </p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor">ADD_SUBDIRECTORY(<span class="params">source_dir</span> [<span class="params">binary_dir</span>] [EXCLUDE_FROM_ALL])</span></span><br></pre></td></tr></table></figure>

<h3 id="INSTALL"><a href="#INSTALL" class="headerlink" title="INSTALL"></a>INSTALL</h3><p>CMAKE_INSTALL_PREFIX</p>
<p>DESTINATION 定义了安装的路径，如果路径以/开头，那么指的是绝对路径，这时候<br>CMAKE_INSTALL_PREFIX 其实就无效了。如果你希望使用 CMAKE_INSTALL_PREFIX 来定义安装路径，就要写成相对路径，即不要以/开头，那么安装后的路径就是<br>${CMAKE_INSTALL_PREFIX}/&lt;DESTINATION 定义的路径&gt;</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSTALL</span>(TARGETS myrun mylib mystaticlib</span><br><span class="line">RUNTIME DESTINATION bin</span><br><span class="line">LIBRARY DESTINATION lib</span><br><span class="line">ARCHIVE DESTINATION libstatic )</span><br><span class="line"></span><br><span class="line">上面的例子会将： </span><br><span class="line">可执行二进制 myrun 安装到<span class="variable">$&#123;CMAKE_INSTALL_PREFIX&#125;</span>/bin 目录 </span><br><span class="line">动态库 libmylib 安装到<span class="variable">$&#123;CMAKE_INSTALL_PREFIX&#125;</span>/lib 目录 </span><br><span class="line">静态库 libmystaticlib 安装到<span class="variable">$&#123;CMAKE_INSTALL_PREFIX&#125;</span>/libstatic 目录</span><br></pre></td></tr></table></figure>

<p>普通文件的安装</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INSTALL(FILES files... DESTINATION &lt;dir&gt;</span><br><span class="line"> <span class="comment">[PERMISSIONS permissions...]</span></span><br><span class="line"> <span class="comment">[CONFIGURATIONS <span class="comment">[Debug|Release|...]</span>]</span></span><br><span class="line"> <span class="comment">[COMPONENT &lt;component&gt;]</span></span><br><span class="line"> <span class="comment">[RENAME &lt;name&gt;]</span> <span class="comment">[OPTIONAL]</span>)</span><br></pre></td></tr></table></figure>


<h3 id="ADD-LIBRARY"><a href="#ADD-LIBRARY" class="headerlink" title="ADD_LIBRARY"></a>ADD_LIBRARY</h3><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ADD_LIBRARY(libname [<span class="keyword">SHARED</span>|<span class="keyword">STATIC</span>|<span class="keyword">MODULE</span>]</span><br><span class="line"> [EXCLUDE_FROM_ALL]</span><br><span class="line"> source1 source2 ... sourceN)</span><br></pre></td></tr></table></figure>


<h3 id="SET-TARGET-PROPERTIES"><a href="#SET-TARGET-PROPERTIES" class="headerlink" title="SET_TARGET_PROPERTIES"></a>SET_TARGET_PROPERTIES</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">SET_TARGET_PROPERTIES</span>(target<span class="number">1</span> target<span class="number">2</span> ...</span><br><span class="line"> <span class="attribute">PROPERTIES</span> prop<span class="number">1</span> value<span class="number">1</span></span><br><span class="line"> <span class="attribute">prop2</span> value<span class="number">2</span> ...)</span><br></pre></td></tr></table></figure>

<h3 id="GET-TARGET-PROPERTY"><a href="#GET-TARGET-PROPERTY" class="headerlink" title="GET_TARGET_PROPERTY"></a>GET_TARGET_PROPERTY</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">与他对应的指令是：</span><br><span class="line"><span class="function"><span class="title">GET_TARGET_PROPERTY</span><span class="params">(VAR target property)</span></span></span><br><span class="line">具体用法如下例，我们向 lib/CMakeListst<span class="selector-class">.txt</span> 中添加：</span><br><span class="line"><span class="function"><span class="title">GET_TARGET_PROPERTY</span><span class="params">(OUTPUT_VALUE hello_static OUTPUT_NAME)</span></span></span><br><span class="line">MESSAGE(STATUS “This is the hello_static</span><br><span class="line">OUTPUT_NAME:”$&#123;OUTPUT_VALUE&#125;)</span><br><span class="line">如果没有这个属性定义，则返回 NOTFOUND.</span><br></pre></td></tr></table></figure>

<h3 id="INCLUDE-DIRECTORIES"><a href="#INCLUDE-DIRECTORIES" class="headerlink" title="INCLUDE_DIRECTORIES"></a>INCLUDE_DIRECTORIES</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">现在我们在 src/<span class="module-access"><span class="module"><span class="identifier">CMakeLists</span>.</span></span>txt 中添加一个头文件搜索路径，方式很简单，加入：</span><br><span class="line"><span class="constructor">INCLUDE_DIRECTORIES(<span class="operator">/</span><span class="params">usr</span><span class="operator">/</span><span class="params">include</span><span class="operator">/</span><span class="params">hello</span>)</span></span><br></pre></td></tr></table></figure>

<h3 id="LINK-DIRECTORIES"><a href="#LINK-DIRECTORIES" class="headerlink" title="LINK_DIRECTORIES"></a>LINK_DIRECTORIES</h3><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">LINK_DIRECTORIES</span>(<span class="params">directory1 directory2 ...</span>)</span></span><br></pre></td></tr></table></figure>

<p>这个指令非常简单，添加非标准的共享库搜索路径，比如，在工程内部同时存在共享库和可 执行二进制，在编译时就需要指定一下这些共享库的路径。这个例子中我们没有用到这个指 令。</p>
<h3 id="TARGET-LINK-LIBRARIES"><a href="#TARGET-LINK-LIBRARIES" class="headerlink" title="TARGET_LINK_LIBRARIES"></a>TARGET_LINK_LIBRARIES</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">TARGET_LINK_LIBRARIES</span>(<span class="keyword">target</span> library1</span><br><span class="line"> &lt;debug | optimized&gt; library2</span><br><span class="line"> ...)</span><br><span class="line">这个指令可以用来为 <span class="keyword">target</span> 添加需要链接的共享库，本例中是一个可执行文件，但是同样</span><br><span class="line">可以用于为自己编写的共享库添加共享库链接。</span><br></pre></td></tr></table></figure>






<h2 id="cmake-学习-assimp的经验"><a href="#cmake-学习-assimp的经验" class="headerlink" title="cmake 学习 assimp的经验"></a>cmake 学习 assimp的经验</h2><h3 id="项目文件目录"><a href="#项目文件目录" class="headerlink" title="项目文件目录"></a>项目文件目录</h3><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">code</span><br><span class="line">    <span class="comment">--项目的各种代码文件夹</span></span><br><span class="line">    <span class="comment">--CMakeLists.txt</span></span><br><span class="line">contrib</span><br><span class="line">    <span class="comment">--各种依赖的文件夹</span></span><br><span class="line">doc</span><br><span class="line"><span class="built_in">include</span></span><br><span class="line">    <span class="comment">--项目的头文件，对外的接口</span></span><br><span class="line">samples</span><br><span class="line">tests</span><br><span class="line">tools</span><br><span class="line">readme.md</span><br><span class="line">CMakeLists.txt</span><br></pre></td></tr></table></figure>

<p>特点：</p>
<ol>
<li>对别的项目的依赖不使用自己编译好的lib或者dll，而是直接使用源文件。估计编译assimp的时候把这些源文件都编译了一遍</li>
<li>code文件夹就放自己的代码。</li>
<li>include文件夹就负责对外提供接口。</li>
<li>只使用两个CMakeLists.txt,根目录下的负责项目的整体信息描述，code目录下的负责对文件的编译。</li>
</ol>
<h3 id="cmake-编写"><a href="#cmake-编写" class="headerlink" title="cmake 编写"></a>cmake 编写</h3><p>太复杂了，我现在并看不懂。但并不像我这样每一个模块编写一个CMakeLists.txt进行cmake，而是根目录下的负责项目的整体信息描述，code目录下的负责对文件的编译。</p>
<h3 id="项目编译"><a href="#项目编译" class="headerlink" title="项目编译"></a>项目编译</h3><ol>
<li>首先按照上面的文件目录进行编排。</li>
<li>编写CMakeLists.txt 文件<ol>
<li>最好编译成动态链接库，不然没有办法将项目的静态依赖库lib文件包含在内。</li>
<li>若项目的依赖中存在动态库，比如assimp 时，就没办法将其包含在内了，只能让用户显式地使用assimp.</li>
</ol>
</li>
<li>将项目的头文件列举出来保存到include文件夹中，这里面的就是提供给用户的接口，将不想提供给用户的接口删除即可。</li>
<li>记得cmake中进行install，将所有需要提供给用户的文件全部放在最显眼的地方。</li>
</ol>
<h3 id="CMakeLists-txt-编写"><a href="#CMakeLists-txt-编写" class="headerlink" title="CMakeLists.txt 编写"></a>CMakeLists.txt 编写</h3><p>我现在对编译有关的知识了解甚少，所以现在只能使用一些最基础的东西，日后会对编译有更深得了解。</p>
<ol>
<li><p>cmake的最下版本要求</p>
</li>
<li><p>确定项目的名称</p>
</li>
<li><p>确定项目的目录安排</p>
</li>
<li><p>确定项目的包含目录和库目录</p>
</li>
<li><p>确定项目生成目标位置</p>
</li>
<li><p>确定项目的额依赖</p>
</li>
<li><p>确定目标使用的文件并安排成组</p>
</li>
<li><p>确定目标工程的筛选器</p>
</li>
<li><p>编译项目</p>
</li>
<li><p>安装项目</p>
</li>
</ol>
<h3 id="Demo-list"><a href="#Demo-list" class="headerlink" title="Demo list"></a>Demo list</h3><h2 id="XYY-Game-Engine-的构建示例"><a href="#XYY-Game-Engine-的构建示例" class="headerlink" title="XYY_Game_Engine 的构建示例"></a>XYY_Game_Engine 的构建示例</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMake 最低版本号要求</span></span><br><span class="line">cmake_minimum_required (VERSION <span class="number">3.20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 项目信息</span></span><br><span class="line">project(XYY_Game_Engine)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#变量设置   主要是目录变量</span></span><br><span class="line"><span class="comment">#CMAKE_INSTALL_PREFIX</span></span><br><span class="line">set(CMAKE_INSTALL_PREFIX <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>)</span><br><span class="line"><span class="comment">#code目录</span></span><br><span class="line">set(CODE_ROOT_PATH <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/code/</span>)</span><br><span class="line"><span class="comment">#build目录</span></span><br><span class="line">set(BUILD_PATH <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/build/</span>)</span><br><span class="line"><span class="comment">#存放生成的lib的目录</span></span><br><span class="line">set(LIB_PATH <span class="variable">$&#123;BUILD_PATH&#125;</span><span class="regexp">/../</span>lib/)</span><br><span class="line"><span class="comment">#存放生成的dll的目录</span></span><br><span class="line">set(DLL_PATH <span class="variable">$&#123;BUILD_PATH&#125;</span><span class="regexp">/../</span>dll/)</span><br><span class="line"><span class="comment">#编译所需包含目录</span></span><br><span class="line">set(INCLUDE_PATH_CODE <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/include/</span>)</span><br><span class="line">set(INCLUDE_PATH_CONTRIB <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/contrib/i</span>nclude/)</span><br><span class="line"><span class="comment">#编译所需库目录</span></span><br><span class="line">set(LIBRARY_PATH_CONTRIB <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/contrib/</span>lib/)</span><br><span class="line"><span class="comment">#设置test路径</span></span><br><span class="line">set(TEST_PATH <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/build/</span>test/)</span><br><span class="line"><span class="comment">#指定程序的包含目录 库目录</span></span><br><span class="line"><span class="comment">#引用目录</span></span><br><span class="line"><span class="comment">#INCLUDE_DIRECTORIES($&#123;INCLUDE_PATH_CODE&#125;)</span></span><br><span class="line">INCLUDE_DIRECTORIES(<span class="variable">$&#123;INCLUDE_PATH_CONTRIB&#125;</span>)</span><br><span class="line">INCLUDE_DIRECTORIES(<span class="variable">$&#123;TEST_PATH&#125;</span>/include)</span><br><span class="line"><span class="comment">#库目录 将生成的lib 目录也包含在内，为了给test使用</span></span><br><span class="line">LINK_DIRECTORIES(<span class="variable">$&#123;LIBRARY_PATH_CONTRIB&#125;</span>)</span><br><span class="line">LINK_DIRECTORIES(<span class="variable">$&#123;LIB_PATH&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置目标的属性 </span></span><br><span class="line"><span class="keyword">function</span>(SetDefaultTargetProperties target)</span><br><span class="line">	<span class="comment">#程序生成文件的目录   </span></span><br><span class="line">	set_target_properties(<span class="variable">$&#123;target&#125;</span> PROPERTIES</span><br><span class="line">		ARCHIVE_OUTPUT_DIRECTORY <span class="variable">$&#123;LIB_PATH&#125;</span></span><br><span class="line">		LIBRARY_OUTPUT_DIRECTORY <span class="variable">$&#123;LIB_PATH&#125;</span></span><br><span class="line">		RUNTIME_OUTPUT_DIRECTORY <span class="variable">$&#123;DLL_PATH&#125;</span></span><br><span class="line">	)</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"><span class="comment">#MESSAGE(STATUS $&#123;LIB_PATH&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#code的编译  得到 XYY_Game_Engine.lib XYY_Game_Engine.dll </span></span><br><span class="line">add_subdirectory(<span class="variable">$&#123;CODE_ROOT_PATH&#125;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#放入 lib 文件夹</span></span><br><span class="line">INSTALL(TARGETS</span><br><span class="line">    XYY_Game_Engine</span><br><span class="line">    LIBRARY DESTINATION</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/lib/</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#放入 bin 中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(EXISTS   <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/dll/</span>Debug/XYY_Game_Engine.dll)</span><br><span class="line">INSTALL(FILES</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/dll/</span>Debug/XYY_Game_Engine.dll</span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/bin/</span></span><br><span class="line">)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(EXISTS    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/dll/</span>assimp-vc142-mt.dll)</span><br><span class="line">INSTALL(FILES</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/dll/</span>assimp-vc142-mt.dll</span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/bin</span><br><span class="line">)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#对 test 增加支持   dll  release  test 所有的引用都来原来自include中的</span></span><br><span class="line">INSTALL(FILES</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/bin/</span>assimp-vc142-mt.dll</span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/build/</span>test/Release</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">INSTALL(FILES</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/bin/</span>XYY_Game_Engine.dll</span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/build/</span>test/Release</span><br><span class="line">)</span><br><span class="line">INSTALL(FILES</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/bin/</span>assimp-vc142-mt.dll</span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/build/</span>test/Debug</span><br><span class="line">)</span><br><span class="line">INSTALL(FILES</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/bin/</span>XYY_Game_Engine.dll</span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/build/</span>test/Debug</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">FILE(</span><br><span class="line">    GLOB_RECURSE Header_Driver</span><br><span class="line">    <span class="variable">$&#123;CODE_ROOT_PATH&#125;</span><span class="regexp">/Driver/</span>*.hpp</span><br><span class="line">)</span><br><span class="line">FILE(</span><br><span class="line">    GLOB_RECURSE Header_Driver_LocalDriver</span><br><span class="line">    <span class="variable">$&#123;CODE_ROOT_PATH&#125;</span><span class="regexp">/Driver/</span>LocalDriver/*.h</span><br><span class="line">)</span><br><span class="line">FILE(</span><br><span class="line">    GLOB_RECURSE Header_Driver_Global</span><br><span class="line">    <span class="variable">$&#123;CODE_ROOT_PATH&#125;</span><span class="regexp">/Driver/</span>GlobalDriver/*.h</span><br><span class="line">)</span><br><span class="line"><span class="comment">#SRC_Element</span></span><br><span class="line">FILE(</span><br><span class="line">    GLOB_RECURSE Header_Element</span><br><span class="line">    <span class="variable">$&#123;CODE_ROOT_PATH&#125;</span><span class="regexp">/Element/</span>*.h</span><br><span class="line">)</span><br><span class="line"><span class="comment">#SRC_Resource</span></span><br><span class="line">FILE(</span><br><span class="line">    GLOB_RECURSE Header_Resource</span><br><span class="line">    <span class="variable">$&#123;CODE_ROOT_PATH&#125;</span><span class="regexp">/Resource/</span>*.h</span><br><span class="line">)</span><br><span class="line"><span class="comment">#SRC_Resource</span></span><br><span class="line">FILE(</span><br><span class="line">    GLOB_RECURSE Header_Scene</span><br><span class="line">    <span class="variable">$&#123;CODE_ROOT_PATH&#125;</span><span class="regexp">/Scene/</span>*.h</span><br><span class="line">)</span><br><span class="line"><span class="comment">#SRC_Sync</span></span><br><span class="line">FILE(</span><br><span class="line">    GLOB_RECURSE Header_Sync</span><br><span class="line">    <span class="variable">$&#123;CODE_ROOT_PATH&#125;</span><span class="regexp">/Sync/</span>*.h</span><br><span class="line">)</span><br><span class="line">INSTALL(</span><br><span class="line">    FILES</span><br><span class="line">    <span class="variable">$&#123;Header_Driver&#125;</span></span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;INCLUDE_PATH_CODE&#125;</span><span class="regexp">/Driver/</span></span><br><span class="line">)</span><br><span class="line">INSTALL(</span><br><span class="line">    FILES</span><br><span class="line">    <span class="variable">$&#123;Header_Driver_LocalDriver&#125;</span></span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;INCLUDE_PATH_CODE&#125;</span><span class="regexp">/Driver/</span>LocalDriver/</span><br><span class="line">)</span><br><span class="line">INSTALL(</span><br><span class="line">    FILES</span><br><span class="line">    <span class="variable">$&#123;Header_Driver_Global&#125;</span></span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;INCLUDE_PATH_CODE&#125;</span><span class="regexp">/Driver/</span>GlobalDriver/</span><br><span class="line">)</span><br><span class="line">INSTALL(</span><br><span class="line">    FILES</span><br><span class="line">    <span class="variable">$&#123;Header_Element&#125;</span></span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;INCLUDE_PATH_CODE&#125;</span><span class="regexp">/Element/</span></span><br><span class="line">)</span><br><span class="line">INSTALL(</span><br><span class="line">    FILES</span><br><span class="line">    <span class="variable">$&#123;Header_Resource&#125;</span></span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;INCLUDE_PATH_CODE&#125;</span><span class="regexp">/Resource/</span></span><br><span class="line">)</span><br><span class="line">INSTALL(</span><br><span class="line">    FILES</span><br><span class="line">    <span class="variable">$&#123;Header_Scene&#125;</span></span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;INCLUDE_PATH_CODE&#125;</span><span class="regexp">/Scene/</span></span><br><span class="line">)</span><br><span class="line">INSTALL(</span><br><span class="line">    FILES</span><br><span class="line">    <span class="variable">$&#123;Header_Sync&#125;</span></span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;INCLUDE_PATH_CODE&#125;</span><span class="regexp">/Sync/</span></span><br><span class="line">)</span><br><span class="line">INSTALL(</span><br><span class="line">    DIRECTORY</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/code/</span>Scxmlexample</span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/include/</span></span><br><span class="line">)</span><br><span class="line">INSTALL(</span><br><span class="line">    DIRECTORY</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/code/</span>resources</span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/include/</span></span><br><span class="line">)</span><br><span class="line">INSTALL(</span><br><span class="line">    DIRECTORY</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/code/</span>GLSL</span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/include/</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># example </span></span><br><span class="line">INSTALL(</span><br><span class="line">    DIRECTORY</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/include/</span>Scxmlexample</span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;TEST_PATH&#125;</span>/</span><br><span class="line">)</span><br><span class="line"><span class="comment"># resources</span></span><br><span class="line">INSTALL(</span><br><span class="line">    DIRECTORY</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><span class="regexp">/include/</span>resources</span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;TEST_PATH&#125;</span>/</span><br><span class="line">)</span><br><span class="line"><span class="comment"># header</span></span><br><span class="line">INSTALL(</span><br><span class="line">    DIRECTORY</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/include</span><br><span class="line">    DESTINATION</span><br><span class="line">    <span class="variable">$&#123;TEST_PATH&#125;</span>/</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#target 测试</span></span><br><span class="line">add_subdirectory(test)</span><br></pre></td></tr></table></figure>

<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#code </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#code 中的所有文件</span></span><br><span class="line"><span class="keyword">FILE</span>(GLOB_RECURSE SOURCE_CODE       </span><br><span class="line">    Driver/*</span><br><span class="line">    Driver/LocalDriver/*</span><br><span class="line">    Driver/GlobalDriver/*</span><br><span class="line">    Element/*</span><br><span class="line">    Resource/*</span><br><span class="line">    Scene/*</span><br><span class="line">    Sync/*</span><br><span class="line">    <span class="variable">$&#123;INCLUDE_PATH_CONTRIB&#125;</span>/*.c</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#组织 file </span></span><br><span class="line"><span class="comment">#Driver</span></span><br><span class="line"><span class="keyword">FILE</span>(</span><br><span class="line">    GLOB_RECURSE SRC_Driver</span><br><span class="line">    Driver/*.hpp</span><br><span class="line">)</span><br><span class="line"><span class="keyword">source_group</span>(Driver FILES <span class="variable">$&#123;SRC_Driver&#125;</span>)</span><br><span class="line"><span class="keyword">FILE</span>(</span><br><span class="line">    GLOB_RECURSE SRC_Driver_LocalDriver</span><br><span class="line">    Driver/LocalDriver/*</span><br><span class="line">)</span><br><span class="line"><span class="keyword">source_group</span>(Driver//LocalDriver FILES <span class="variable">$&#123;SRC_Driver_LocalDriver&#125;</span>)</span><br><span class="line"><span class="keyword">FILE</span>(</span><br><span class="line">    GLOB_RECURSE SRC_Driver_Global</span><br><span class="line">    Driver/GlobalDriver/*</span><br><span class="line">)</span><br><span class="line"><span class="keyword">source_group</span>(Driver//GlobalDriver FILES <span class="variable">$&#123;SRC_Driver_Global&#125;</span>)</span><br><span class="line"><span class="comment">#SRC_Element</span></span><br><span class="line"><span class="keyword">FILE</span>(</span><br><span class="line">    GLOB_RECURSE SRC_Element</span><br><span class="line">    Element/*</span><br><span class="line">)</span><br><span class="line"><span class="keyword">source_group</span>(Element FILES <span class="variable">$&#123;SRC_Element&#125;</span>)</span><br><span class="line"><span class="comment">#SRC_Resource</span></span><br><span class="line"><span class="keyword">FILE</span>(</span><br><span class="line">    GLOB_RECURSE SRC_Resource</span><br><span class="line">    Resource/*</span><br><span class="line">)</span><br><span class="line"><span class="keyword">source_group</span>(Resource FILES <span class="variable">$&#123;SRC_Resource&#125;</span>)</span><br><span class="line"><span class="comment">#SRC_Resource</span></span><br><span class="line"><span class="keyword">FILE</span>(</span><br><span class="line">    GLOB_RECURSE SRC_Scene</span><br><span class="line">    Scene/*</span><br><span class="line">)</span><br><span class="line"><span class="keyword">source_group</span>(Scene FILES <span class="variable">$&#123;SRC_Scene&#125;</span>)</span><br><span class="line"><span class="comment">#SRC_Sync</span></span><br><span class="line"><span class="keyword">FILE</span>(</span><br><span class="line">    GLOB_RECURSE SRC_Sync</span><br><span class="line">    Sync/*</span><br><span class="line">)</span><br><span class="line"><span class="keyword">source_group</span>(Sync FILES <span class="variable">$&#123;SRC_Sync&#125;</span>)</span><br><span class="line"><span class="comment">#xml</span></span><br><span class="line"><span class="keyword">FILE</span>(</span><br><span class="line">    GLOB_RECURSE SRC_Scxmlexample</span><br><span class="line">    <span class="variable">$&#123;CODE_ROOT_PATH&#125;</span>/Scxmlexample/*.xml</span><br><span class="line">)</span><br><span class="line"><span class="keyword">source_group</span>(Scxmlexample FILES <span class="variable">$&#123;SRC_Scxmlexample&#125;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">FILE</span>(</span><br><span class="line">    GLOB DEPENDENCE_LIB</span><br><span class="line">    <span class="variable">$&#123;LIBRARY_PATH_CONTRIB&#125;</span>/*.lib</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成链接库</span></span><br><span class="line"><span class="keyword">add_library</span>(XYY_Game_Engine SHARED <span class="variable">$&#123;SOURCE_CODE&#125;</span> <span class="variable">$&#123;SRC_Scxmlexample&#125;</span>)</span><br><span class="line">SetDefaultTargetProperties(XYY_Game_Engine)</span><br><span class="line"><span class="comment">#  应该还要加上 opengl32.lib</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(XYY_Game_Engine   </span><br><span class="line">opengl32  </span><br><span class="line">glfw3.lib </span><br><span class="line">assimp-vc142-mt.lib  </span><br><span class="line">tinyxml.lib  </span><br><span class="line">kernel32.lib</span><br><span class="line">user32.lib</span><br><span class="line">gdi32.lib</span><br><span class="line">winspool.lib</span><br><span class="line">comdlg32.lib</span><br><span class="line">advapi32.lib</span><br><span class="line">shell32.lib</span><br><span class="line">ole32.lib</span><br><span class="line">oleaut32.lib</span><br><span class="line">uuid.lib</span><br><span class="line">odbc32.lib</span><br><span class="line">odbccp32.lib</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对于每一个项目，其相对路径的起始位置是 vs 那一对文件的位置</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#xml</span></span><br><span class="line"><span class="keyword">FILE</span>(</span><br><span class="line">    GLOB_RECURSE SRC_Scxmlexample_test</span><br><span class="line">    <span class="variable">$&#123;CODE_ROOT_PATH&#125;</span>/Scxmlexample/*.xml</span><br><span class="line">)</span><br><span class="line"><span class="keyword">source_group</span>(Scxmlexample FILES <span class="variable">$&#123;SRC_Scxmlexample_test&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#test1</span></span><br><span class="line"><span class="keyword">add_executable</span>(test1 test1.cpp <span class="variable">$&#123;SRC_Scxmlexample_test&#125;</span>)</span><br><span class="line"><span class="keyword">ADD_DEPENDENCIES</span>(test1 XYY_Game_Engine)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(test1 XYY_Game_Engine)</span><br><span class="line"></span><br><span class="line"><span class="comment">#test1</span></span><br><span class="line"><span class="keyword">add_executable</span>(test2 test2.cpp <span class="variable">$&#123;SRC_Scxmlexample_test&#125;</span>)</span><br><span class="line"><span class="keyword">ADD_DEPENDENCIES</span>(test1 XYY_Game_Engine)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(test2 XYY_Game_Engine)</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://myblog.cuimouren.cn/2021/07/10/XYY-Game-Engine-%E5%B0%81%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="崔文耀">
      <meta itemprop="description" content="Hello, here is wenyao's space, how do you come in???">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="这里是文耀的space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="../../2021/07/10/XYY-Game-Engine-%E5%B0%81%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">XYY Game Engine 封装和使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-10 22:32:10" itemprop="dateCreated datePublished" datetime="2021-07-10T22:32:10+08:00">2021-07-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-02 17:32:38" itemprop="dateModified" datetime="2021-09-02T17:32:38+08:00">2021-09-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/c/" itemprop="url" rel="index"><span itemprop="name">c++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="XYY-Game-Engine-封装和使用"><a href="#XYY-Game-Engine-封装和使用" class="headerlink" title="XYY Game Engine 封装和使用"></a>XYY Game Engine 封装和使用</h1><h2 id="c-封装"><a href="#c-封装" class="headerlink" title="c++封装"></a>c++封装</h2><p>将c++项目封装为一个动态链接库，向外只提供接口，这样不仅仅方便发行，更可以加快成程序运行的速度。将XYY项目封装的步骤如下：            </p>
<ol>
<li>将所有的声明定义为导出，以类作为示范。</li>
</ol>
<p>即将        </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XYY_GlobalDriver</span> :</span> <span class="keyword">public</span> XYY_Driver</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="keyword">int</span> tag;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>;						<span class="comment">// 初始化</span></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(XYY_SceneContent * sc)</span></span>;	<span class="comment">// 运行</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>更改为  </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> __<span class="title">declspec</span>(<span class="title">dllexport</span>) <span class="title">XYY_GlobalDriver</span> :</span> <span class="keyword">public</span> XYY_Driver</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="keyword">int</span> tag;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>;						<span class="comment">// 初始化</span></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(XYY_SceneContent * sc)</span></span>;	<span class="comment">// 运行</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>删除main函数，并写以下两个文件</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//XYY_Game_Engine.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> XYY_Game_Engine_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> XYY_Game_Engine_H</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> _declspec(dllexport) <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//XYY_Game_Engine.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;XYY_Game_Engine.h&gt;</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> _declspec(dllexport)<span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>更改解决方案类型为dll</li>
</ol>
<p><img src="/file/XYY-Game-Engine-%E5%B0%81%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/1.png" alt="dll"></p>
<ol start="4">
<li>将此处改为自己想要的</li>
</ol>
<p><img src="/file/XYY-Game-Engine-%E5%B0%81%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/2.png" alt="dll"></p>
<ol start="5">
<li><p>生成解决方案</p>
</li>
<li><p>在解决方案目录中即可找到</p>
</li>
</ol>
<p><img src="/file/XYY-Game-Engine-%E5%B0%81%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/3.png" alt="dll"></p>
<ol start="7">
<li><p>将项目的cpp文件删除，即将所有的实现删除只留下声明的接口,将刚刚插入的所有 __declspec(dllexport) 删除</p>
</li>
<li><p>打包发布。</p>
</li>
</ol>
<h2 id="动态链接库的使用"><a href="#动态链接库的使用" class="headerlink" title="动态链接库的使用"></a>动态链接库的使用</h2><ol>
<li>添加库目录和头文件目录以及添加对lib文件的依赖。</li>
</ol>
<p><img src="/file/XYY-Game-Engine-%E5%B0%81%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/4.png" alt="dll"><br><img src="/file/XYY-Game-Engine-%E5%B0%81%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/5.png" alt="dll"><br>添加对lib文件的依赖也可以使用这样的预处理指令：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">&quot;XYY_Game_Engine.lib&quot;</span>)</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>将dll文件放在项目的根目录下，或者放在和项目的解决方案exe的同目录。</p>
</li>
<li><p>示例,发现加载速度极快，因为所有的文件都是编译过的，但我不明白为什么加载也会加快。</p>
</li>
</ol>
<p><img src="/file/XYY-Game-Engine-%E5%B0%81%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/6.png" alt="dll"></p>
<h2 id="构建DLL项目规范"><a href="#构建DLL项目规范" class="headerlink" title="构建DLL项目规范"></a>构建DLL项目规范</h2><h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><ol>
<li><p>首先必须将声明和实现相分离。</p>
</li>
<li><p>项目在实现的时候就将code目录加入到<strong>包含目录</strong>中，即可以使用 #include &lt;file.h&gt; 自包</p>
</li>
<li><p>将所有使用到的代码全部放在code目录下，包括GLSL等，这样项目构建和项目使用就没有差别了。用户只需要将提供的code文件夹加入<strong>包含目录</strong>即可，当然，code文件夹是随意的，即为项目根目录也可。</p>
</li>
<li><p>提供项目本身代码 include 文件夹以及项目依赖dependence文件夹，用户需要把这两个文件夹放入包含目录中.</p>
</li>
<li><p>使用以下两种方法避免重复包含。推荐使用后一种。</p>
</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once </span></span><br></pre></td></tr></table></figure>
<p>或者 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//XYY_Game_Engine.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> XYY_Game_Engine_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> XYY_Game_Engine_H</span></span><br><span class="line"><span class="comment">//code</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li><strong>写好注释</strong></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://myblog.cuimouren.cn/2021/07/07/%E5%BE%AE%E6%9C%BA%E4%B8%8E%E6%B1%87%E7%BC%96%E6%8E%A5%E5%8F%A3%E5%AE%9E%E9%AA%8C%E5%BC%80%E9%A2%98%E6%8A%A5%E5%91%8A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="崔文耀">
      <meta itemprop="description" content="Hello, here is wenyao's space, how do you come in???">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="这里是文耀的space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="../../2021/07/07/%E5%BE%AE%E6%9C%BA%E4%B8%8E%E6%B1%87%E7%BC%96%E6%8E%A5%E5%8F%A3%E5%AE%9E%E9%AA%8C%E5%BC%80%E9%A2%98%E6%8A%A5%E5%91%8A/" class="post-title-link" itemprop="url">贪吃蛇街机小游戏开题报告</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-07 15:01:59" itemprop="dateCreated datePublished" datetime="2021-07-07T15:01:59+08:00">2021-07-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-18 17:18:53" itemprop="dateModified" datetime="2021-07-18T17:18:53+08:00">2021-07-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/uncategorized/" itemprop="url" rel="index"><span itemprop="name">uncategorized</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="开题报告"><a href="#开题报告" class="headerlink" title="开题报告"></a>开题报告</h1><h2 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h2><p>贪吃蛇街机小游戏是一款在8*8的LED显示灯上运行的贪吃蛇小游戏，通过红外线遥控器输入设备进行游戏控制，在LED显示灯上显示游戏画面，使用数码管显示当前得分，使用灯光和蜂鸣器营造游戏氛围。</p>
<h2 id="功能模块划分"><a href="#功能模块划分" class="headerlink" title="功能模块划分"></a>功能模块划分</h2><ul>
<li>游戏整体逻辑控制模块</li>
</ul>
<p>整个项目的入口，控制其他各个模块的调度。</p>
<ul>
<li>贪吃蛇逻辑控制模块</li>
</ul>
<p>贪吃蛇运行逻辑的控制，负责计算出下一秒贪吃蛇的状态（移动、增长、死亡）、食物位置的刷新、当前得分的计算等。</p>
<ul>
<li>LED显示控制模块</li>
</ul>
<p>将内容（游戏菜单、当前画面、）显示到8*8的LED灯上。</p>
<ul>
<li>全局时钟控制模块</li>
</ul>
<p>通过8253每10ms产生一个中断，用于控制游戏进程的同步。</p>
<ul>
<li>声音控制模块</li>
</ul>
<p>使用蜂鸣器产生游戏音效与背景音乐。</p>
<ul>
<li>灯光控制模块</li>
</ul>
<p>使用LED灯产生一些光效。</p>
<ul>
<li>数码管显示模块</li>
</ul>
<p>使用数码管显示出当前游戏的得分。</p>
<ul>
<li>红外线输入模块</li>
</ul>
<p>使用红外线输入，产生中断，控制贪吃蛇的运动。</p>
<h2 id="核心功能代码测试"><a href="#核心功能代码测试" class="headerlink" title="核心功能代码测试"></a>核心功能代码测试</h2><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; LED显示</span></span><br><span class="line">show_led proc</span><br><span class="line">    <span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">    <span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">    <span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">    <span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">;写入方式控制字</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">dx</span> , <span class="number">283h</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span> , <span class="number">80h</span></span><br><span class="line">    <span class="keyword">out</span> <span class="built_in">dx</span> , <span class="built_in">al</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">;逐列刷新 红  si控制红行 di控制绿行</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">si</span>,offset red_buffer <span class="comment">;控制每一列的红8行</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">di</span>,offset green_buffer <span class="comment">;控制每一列的绿8行</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">cl</span>,<span class="number">10000000b</span> <span class="comment">;第一列 颜色通过列线进行输出，281h输出则为第零列为红，282h输出则为第零列为绿 </span></span><br><span class="line"><span class="symbol">again_show_led_col:</span></span><br><span class="line">    <span class="comment">;红列  是控制哪一列是什么颜色的 红:281h 绿：282h 第0列为红色 </span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,<span class="built_in">cl</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">281h</span></span><br><span class="line">    <span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">al</span></span><br><span class="line">    <span class="comment">;每一列控制哪一行的红灯亮    这里有问题 对于控制行线来讲，若要红灯亮绿灯不亮则都不会亮（但是由于时间间隔很短，所以我在实验室的效果就是看起来不太亮）</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,[<span class="built_in">si</span>]                 <span class="comment">;所以这里必须解决红绿灯互相影响的问题</span></span><br><span class="line">    <span class="keyword">add</span> <span class="built_in">si</span>,<span class="number">1</span>                    <span class="comment">;因为时按列亮灯，共用列，所以不可能在一列中同时显示红灯和绿灯。</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">280h</span>                 <span class="comment">;要不试试逐个点亮  </span></span><br><span class="line">    <span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">al</span>                   <span class="comment">;我觉得实验室器材不太好，必不能支持如此高频率的数据传送</span></span><br><span class="line">                                <span class="comment">;所以贪吃蛇只能做到食物和蛇一个颜色，让食物闪烁吧。</span></span><br><span class="line">    <span class="comment">;mov bx ,10000</span></span><br><span class="line">    <span class="comment">;call delay</span></span><br><span class="line">    <span class="comment">;绿列  </span></span><br><span class="line">    <span class="comment">;mov al,cl</span></span><br><span class="line">    <span class="comment">;mov dx,282h</span></span><br><span class="line">    <span class="comment">;out dx,al</span></span><br><span class="line">    <span class="comment">;每一列控制哪一行的绿灯亮</span></span><br><span class="line">    <span class="comment">;mov al,[di]</span></span><br><span class="line">    <span class="comment">;add di,1</span></span><br><span class="line">    <span class="comment">;mov dx,280h    </span></span><br><span class="line">    <span class="comment">;out dx,al</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">;显示完每一列进行delay 以bx为参数</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">bx</span>,<span class="number">10</span></span><br><span class="line">    <span class="keyword">call</span> delay</span><br><span class="line"></span><br><span class="line">    <span class="comment">;关闭所有的列显示</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,<span class="built_in">cl</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">281h</span></span><br><span class="line">    <span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">al</span>   </span><br><span class="line">    <span class="comment">;mov dx,282h</span></span><br><span class="line">    <span class="comment">;out dx,al</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">shr</span> <span class="built_in">cl</span>,<span class="number">1</span>    <span class="comment">;下一列</span></span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">cl</span>,<span class="number">0</span></span><br><span class="line">    <span class="keyword">jnz</span> again_show_led_col</span><br><span class="line"></span><br><span class="line"><span class="symbol">show_led_end:</span></span><br><span class="line">    <span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">    <span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">    <span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">    <span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">    <span class="keyword">ret</span></span><br><span class="line">show_led endp</span><br></pre></td></tr></table></figure>

<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;运行贪吃蛇的程序   所有按键信息由中断进行扫描，程序只管从缓冲区中读取即可</span></span><br><span class="line">snake_gluttony proc</span><br><span class="line">    <span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">    <span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">    <span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">    <span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line"><span class="comment">;蛇的时间量，每经过100个全局时间量 加一，即蛇每1s移动一次 </span></span><br><span class="line">snake_time <span class="built_in">word</span> <span class="number">0</span> </span><br><span class="line"><span class="symbol">snake_gluttony_begin:</span></span><br><span class="line"><span class="symbol">snake_count_time:</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">ax</span>,sync_time_buffer</span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">bl</span>,<span class="number">100</span></span><br><span class="line">    <span class="keyword">div</span> <span class="built_in">bl</span>      <span class="comment">;得到余数在ah中 商在al</span></span><br><span class="line">    <span class="keyword">xor</span> <span class="number">ah</span>,<span class="number">ah</span></span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">ax</span>,[snake_time]     <span class="comment">;当前时间比之前的时间高</span></span><br><span class="line">    <span class="keyword">ja</span> snake_flush</span><br><span class="line">    <span class="comment">;为防止因为溢出而造成的错误判断</span></span><br><span class="line">    <span class="keyword">mov</span> [snake_time],<span class="built_in">ax</span></span><br><span class="line">    <span class="keyword">jmp</span> snake_count_time</span><br><span class="line"><span class="comment">;snake的时间到了，可以刷新</span></span><br><span class="line"><span class="symbol">snake_flush:</span></span><br><span class="line">    <span class="comment">;ax中存放当前贪吃蛇时间，放入snake_time</span></span><br><span class="line">    <span class="keyword">mov</span> [snake_time],<span class="built_in">ax</span></span><br><span class="line">    <span class="comment">;判断按键，进行贪吃蛇的逻辑操作  ;蛇的前近方向 3:上  0:下  2:左   1:右</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">ax</span>,keyboard_input_buffer</span><br><span class="line">    <span class="comment">;处理键盘的W A S D  10-13位存放</span></span><br><span class="line">    <span class="keyword">shr</span> <span class="built_in">ax</span>,<span class="number">10</span></span><br><span class="line">    <span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">00001111B</span></span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">00001000B</span></span><br><span class="line">    <span class="keyword">jz</span> snake_fulsh_process_key_w</span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">00000100B</span></span><br><span class="line">    <span class="keyword">jz</span> snake_fulsh_process_key_s</span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">00000010B</span></span><br><span class="line">    <span class="keyword">jz</span> snake_fulsh_process_key_a</span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">00000001B</span></span><br><span class="line">    <span class="keyword">jz</span> snake_fulsh_process_key_d</span><br><span class="line"></span><br><span class="line">    <span class="comment">;没有任何按键按下则直接进行处理</span></span><br><span class="line">    <span class="keyword">jmp</span> snake_flush_process</span><br><span class="line"></span><br><span class="line"><span class="comment">;处理按键w</span></span><br><span class="line"><span class="symbol">snake_fulsh_process_key_w:</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,snake_direction</span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">0</span>    <span class="comment">;当前方向不为下时改变方向为上</span></span><br><span class="line">    <span class="keyword">jz</span> snake_flush_process</span><br><span class="line">    <span class="keyword">mov</span> snake_direction,<span class="number">3</span></span><br><span class="line">    <span class="keyword">jmp</span> snake_flush_process</span><br><span class="line"><span class="comment">;处理按键s</span></span><br><span class="line"><span class="symbol">snake_fulsh_process_key_s:</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,snake_direction</span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">3</span>    <span class="comment">;当前方向不为上时改变方向为下</span></span><br><span class="line">    <span class="keyword">jz</span> snake_flush_process</span><br><span class="line">    <span class="keyword">mov</span> snake_direction,<span class="number">0</span></span><br><span class="line">    <span class="keyword">jmp</span> snake_flush_process</span><br><span class="line"><span class="comment">;处理按键a</span></span><br><span class="line"><span class="symbol">snake_fulsh_process_key_a:</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,snake_direction</span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">1</span>    <span class="comment">;当前方向不为右时改变方向为左</span></span><br><span class="line">    <span class="keyword">jz</span> snake_flush_process</span><br><span class="line">    <span class="keyword">mov</span> snake_direction,<span class="number">2</span></span><br><span class="line">    <span class="keyword">jmp</span> snake_flush_process</span><br><span class="line"><span class="comment">;处理按键d</span></span><br><span class="line"><span class="symbol">snake_fulsh_process_key_d:</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,snake_direction</span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">2</span>    <span class="comment">;当前方向不为左时改变方向为右</span></span><br><span class="line">    <span class="keyword">jz</span> snake_flush_process</span><br><span class="line">    <span class="keyword">mov</span> snake_direction,<span class="number">1</span></span><br><span class="line">    <span class="keyword">jmp</span> snake_flush_process</span><br><span class="line"></span><br><span class="line"><span class="comment">;按键处理完了，处理贪吃蛇的位置</span></span><br><span class="line"><span class="symbol">snake_flush_process:</span></span><br><span class="line">    <span class="comment">;将按键信息清零</span></span><br><span class="line"><span class="symbol">snake_flush_process_clear_key:</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">ax</span>,keyboard_input_buffer</span><br><span class="line">    <span class="comment">;处理键盘的W A S D 都置为零</span></span><br><span class="line">    <span class="keyword">and</span> <span class="built_in">ax</span>,<span class="number">1100001111111111B</span></span><br><span class="line">    <span class="keyword">mov</span> keyboard_input_buffer,<span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;位置刷新，根据上一次是否吃了食物决定身体更新策略</span></span><br><span class="line"><span class="comment">;若上一次刷新吃到了食物，则这一次蛇头变为蛇尾的一部分，然后蛇头向前走一步，若没有吃到，则从最后一节开始，每一节的位置时前一个的位置，第一个位置更新为蛇头的位置。</span></span><br><span class="line"><span class="symbol">move_snake_body:</span></span><br><span class="line">    <span class="comment">;每个位置需要两个字节</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">si</span>,offset snake_body_buffer </span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">di</span>,snake_body_length        <span class="comment">;其实有没有吃都从最后一节向前更新即可，无非是length的不同</span></span><br><span class="line">    <span class="keyword">dec</span> <span class="built_in">di</span>          <span class="comment">;减一 方便指向每一节</span></span><br><span class="line">    <span class="keyword">shl</span> <span class="built_in">di</span>,<span class="number">1</span>    </span><br><span class="line">    <span class="keyword">add</span> <span class="built_in">di</span>,<span class="built_in">si</span>   <span class="comment">;指向最后一节 目标地址</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">si</span>,<span class="built_in">di</span></span><br><span class="line">    <span class="keyword">sub</span> <span class="built_in">si</span>,<span class="number">2</span>    <span class="comment">;源地址</span></span><br><span class="line"><span class="comment">;更新蛇的身体的每一节，第一节不更新</span></span><br><span class="line"><span class="symbol">move_snake_body_every_section:</span></span><br><span class="line">    <span class="comment">;跟新蛇的尾巴信息 si所指向的</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,[<span class="built_in">si</span>]</span><br><span class="line">    <span class="keyword">mov</span> snake_tail_position_x,<span class="built_in">al</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,[<span class="built_in">si</span>+<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">mov</span> snake_tail_position_y,<span class="built_in">al</span></span><br><span class="line">    <span class="comment">;串传送的个数 （word）第一节不传送</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">cx</span>,snake_body_length</span><br><span class="line">    <span class="keyword">dec</span> <span class="built_in">cx</span>              </span><br><span class="line">    <span class="keyword">std</span>         <span class="comment">;反向传送       </span></span><br><span class="line">    <span class="keyword">rep</span> <span class="keyword">movsw</span>       </span><br><span class="line"></span><br><span class="line"><span class="comment">;更新第一节，将头的位置赋予即可</span></span><br><span class="line"><span class="symbol">move_snake_body_first_section:</span></span><br><span class="line">    <span class="comment">;高位存放纵坐标</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">si</span>,offset snake_body_buffer</span><br><span class="line">    <span class="keyword">mov</span> <span class="number">ah</span>,snake_head_position_y</span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,snake_head_position_x</span><br><span class="line">    <span class="keyword">mov</span> [<span class="built_in">si</span>],<span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">;位置刷新，将贪吃蛇头朝对应方向移动一格</span></span><br><span class="line"><span class="symbol">move_snake_head:</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,snake_direction</span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">3</span>    <span class="comment">;上</span></span><br><span class="line">    <span class="keyword">jz</span> move_snake_head_up</span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">0</span>    <span class="comment">;下</span></span><br><span class="line">    <span class="keyword">jz</span> move_snake_head_down</span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">2</span>    <span class="comment">;左</span></span><br><span class="line">    <span class="keyword">jz</span> move_snake_head_left</span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">1</span>    <span class="comment">;右</span></span><br><span class="line">    <span class="keyword">jz</span> move_snake_head_right</span><br><span class="line">    <span class="comment">;不可能哪个方向都不对</span></span><br><span class="line">    <span class="comment">;jmp move_snake_head_direction_error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;上</span></span><br><span class="line"><span class="symbol">move_snake_head_up:</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,snake_head_position_y</span><br><span class="line">    <span class="keyword">sub</span> <span class="built_in">ax</span>,<span class="number">1</span>    </span><br><span class="line">    <span class="keyword">jnc</span> snake_judge_conflict</span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">7</span>    <span class="comment">;小于0，则从下面钻出来</span></span><br><span class="line">    <span class="keyword">jmp</span> snake_judge_conflict</span><br><span class="line"><span class="comment">;下</span></span><br><span class="line"><span class="symbol">move_snake_head_down:</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,snake_head_position_y</span><br><span class="line">    <span class="keyword">add</span> <span class="built_in">ax</span>,<span class="number">1</span></span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">ax</span>,<span class="number">8</span>    </span><br><span class="line">    <span class="keyword">jnz</span> snake_judge_conflict</span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">0</span>    <span class="comment">;等于8，超界，则从上面钻出来</span></span><br><span class="line">    <span class="keyword">jmp</span> snake_judge_conflict</span><br><span class="line"><span class="comment">;左</span></span><br><span class="line"><span class="symbol">move_snake_head_left:</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,snake_head_position_x</span><br><span class="line">    <span class="keyword">sub</span> <span class="built_in">ax</span>,<span class="number">1</span>    </span><br><span class="line">    <span class="keyword">jnc</span> snake_judge_conflict</span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">7</span>    <span class="comment">;小于0，则从下右面钻出来</span></span><br><span class="line">    <span class="keyword">jmp</span> snake_judge_conflict</span><br><span class="line"><span class="comment">;右</span></span><br><span class="line"><span class="symbol">move_snake_head_right:</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,snake_head_position_x</span><br><span class="line">    <span class="keyword">add</span> <span class="built_in">ax</span>,<span class="number">1</span></span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">ax</span>,<span class="number">8</span>    </span><br><span class="line">    <span class="keyword">jnz</span> snake_judge_conflict</span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">0</span>    <span class="comment">;等于8 ，则从左面钻出来</span></span><br><span class="line">    <span class="keyword">jmp</span> snake_judge_conflict</span><br><span class="line"></span><br><span class="line"><span class="comment">;判断是否冲突</span></span><br><span class="line"><span class="symbol">snake_judge_conflict:</span></span><br><span class="line">    <span class="comment">;首先判断是否蛇头和食物重合，若没有重合则蛇尾向前一步走，若重合则蛇尾不动，将蛇的身体信息全部向后移动一位</span></span><br><span class="line">    <span class="comment">;清空上一次吃到食物的信息</span></span><br><span class="line">    <span class="keyword">mov</span> food_eaten,<span class="number">0</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="number">ah</span>,snake_head_position_x</span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,food_x</span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">ah</span></span><br><span class="line">    <span class="keyword">jnz</span> snake_judge_conflict_not_eat</span><br><span class="line">    <span class="keyword">mov</span> <span class="number">ah</span>,snake_head_position_y</span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,food_y</span><br><span class="line">    <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">ah</span></span><br><span class="line">    <span class="keyword">jnz</span> snake_judge_conflict_not_eat</span><br><span class="line">    <span class="comment">;下面时蛇吃了食物 </span></span><br><span class="line">    <span class="keyword">mov</span> food_eaten,<span class="number">1</span></span><br><span class="line">    <span class="keyword">add</span> snake_body_length,<span class="number">1</span></span><br><span class="line"><span class="comment">;生成新的食物 位置为（7-当前蛇头x,7-当前蛇尾y)</span></span><br><span class="line"><span class="symbol">snake_create_new_food:</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">7</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">bx</span>,snake_head_position_x</span><br><span class="line">    <span class="keyword">sub</span> <span class="built_in">ax</span>,<span class="built_in">bx</span></span><br><span class="line">    <span class="keyword">mov</span> food_x,<span class="built_in">al</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">7</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">bx</span> snake_tail_position_y</span><br><span class="line">    <span class="keyword">sub</span> <span class="built_in">ax</span>,<span class="built_in">bx</span></span><br><span class="line">    <span class="keyword">mov</span> food_y,<span class="built_in">al</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">;蛇这一步没有吃到食物</span></span><br><span class="line"><span class="symbol">snake_judge_conflict_not_eat:</span></span><br><span class="line">    <span class="keyword">mov</span> food_eaten,<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;在led点阵中点亮蛇阵 使用红色</span></span><br><span class="line">snake_lighten_led_red：</span><br><span class="line">    <span class="comment">;首先点亮食物</span></span><br><span class="line">    <span class="comment">;写入红色灯亮，ah为行号，al为列号 注意这里 （0，0）在左下角    即ah为y al为x</span></span><br><span class="line">    <span class="comment">;make_it_red proc</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="number">ah</span>,food_y</span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,food_x</span><br><span class="line">    <span class="keyword">call</span> make_it_red</span><br><span class="line">    <span class="comment">;点亮头</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="number">ah</span>,snake_head_position_y</span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,snake_head_position_x</span><br><span class="line">    <span class="keyword">call</span> make_it_red</span><br><span class="line">    <span class="comment">;点亮身体</span></span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">si</span>,offset snake_body_buffer</span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">cx</span>,snake_body_length</span><br><span class="line">snake_lighten_led_red_body：</span><br><span class="line">    <span class="keyword">mov</span> <span class="built_in">al</span>,[<span class="built_in">si</span>]</span><br><span class="line">    <span class="keyword">mov</span> <span class="number">ah</span>,[<span class="built_in">si</span>+<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">add</span> <span class="built_in">si</span>,<span class="number">2</span></span><br><span class="line">    <span class="keyword">loop</span> snake_lighten_led_red_body</span><br><span class="line"></span><br><span class="line">    <span class="keyword">jmp</span> snake_gluttony_begin</span><br><span class="line"></span><br><span class="line"><span class="symbol">snake_gluttony_end:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">    <span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">    <span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">    <span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">    <span class="keyword">ret</span></span><br><span class="line">snake_gluttony endp</span><br></pre></td></tr></table></figure>



<h2 id="任务分工"><a href="#任务分工" class="headerlink" title="任务分工"></a>任务分工</h2><p>岳希航：贪吃蛇逻辑控制模块、LED显示模块、声音控制模块、数码管显示模块</p>
<p>崔文耀：游戏整体逻辑控制模块、全局时钟控制模块、灯光控制模块、红外线输入模块</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://myblog.cuimouren.cn/2021/07/05/%E5%BE%AE%E6%9C%BA%E4%B8%8E%E6%B1%87%E7%BC%96%E6%8E%A5%E5%8F%A3%E5%AE%9E%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="崔文耀">
      <meta itemprop="description" content="Hello, here is wenyao's space, how do you come in???">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="这里是文耀的space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="../../2021/07/05/%E5%BE%AE%E6%9C%BA%E4%B8%8E%E6%B1%87%E7%BC%96%E6%8E%A5%E5%8F%A3%E5%AE%9E%E9%AA%8C/" class="post-title-link" itemprop="url">微机与汇编接口实验</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-05 19:47:58" itemprop="dateCreated datePublished" datetime="2021-07-05T19:47:58+08:00">2021-07-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-10 16:32:55" itemprop="dateModified" datetime="2021-07-10T16:32:55+08:00">2021-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/%E5%BE%AE%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">微机</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="微机与汇编接口实验"><a href="#微机与汇编接口实验" class="headerlink" title="微机与汇编接口实验"></a>微机与汇编接口实验</h1><p>暑假小学期让做一个有关微机的小项目，看来也是为以后做嵌入式开发做准备。</p>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><h3 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h3><p>设想的是使用led点阵做一个小型的贪吃蛇游戏，并且可以使用红外遥控器进行操控，并且配合实时的灯光和音效展现出一种复古的街机氛围。<br>设计项目要抓住项目的主要矛盾，做贪吃蛇就是做贪吃蛇，专心地先做出来贪吃蛇再想别的。          </p>
<p>首先必须可以实时的控制led点阵，led点阵可以显示红绿两种颜色，将led点阵存放在red_buffer、green_buffer中，他们都是一个8字节地缓冲区，每一个字节存放了每一列中各行地明亮情况。下面说明一下程序的生命周期：程序开始运行，主菜单显示退出程序和开始贪吃蛇游戏，选择退出程序则退出程序，选择开始贪吃蛇游戏则开始贪吃蛇游戏。进入贪吃蛇游戏之后在led点阵上显示出图像，使用遥控器控制贪吃蛇进行移动吃食物，若撞到墙则从另一边出来，若撞到自己则失败回到主菜单。在游戏过程中实时播放音效和数码管计分。</p>
<h3 id="功能设计"><a href="#功能设计" class="headerlink" title="功能设计"></a>功能设计</h3><ol>
<li>程序开始时展现出一个菜单，菜单分为：<ol>
<li>退出程序</li>
<li>开始贪吃蛇游戏</li>
</ol>
</li>
<li>贪吃蛇程序开始运行，在led点阵上面实时地显示。</li>
<li>使用数码管显示当前得分</li>
<li>在游戏中播放音乐</li>
<li>在游戏中根据贪吃蛇地状态进行灯光、音乐、文字等方面地提示。</li>
<li>游戏失败后返回主菜单。</li>
</ol>
<h3 id="模块设计"><a href="#模块设计" class="headerlink" title="模块设计"></a>模块设计</h3><ol>
<li>show_led<ol>
<li>负责根据led点阵缓冲区中地数据向上提供可靠的led点阵显示程序。   </li>
<li>入口：led点阵缓冲区</li>
<li>出口：led点阵进行刷新一次</li>
</ol>
</li>
<li>delay<ol>
<li>根据bx地值进行时长不等的延时。</li>
<li>入口：bx</li>
<li>出口：延时一定时间</li>
</ol>
</li>
<li>dispmenu<ol>
<li>显示程序初始的菜单</li>
<li>入口：程序启动</li>
<li>出口：显示程序初始的菜单</li>
</ol>
</li>
<li>show_digital_tube<ol>
<li>把bx中的10进制数据显示出来（0&lt;=bx&lt;=9999)</li>
<li>入口：bx</li>
<li>出口：数码管显示bx中的十进制数据</li>
</ol>
</li>
<li>buzzer_sound<ol>
<li>根据bx中的频率，蜂鸣器响</li>
<li>入口：bx</li>
<li>出口：蜂鸣器响特定的频率</li>
</ol>
</li>
<li>infrared_input<ol>
<li>红外线输入，接受红外线的输入并将红外线输入的信息存储到infrared_input_buffer中。</li>
<li>入口：红外线输入</li>
<li>出口：更新infrared_input_buffer</li>
</ol>
</li>
<li>keyboard_input<ol>
<li>键盘输入，接受键盘的输入并将键盘输入的信息存储到keyboard_input_buffer中。</li>
<li>入口：键盘输入</li>
<li>出口：更新keyboard_input_buffer</li>
</ol>
</li>
<li>process_input<ol>
<li>处理输入，根据infrared_input_buffer和keyboard_input_buffer和status_buffer更新程序的数据。相当于游戏逻辑控制。</li>
<li>入口：以上三个缓冲区</li>
<li>出口：根据游戏状态和逻辑更新游戏状态</li>
</ol>
</li>
<li>run<ol>
<li>程序的状态机，程序的声明周期控制</li>
<li>入口：status_buffer</li>
<li>出口：status_buffer</li>
</ol>
</li>
</ol>
<h3 id="详细模块设计"><a href="#详细模块设计" class="headerlink" title="详细模块设计"></a>详细模块设计</h3><h1 id="code"><a href="#code" class="headerlink" title="code"></a>code</h1><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;点亮数码管  ********</span></span><br><span class="line"><span class="comment">;删除simple_input</span></span><br><span class="line"><span class="comment">;删除红外输入的有关内容</span></span><br><span class="line"><span class="comment">;键盘的BIOS调用 int 16h  入口: ah=0 出口 al=ascii     先使用 ah=01判断是否有输入</span></span><br><span class="line"><span class="comment">;注释掉 process_input中的 call keyboard_input 和snake_count_time 中的 call keyboard_input 并删除中断程序中对call keyboard_input的注释，验证使用中断输入是否可行</span></span><br><span class="line"><span class="comment">;删除snake中jmp snake_flush </span></span><br><span class="line"><span class="comment">;新增 delay_short</span></span><br><span class="line"><span class="comment">;尝试可不可以在任何时候按下9回到主菜单，做不到的话就删除主菜单中的这句话</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;支持子程序库的简化段源程序格式</span></span><br><span class="line">    include io<span class="number">.</span><span class="keyword">inc</span></span><br><span class="line"><span class="meta">	.model</span> small	<span class="comment">; 定义程序的存储模式</span></span><br><span class="line"><span class="meta">	.stack</span>	<span class="comment">; 定义堆栈段（默认是1KB空间）</span></span><br><span class="line"><span class="meta">	.data</span>	<span class="comment">;数据段</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;存放每一列的信息 1为亮 两种颜色交替进行闪亮 要把每一个字节的信息传送给行，来控制某一行的亮  </span></span><br><span class="line"><span class="comment">;比如 某一个字节为 1000_0010b 则最上面一行和倒数第二行的灯亮，此时只需要对应列全为1即可控制该列的8个灯的亮暗。</span></span><br><span class="line"><span class="comment">;红色   颜色是通过列线进行输出的</span></span><br><span class="line">red_buffer   <span class="built_in">byte</span> <span class="number">8</span> dup(<span class="number">0</span>)</span><br><span class="line"><span class="comment">;绿色</span></span><br><span class="line">green_buffer <span class="built_in">byte</span> <span class="number">8</span> dup(<span class="number">0</span>)</span><br><span class="line"><span class="comment">;infrared_input_buffer  存储红外线输入的缓冲区  每一个bit可以自由定义其含义</span></span><br><span class="line">infrared_input_buffer <span class="built_in">word</span> <span class="number">0</span></span><br><span class="line"><span class="comment">;keyboard_input_buffer 存储键盘输入的缓冲区  每一个bit可以自由定义其含义</span></span><br><span class="line">keyboard_input_buffer <span class="built_in">word</span> <span class="number">0</span></span><br><span class="line"><span class="comment">;Status buffer 状态缓冲区，用来存放程序运行的各种状态</span></span><br><span class="line">status_buffer <span class="built_in">word</span> <span class="number">0</span></span><br><span class="line"><span class="comment">;时间缓冲区，负责提供同步信息 由中断程序每隔10ms加一</span></span><br><span class="line">sync_time_buffer <span class="built_in">word</span> <span class="number">0</span></span><br><span class="line"><span class="comment">;蛇身位置 不包含蛇头 蛇的每一个位置需要两个字节，8*8*2=128B</span></span><br><span class="line">snake_body_buffer <span class="built_in">byte</span> <span class="number">128</span> dup(<span class="number">0</span>)</span><br><span class="line"><span class="comment">;蛇身的长度，不包括蛇头，也是当前的分数</span></span><br><span class="line">snake_body_length <span class="built_in">word</span> <span class="number">0</span></span><br><span class="line"><span class="comment">;蛇头位置</span></span><br><span class="line">snake_head_position_x <span class="built_in">byte</span> <span class="number">0</span></span><br><span class="line">snake_head_position_y <span class="built_in">byte</span> <span class="number">0</span></span><br><span class="line"><span class="comment">;蛇尾位置</span></span><br><span class="line">snake_tail_position_x <span class="built_in">byte</span> <span class="number">0</span></span><br><span class="line">snake_tail_position_y <span class="built_in">byte</span> <span class="number">0</span></span><br><span class="line"><span class="comment">;食物位置</span></span><br><span class="line">food_x <span class="built_in">byte</span> <span class="number">0</span></span><br><span class="line">food_y <span class="built_in">byte</span> <span class="number">0</span></span><br><span class="line"><span class="comment">;是否吃了食物 0:没有 1:吃了</span></span><br><span class="line">food_eaten <span class="built_in">byte</span> <span class="number">0</span></span><br><span class="line"><span class="comment">;碰撞与否</span></span><br><span class="line">collision <span class="built_in">byte</span> <span class="number">0</span></span><br><span class="line"><span class="comment">;蛇的前近方向 2:上 0：下 2;左 1：右</span></span><br><span class="line">snake_direction <span class="built_in">byte</span> <span class="number">0</span></span><br><span class="line"><span class="comment">;保存原中断程序入口</span></span><br><span class="line">int_0b_seg <span class="built_in">word</span> <span class="number">0</span></span><br><span class="line">int_0b_off <span class="built_in">word</span> <span class="number">0</span></span><br><span class="line"><span class="comment">;蛇的时间量，每经过100个全局时间量 加一，即蛇每1s移动一次 </span></span><br><span class="line">snake_time <span class="built_in">word</span> <span class="number">0</span></span><br><span class="line"><span class="comment">;数码管</span></span><br><span class="line">ledtb <span class="built_in">byte</span> <span class="number">3fh</span>,<span class="number">06h</span>,<span class="number">5bh</span>,<span class="number">4fh</span>,<span class="number">66h</span>,<span class="number">6dh</span>,<span class="number">7dh</span>,<span class="number">07h</span>,<span class="number">7fh</span>,<span class="number">6fh</span></span><br><span class="line"><span class="comment">;得分（当前长度减去初始长度）存储  分别存储四个数码管的数字</span></span><br><span class="line">lednum <span class="built_in">byte</span> <span class="number">4</span> dup(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">byte</span> <span class="number">128</span> dup(<span class="number">0</span>)</span><br><span class="line"><span class="comment">;main_menu 主菜单</span></span><br><span class="line">main_menu <span class="built_in">byte</span> <span class="string">&#x27;---------------main menu---------------&#x27;</span>,<span class="number">10</span>,<span class="number">13</span></span><br><span class="line"><span class="built_in">byte</span> <span class="string">&#x27;----press corrsepnding key to continue----&#x27;</span>,<span class="number">10</span>,<span class="number">13</span></span><br><span class="line"><span class="built_in">byte</span> <span class="string">&#x27;1. exit&#x27;</span>,<span class="number">10</span>,<span class="number">13</span></span><br><span class="line"><span class="built_in">byte</span> <span class="string">&#x27;2. play snake_gluttony &#x27;</span>,<span class="number">10</span>,<span class="number">13</span></span><br><span class="line"><span class="built_in">byte</span> <span class="string">&#x27;*********************************************&#x27;</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">0</span>									</span><br><span class="line">			   							  </span><br><span class="line">			  															  </span><br><span class="line"><span class="comment">;退出语句</span></span><br><span class="line">abort_msg <span class="built_in">byte</span> <span class="string">&#x27;exit,thanks&#x27;</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">msgstatus0 <span class="built_in">byte</span> <span class="string">&#x27;msgstatus0&#x27;</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">msgstatus1 <span class="built_in">byte</span> <span class="string">&#x27;msgstatus1&#x27;</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">msgsetint <span class="built_in">byte</span> <span class="string">&#x27;msgsetint&#x27;</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">msgscankeyboard <span class="built_in">byte</span> <span class="string">&#x27;msgscankeyboard&#x27;</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">msgintirq10 <span class="built_in">byte</span> <span class="string">&#x27;msgintirq10&#x27;</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">snake_gluttony_running <span class="built_in">byte</span> <span class="string">&#x27;snake_gluttony is running&#x27;</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">msg_direction <span class="built_in">byte</span> <span class="string">&#x27;now, the direction is &#x27;</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">msg_snake_head_position <span class="built_in">byte</span> <span class="string">&#x27;msg_snake_head_position is &#x27;</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">msg_snake_tail_position <span class="built_in">byte</span> <span class="string">&#x27;msg_snake_tail_position is &#x27;</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">msg_snake_body_position <span class="built_in">byte</span> <span class="string">&#x27;msg_snake_body_position is &#x27;</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">msg_snake_gluttony_game_over <span class="built_in">byte</span> <span class="string">&#x27;game over!!!&#x27;</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">msg_snake_gluttony_game_start <span class="built_in">byte</span> <span class="string">&#x27;snake gluttony game start, have fun!!!&#x27;</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">msg_int_test <span class="built_in">byte</span> <span class="string">&#x27;msg_int_test&#x27;</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">	.code</span>	<span class="comment">;代码段</span></span><br><span class="line"><span class="symbol">start:</span>	</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,@data</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ds</span>,<span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">;设置中断</span></span><br><span class="line">	<span class="keyword">call</span> set_int</span><br><span class="line">	<span class="keyword">call</span> run</span><br><span class="line"><span class="meta">	.exit</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;状态机 负责处理所有的状态 程序的所有状态全部由status_buffer所体现</span></span><br><span class="line">run proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;程序开始运行，清空程序的所有缓冲区</span></span><br><span class="line"><span class="symbol">run_begin:</span></span><br><span class="line">	<span class="keyword">call</span> clear_digital_buffer</span><br><span class="line">	<span class="keyword">call</span> clear_screen</span><br><span class="line">	<span class="keyword">call</span> disp_main_menu</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="comment">;清空缓冲区的数据</span></span><br><span class="line">	<span class="keyword">mov</span> red_buffer,<span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> green_buffer,<span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> status_buffer,<span class="number">1</span>   <span class="comment">;初始状态为1 主菜单</span></span><br><span class="line">	<span class="keyword">mov</span> infrared_input_buffer,<span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> keyboard_input_buffer,<span class="number">0</span></span><br><span class="line">	</span><br><span class="line"><span class="comment">;显示主菜单 没有收到遥控器的命令就一直进行查询</span></span><br><span class="line"><span class="symbol">show_main_menu:</span></span><br><span class="line">	<span class="comment">;所有的输入已经通过每10ms的中断传入到输入缓冲区了</span></span><br><span class="line">	<span class="keyword">call</span> process_input		<span class="comment">;改变程序状态 下面判断当前程序状态 000为退出</span></span><br><span class="line">	<span class="comment">;判断是否有有效输入进行下一步</span></span><br><span class="line">	<span class="comment">;状态0 退出</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,status_buffer</span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">00000111B</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">0</span></span><br><span class="line">	<span class="keyword">jz</span> run_abort</span><br><span class="line">	<span class="comment">;状态1 </span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,status_buffer </span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">00000111B</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">1</span></span><br><span class="line">	<span class="keyword">jz</span> show_main_menu</span><br><span class="line">	<span class="comment">;判断是否要进入贪吃蛇游戏 就是判断当前主状态为2</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,status_buffer </span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">00000111B</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">2</span></span><br><span class="line">	<span class="keyword">jz</span> run_snake_gluttony</span><br><span class="line">	<span class="comment">;判断是否退出</span></span><br><span class="line">	<span class="keyword">jz</span> run_abort</span><br><span class="line">	<span class="keyword">jmp</span> show_main_menu</span><br><span class="line"><span class="comment">;运行贪吃蛇</span></span><br><span class="line"><span class="symbol">run_snake_gluttony:</span></span><br><span class="line"><span class="symbol">	snake_gluttony_game_start:</span></span><br><span class="line">	<span class="comment">;每一个主状态都是一个自循环，除非中断迫使其退出</span></span><br><span class="line">	<span class="keyword">call</span> snake_gluttony</span><br><span class="line">	<span class="comment">;贪吃蛇由于某种原因运行完成退出 回到主菜单</span></span><br><span class="line"><span class="symbol">snake_gluttony_game_over:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset msg_snake_gluttony_game_over</span><br><span class="line">	<span class="keyword">call</span> dispstr</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,<span class="number">1000</span></span><br><span class="line">	<span class="keyword">call</span> delay</span><br><span class="line">	<span class="keyword">jmp</span> run_begin</span><br><span class="line"></span><br><span class="line"><span class="comment">;这里可以有很多程序和贪吃蛇并列，但是我并不想要。</span></span><br><span class="line"><span class="symbol">run_abort:</span></span><br><span class="line">	<span class="comment">;打印出一段退出程序的语句</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset abort_msg</span><br><span class="line">	<span class="keyword">call</span> dispstr </span><br><span class="line"></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">run endp</span><br><span class="line"></span><br><span class="line"><span class="comment">;显示主菜单</span></span><br><span class="line">disp_main_menu proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,@data</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ds</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset main_menu</span><br><span class="line">	<span class="keyword">call</span> dispstr </span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">disp_main_menu endp</span><br><span class="line"></span><br><span class="line"><span class="comment">;处理输入结果 逻辑控制</span></span><br><span class="line">process_input proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;判断主状态	</span></span><br><span class="line"><span class="symbol">judge_main_status:</span></span><br><span class="line">	<span class="comment">;状态0 ，退出</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,status_buffer </span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">00000111B</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">0</span></span><br><span class="line">	<span class="keyword">jz</span> main_status_0	<span class="comment">;跳转到主状态0 退出</span></span><br><span class="line">	<span class="comment">;判断是否为主状态1，即在主菜单</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,status_buffer </span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">00000111B</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">1</span></span><br><span class="line">	<span class="keyword">jz</span> main_status_1	<span class="comment">;跳转到主状态1来执行</span></span><br><span class="line">	<span class="comment">;判断是否为主状态2，即贪吃蛇游戏</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,status_buffer</span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">00000111B</span>	<span class="comment">;只留下低三位</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">2</span>			<span class="comment">;状态1</span></span><br><span class="line">	<span class="keyword">jz</span> main_status_2	<span class="comment">;跳转到主状态1，即执行贪吃蛇</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">;还要依次遍历很多别的状态</span></span><br><span class="line">	<span class="keyword">jmp</span> process_input_done</span><br><span class="line"></span><br><span class="line"><span class="comment">;状态0 ，退出</span></span><br><span class="line"><span class="symbol">main_status_0:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,status_buffer</span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">bl</span>,<span class="number">11111000B</span></span><br><span class="line">	<span class="keyword">mov</span> status_buffer,<span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">jmp</span> process_input_done</span><br><span class="line"></span><br><span class="line"><span class="comment">;主状态1 主菜单</span></span><br><span class="line"><span class="symbol">main_status_1:</span></span><br><span class="line">	<span class="comment">;将程序状态变为1</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">00000001B</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,status_buffer</span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">bl</span>,<span class="number">11111000B</span></span><br><span class="line">	<span class="keyword">or</span> <span class="built_in">bl</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">mov</span> status_buffer,<span class="built_in">bx</span></span><br><span class="line">	<span class="comment">;主菜单一件事情，等待输入，将红外和键盘输入的对于处于主菜单的程序有效的输入存储在缓冲区内</span></span><br><span class="line">	<span class="comment">;判断红外输入。 1:退出 2：开始贪吃蛇	9：回到主菜单</span></span><br><span class="line">	<span class="comment">;键盘输入，1-9位对应输入</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,keyboard_input_buffer</span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">00000010B</span> 	<span class="comment">;判断第一位 退出</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">00000010B</span>	</span><br><span class="line">	<span class="keyword">jz</span> main_status_0</span><br><span class="line">	<span class="comment">;键盘输入，1-9位对应输入</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,keyboard_input_buffer</span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">00000100B</span> 	<span class="comment">;判断第二位 贪吃蛇</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">00000100B</span>	</span><br><span class="line">	<span class="keyword">jz</span> main_status_2</span><br><span class="line">	<span class="keyword">jmp</span> process_input_done</span><br><span class="line"></span><br><span class="line"><span class="comment">;主状态2 贪吃蛇</span></span><br><span class="line"><span class="symbol">main_status_2:</span></span><br><span class="line">	<span class="comment">;将程序状态变为2</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">00000010B</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,status_buffer</span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">bl</span>,<span class="number">11111000B</span></span><br><span class="line">	<span class="keyword">or</span> <span class="built_in">bl</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">mov</span> status_buffer,<span class="built_in">bx</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">;没有符合条件的状态，直接退出</span></span><br><span class="line">	<span class="keyword">jmp</span> process_input_done</span><br><span class="line"></span><br><span class="line"><span class="symbol">process_input_done:</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">process_input endp</span><br><span class="line"></span><br><span class="line"><span class="comment">;Infrared input 红外线输入</span></span><br><span class="line">infrared_input proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">infrared_input endp</span><br><span class="line"></span><br><span class="line"><span class="comment">;simple_input</span></span><br><span class="line">simple_input proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">282h</span>		<span class="comment">;读入 pc</span></span><br><span class="line">	<span class="keyword">in</span> <span class="built_in">al</span>,<span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">0</span></span><br><span class="line">	<span class="keyword">jz</span> simple_input_end</span><br><span class="line"></span><br><span class="line"><span class="symbol">simple_input_1:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">00000010B</span></span><br><span class="line">	<span class="keyword">jz</span> simple_input_2</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,keyboard_input_buffer</span><br><span class="line">	<span class="comment">;or ax,0000 0000 0000 0010b</span></span><br><span class="line">	<span class="keyword">or</span> <span class="built_in">bx</span>,<span class="number">0002h</span></span><br><span class="line">	<span class="keyword">mov</span> keyboard_input_buffer,<span class="built_in">bx</span></span><br><span class="line"><span class="symbol">simple_input_2:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">00000100B</span></span><br><span class="line">	<span class="keyword">jz</span> simple_input_w</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,keyboard_input_buffer</span><br><span class="line">	<span class="comment">;or ax,0000 0000 0000 0100b</span></span><br><span class="line">	<span class="keyword">or</span> <span class="built_in">bx</span>,<span class="number">0004h</span></span><br><span class="line">	<span class="keyword">mov</span> keyboard_input_buffer,<span class="built_in">bx</span></span><br><span class="line"><span class="symbol">simple_input_w:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">00001000B</span></span><br><span class="line">	<span class="keyword">jz</span> simple_input_a</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,keyboard_input_buffer</span><br><span class="line">	<span class="comment">;or ax,0000 0100 0000 0000b</span></span><br><span class="line">	<span class="keyword">or</span> <span class="built_in">bx</span>,<span class="number">0400h</span></span><br><span class="line">	<span class="keyword">mov</span> keyboard_input_buffer,<span class="built_in">bx</span></span><br><span class="line"><span class="symbol">simple_input_a:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">00010000B</span></span><br><span class="line">	<span class="keyword">jz</span> simple_input_s</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,keyboard_input_buffer</span><br><span class="line">	<span class="comment">;or ax,0000 0100 0000 0000b</span></span><br><span class="line">	<span class="keyword">or</span> <span class="built_in">bx</span>,<span class="number">0800h</span></span><br><span class="line">	<span class="keyword">mov</span> keyboard_input_buffer,<span class="built_in">bx</span></span><br><span class="line"><span class="symbol">simple_input_s:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">00100000B</span></span><br><span class="line">	<span class="keyword">jz</span> simple_input_d</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,keyboard_input_buffer</span><br><span class="line">	<span class="comment">;or ax,0000 0100 0000 0000b</span></span><br><span class="line">	<span class="keyword">or</span> <span class="built_in">bx</span>,<span class="number">1000h</span></span><br><span class="line">	<span class="keyword">mov</span> keyboard_input_buffer,<span class="built_in">bx</span></span><br><span class="line"><span class="symbol">simple_input_d:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">01000000B</span></span><br><span class="line">	<span class="keyword">jz</span> simple_input_end</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,keyboard_input_buffer</span><br><span class="line">	<span class="comment">;or ax,0000 0100 0000 0000b</span></span><br><span class="line">	<span class="keyword">or</span> <span class="built_in">bx</span>,<span class="number">2000h</span></span><br><span class="line">	<span class="keyword">mov</span> keyboard_input_buffer,<span class="built_in">bx</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="symbol">simple_input_end:</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">simple_input endp</span><br><span class="line"><span class="comment">;键盘输入</span></span><br><span class="line">keyboard_input proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line">	<span class="comment">;mov si,offset msgscankeyboard </span></span><br><span class="line">	<span class="comment">;call dispstr </span></span><br><span class="line"><span class="comment">;扫描输入</span></span><br><span class="line">	<span class="comment">;键盘输入 al中存放键盘输入的ascii码</span></span><br><span class="line"><span class="symbol">scan_keynoard:</span></span><br><span class="line">	<span class="comment">;处理键盘的W A S D  10-13位存放  将对应位置1   输入小写</span></span><br><span class="line">	<span class="comment">;call readkey</span></span><br><span class="line">	<span class="comment">;测试 int 16h</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,<span class="number">01h</span></span><br><span class="line">	<span class="keyword">int</span> <span class="number">16h</span></span><br><span class="line">	<span class="keyword">jz</span> scan_keynoard_end	<span class="comment">;若键盘缓冲区没有则结束</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,<span class="number">00h</span> 				<span class="comment">;键盘缓冲区中有则读取</span></span><br><span class="line">	<span class="keyword">int</span> <span class="number">16h</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">scan_keynoard_w:</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="string">&#x27;w&#x27;</span></span><br><span class="line">	<span class="keyword">jnz</span> scan_keynoard_a</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,keyboard_input_buffer</span><br><span class="line">	<span class="comment">;or ax,0000 0100 0000 0000b</span></span><br><span class="line">	<span class="keyword">or</span> <span class="built_in">ax</span>,<span class="number">0400h</span></span><br><span class="line">	<span class="keyword">mov</span> keyboard_input_buffer,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">jmp</span> scan_keynoard_end</span><br><span class="line"><span class="symbol">scan_keynoard_a:</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="string">&#x27;a&#x27;</span></span><br><span class="line">	<span class="keyword">jnz</span> scan_keynoard_s</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,keyboard_input_buffer</span><br><span class="line">	<span class="comment">;or ax,0000 1000 0000 0000b</span></span><br><span class="line">	<span class="keyword">or</span> <span class="built_in">ax</span>,<span class="number">0800h</span></span><br><span class="line">	<span class="keyword">mov</span> keyboard_input_buffer,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">jmp</span> scan_keynoard_end</span><br><span class="line"><span class="symbol">scan_keynoard_s:</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="string">&#x27;s&#x27;</span></span><br><span class="line">	<span class="keyword">jnz</span> scan_keynoard_d</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,keyboard_input_buffer</span><br><span class="line">	<span class="comment">;or ax,0001 0000 0000 0000b</span></span><br><span class="line">	<span class="keyword">or</span> <span class="built_in">ax</span>,<span class="number">1000h</span></span><br><span class="line">	<span class="keyword">mov</span> keyboard_input_buffer,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">jmp</span> scan_keynoard_end</span><br><span class="line"><span class="symbol">scan_keynoard_d:</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="string">&#x27;d&#x27;</span></span><br><span class="line">	<span class="keyword">jnz</span> scan_keynoard_num</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,keyboard_input_buffer</span><br><span class="line">	<span class="comment">;or ax,0010 0000 0000 0000b</span></span><br><span class="line">	<span class="keyword">or</span> <span class="built_in">ax</span>,<span class="number">2000h</span></span><br><span class="line">	<span class="keyword">mov</span> keyboard_input_buffer,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">jmp</span> scan_keynoard_end</span><br><span class="line"><span class="comment">;扫描num num存在1-9位对应1-9</span></span><br><span class="line"><span class="symbol">scan_keynoard_num:</span></span><br><span class="line">	<span class="keyword">sub</span> <span class="built_in">al</span>,<span class="number">48</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">1</span>		<span class="comment">;小于1不行</span></span><br><span class="line">	<span class="keyword">jb</span> scan_keynoard_end</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">9</span>		<span class="comment">;大于9不行</span></span><br><span class="line">	<span class="keyword">ja</span> scan_keynoard_end</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,<span class="number">1</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cl</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">shl</span> <span class="built_in">bx</span>,<span class="built_in">cl</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,keyboard_input_buffer</span><br><span class="line">	<span class="keyword">or</span> <span class="built_in">ax</span>,<span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">mov</span> keyboard_input_buffer,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">jmp</span> scan_keynoard_end</span><br><span class="line"></span><br><span class="line"><span class="comment">;将来增加新功能</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">scan_keynoard_end:</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">keyboard_input endp</span><br><span class="line"></span><br><span class="line"><span class="comment">;点亮数码管 用来记录分数等信息 使用pc</span></span><br><span class="line">show_digital_tube proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">call</span> clear_digital_buffer</span><br><span class="line">	<span class="comment">;先得到每一个数码管应该显示的数字</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,snake_body_length</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset lednum</span><br><span class="line">	<span class="keyword">sub</span> <span class="built_in">ax</span>,<span class="number">2</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span>,<span class="number">4</span></span><br><span class="line"><span class="symbol">get_one_tube_num:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bl</span>,<span class="number">10</span></span><br><span class="line">	<span class="keyword">div</span> <span class="built_in">bl</span>  	       </span><br><span class="line">	<span class="keyword">mov</span> [<span class="built_in">si</span>],<span class="number">ah</span></span><br><span class="line">	<span class="keyword">xor</span> <span class="number">ah</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">0</span></span><br><span class="line">	<span class="keyword">jz</span> get_one_tube_num_over</span><br><span class="line">	<span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">loop</span> get_one_tube_num</span><br><span class="line"></span><br><span class="line"><span class="symbol">get_one_tube_num_over:</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">;依次显示出来</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset lednum</span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,<span class="number">00000001B</span> </span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span>,<span class="number">4</span></span><br><span class="line"><span class="symbol">show_digital_tube_one_by_one:</span></span><br><span class="line">	<span class="keyword">xor</span> <span class="built_in">bx</span>,<span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bl</span>,[<span class="built_in">si</span>]</span><br><span class="line">	<span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,ledtb[<span class="built_in">bx</span>]	<span class="comment">;段码</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">;clear tube			;清空位码 灭掉所有的灯</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">280h</span>			 </span><br><span class="line">	<span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">282h</span>			<span class="comment">;清空段码</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">0ffh</span></span><br><span class="line">	<span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">;控制数字 段码</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">282h</span></span><br><span class="line">	<span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="comment">;控制哪一个tube去亮 位码</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">280h</span></span><br><span class="line">	<span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">shl</span> <span class="number">ah</span>,<span class="number">1</span></span><br><span class="line">	<span class="comment">;mov bx,1</span></span><br><span class="line">	<span class="comment">;call delay_short</span></span><br><span class="line">	<span class="keyword">loop</span> show_digital_tube_one_by_one</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">;clear tube			;清空位码 灭掉所有的灯</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">280h</span>			 </span><br><span class="line">	<span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">282h</span>			<span class="comment">;清空段码</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">0ffh</span></span><br><span class="line">	<span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">;验证数字算的duibudui</span></span><br><span class="line">	<span class="comment">;mov si,offset lednum</span></span><br><span class="line">	<span class="comment">;add si,3</span></span><br><span class="line">	<span class="comment">;mov cx,4</span></span><br><span class="line"><span class="symbol">disp_led_num:</span></span><br><span class="line">	<span class="comment">;mov al,[si]</span></span><br><span class="line">	<span class="comment">;dec si</span></span><br><span class="line">	<span class="comment">;call dispuib</span></span><br><span class="line">	<span class="comment">;loop disp_led_num</span></span><br><span class="line">	<span class="comment">;call dispcrlf</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">show_digital_tube endp</span><br><span class="line"></span><br><span class="line"><span class="comment">;clear </span></span><br><span class="line">clear_digital_buffer proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset lednum</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">si</span>],<span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">si</span>+<span class="number">1</span>],<span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">si</span>+<span class="number">2</span>],<span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">si</span>+<span class="number">3</span>],<span class="number">0</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">clear_digital_buffer endp</span><br><span class="line"></span><br><span class="line"><span class="comment">;蜂鸣器响 入口参数：响的频率</span></span><br><span class="line">buzzer_sound proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">buzzer_sound endp</span><br><span class="line"></span><br><span class="line"><span class="comment">;写入红色灯亮，ah为行号，al为列号 注意这里 （0，0）在左下角 </span></span><br><span class="line">make_it_red proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">;ah,al hang lie</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset red_buffer</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">xor</span> <span class="number">ah</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">add</span> <span class="built_in">si</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cl</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">00000001B</span></span><br><span class="line">	<span class="keyword">shl</span> <span class="built_in">al</span>,<span class="built_in">cl</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bl</span>,[<span class="built_in">si</span>]</span><br><span class="line">	<span class="keyword">or</span> <span class="built_in">bl</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">mov</span> [<span class="built_in">si</span>],<span class="built_in">bl</span>	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">make_it_red endp</span><br><span class="line"></span><br><span class="line">make_it_green proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line">	<span class="comment">;ah,al hang lie</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset green_buffer</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">xor</span> <span class="number">ah</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">add</span> <span class="built_in">si</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cl</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">00000001B</span></span><br><span class="line">	<span class="keyword">shl</span> <span class="built_in">al</span>,<span class="built_in">cl</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bl</span>,[<span class="built_in">si</span>]</span><br><span class="line">	<span class="keyword">or</span> <span class="built_in">bl</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">mov</span> [<span class="built_in">si</span>],<span class="built_in">bl</span>	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">make_it_green endp</span><br><span class="line"></span><br><span class="line">make_it_dark proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line">	<span class="comment">;ah,al hang lie</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset red_buffer</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">xor</span> <span class="number">ah</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">add</span> <span class="built_in">si</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cl</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">11111110B</span></span><br><span class="line">	<span class="keyword">rol</span> <span class="built_in">al</span>,<span class="built_in">cl</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bl</span>,[<span class="built_in">si</span>]</span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">bl</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">mov</span> [<span class="built_in">si</span>],<span class="built_in">bl</span>	</span><br><span class="line"></span><br><span class="line">	<span class="comment">;ah,al hang lie</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset green_buffer</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">xor</span> <span class="number">ah</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">add</span> <span class="built_in">si</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cl</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">11111110B</span></span><br><span class="line">	<span class="keyword">rol</span> <span class="built_in">al</span>,<span class="built_in">cl</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bl</span>,[<span class="built_in">si</span>]</span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">bl</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">mov</span> [<span class="built_in">si</span>],<span class="built_in">bl</span>	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">make_it_dark endp</span><br><span class="line"></span><br><span class="line">make_all_dark proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset red_buffer</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span>,<span class="number">8</span></span><br><span class="line"><span class="symbol">make_all_dark_again:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">si</span>],<span class="number">0</span></span><br><span class="line">	<span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">loop</span> make_all_dark_again</span><br><span class="line">	</span><br><span class="line"><span class="symbol">make_all_dark_end:</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">make_all_dark endp</span><br><span class="line"></span><br><span class="line">clear_snake_body proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset snake_body_buffer</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span>,<span class="number">128</span></span><br><span class="line"><span class="symbol">clear_snake_body_again:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">si</span>],<span class="number">0</span></span><br><span class="line">	<span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">loop</span> clear_snake_body_again</span><br><span class="line"></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">clear_snake_body endp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;逐列点亮所有的led灯阵  只向上提供可靠的点亮程序，其余不管（例如延时显示、定时改变颜色等）</span></span><br><span class="line">show_led proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">;写入8255方式控制字</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span> , <span class="number">283h</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span> , <span class="number">80h</span></span><br><span class="line">	<span class="keyword">out</span> <span class="built_in">dx</span> , <span class="built_in">al</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">;逐列刷新 红  si控制红行 di控制绿行</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset red_buffer <span class="comment">;控制每一列的红8行</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">di</span>,offset green_buffer <span class="comment">;控制每一列的绿8行</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cl</span>,<span class="number">10000000b</span> <span class="comment">;第一列 颜色通过列线进行输出，281h输出则为第零列为红，282h输出则为第零列为绿 </span></span><br><span class="line"><span class="symbol">again_show_led_col:</span></span><br><span class="line">	<span class="comment">;红列  是控制哪一列是什么颜色的 红:281h 绿：282h 第0列为红色 </span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="built_in">cl</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">281h</span></span><br><span class="line">	<span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="comment">;每一列控制哪一行的红灯亮    这里有问题 对于控制行线来讲，若要红灯亮绿灯不亮则都不会亮（但是由于时间间隔很短，所以我在实验室的效果就是看起来不太亮）</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,[<span class="built_in">si</span>]					<span class="comment">;所以这里必须解决红绿灯互相影响的问题</span></span><br><span class="line">	<span class="keyword">add</span> <span class="built_in">si</span>,<span class="number">1</span>					<span class="comment">;因为时按列亮灯，共用列，所以不可能在一列中同时显示红灯和绿灯。</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">280h</span>					<span class="comment">;要不试试逐个点亮  </span></span><br><span class="line">	<span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">al</span>					<span class="comment">;我觉得实验室器材不太好，必不能支持如此高频率的数据传送</span></span><br><span class="line">								<span class="comment">;所以贪吃蛇只能做到食物和蛇一个颜色，让食物闪烁吧。</span></span><br><span class="line">	<span class="comment">;mov bx ,10000</span></span><br><span class="line">	<span class="comment">;call delay</span></span><br><span class="line">	<span class="comment">;绿列  </span></span><br><span class="line">	<span class="comment">;mov al,cl</span></span><br><span class="line">	<span class="comment">;mov dx,282h</span></span><br><span class="line">	<span class="comment">;out dx,al</span></span><br><span class="line">	<span class="comment">;每一列控制哪一行的绿灯亮</span></span><br><span class="line">	<span class="comment">;mov al,[di]</span></span><br><span class="line">	<span class="comment">;add di,1</span></span><br><span class="line">	<span class="comment">;mov dx,280h	</span></span><br><span class="line">	<span class="comment">;out dx,al</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">;显示完每一列进行delay 以bx为参数</span></span><br><span class="line">	<span class="comment">;mov bx,1</span></span><br><span class="line">	<span class="comment">;call delay_short</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">;关闭所有的列显示 </span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">281h</span></span><br><span class="line">	<span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">280h</span></span><br><span class="line">	<span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">al</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">shr</span> <span class="built_in">cl</span>,<span class="number">1</span> 	<span class="comment">;下一列</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">cl</span>,<span class="number">0</span></span><br><span class="line">	<span class="keyword">jnz</span> again_show_led_col</span><br><span class="line">	</span><br><span class="line">	<span class="comment">;趁这段时间列显示关闭，赶快将行信息输出到数码管（复用pa)</span></span><br><span class="line">	<span class="keyword">call</span> show_digital_tube	</span><br><span class="line"></span><br><span class="line"><span class="symbol">show_led_end:</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">show_led endp</span><br><span class="line"></span><br><span class="line"><span class="comment">;运行贪吃蛇的程序   所有按键信息由中断进行扫描，程序只管从缓冲区中读取即可</span></span><br><span class="line">snake_gluttony proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">;初始化，灭掉所有的灯 并清空蛇的身体</span></span><br><span class="line">	<span class="keyword">call</span> make_all_dark</span><br><span class="line">	<span class="keyword">call</span> clear_snake_body</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset msg_snake_gluttony_game_start</span><br><span class="line">	<span class="keyword">call</span> dispstr</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,<span class="number">1000</span></span><br><span class="line">	<span class="keyword">call</span> delay</span><br><span class="line">	<span class="comment">;初始化贪吃蛇</span></span><br><span class="line">	<span class="comment">;设置蛇的初始位置  head(3,3) tail(3,4) dir=left</span></span><br><span class="line">	<span class="keyword">mov</span> snake_head_position_x,<span class="number">3</span></span><br><span class="line">	<span class="keyword">mov</span> snake_head_position_y,<span class="number">3</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,<span class="number">3</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">3</span></span><br><span class="line">	<span class="keyword">call</span> make_it_red</span><br><span class="line">	<span class="comment">;初始化一节身体 这里有问题</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset snake_body_buffer</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">si</span>],<span class="number">03H</span>	<span class="comment">;横坐标 列 al</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">si</span>+<span class="number">1</span>],<span class="number">04H</span>		<span class="comment">;纵坐标  行 ah</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,<span class="number">4</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">3</span></span><br><span class="line">	<span class="keyword">call</span> make_it_red</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">si</span>+<span class="number">2</span>],<span class="number">03H</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">si</span>+<span class="number">3</span>],<span class="number">05H</span></span><br><span class="line">	<span class="keyword">mov</span> snake_tail_position_x,<span class="number">3</span></span><br><span class="line">	<span class="keyword">mov</span> snake_tail_position_y,<span class="number">5</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,<span class="number">5</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">3</span></span><br><span class="line">	<span class="keyword">call</span> make_it_red</span><br><span class="line">	<span class="comment">;初始化一块食物</span></span><br><span class="line">	<span class="keyword">mov</span> food_x,<span class="number">1</span></span><br><span class="line">	<span class="keyword">mov</span> food_y,<span class="number">5</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,<span class="number">5</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">1</span></span><br><span class="line">	<span class="keyword">call</span> make_it_red</span><br><span class="line">	<span class="comment">;初始化方向为left 蛇身长度为1，此时蛇身只有一个尾巴</span></span><br><span class="line">	<span class="keyword">mov</span> snake_direction,<span class="number">2</span></span><br><span class="line">	<span class="keyword">mov</span> snake_body_length,<span class="number">2</span></span><br><span class="line">	<span class="keyword">mov</span> collision,<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">snake_gluttony_begin:</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">snake_count_time:</span></span><br><span class="line">	<span class="comment">;蛇的身体信息已经全部适配为灯亮的信息</span></span><br><span class="line">	<span class="keyword">call</span> show_led</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,sync_time_buffer</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bl</span>,<span class="number">10</span></span><br><span class="line">	<span class="keyword">div</span> <span class="built_in">bl</span>		<span class="comment">;得到余数在ah中 商在al</span></span><br><span class="line">	<span class="keyword">xor</span> <span class="number">ah</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">ax</span>,[snake_time]		<span class="comment">;只要和之前的时间不相等就刷新</span></span><br><span class="line">	<span class="keyword">jnz</span> snake_flush</span><br><span class="line">	<span class="comment">;为防止因为溢出而造成的错误判断</span></span><br><span class="line">	<span class="keyword">mov</span> [snake_time],<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">jmp</span> snake_count_time</span><br><span class="line"><span class="comment">;snake的时间到了，可以刷新  ;现在要解决的问题是蛇不会移动</span></span><br><span class="line"><span class="symbol">snake_flush:</span></span><br><span class="line">	<span class="comment">;ax中存放当前贪吃蛇时间，放入snake_time</span></span><br><span class="line">	<span class="keyword">mov</span> [snake_time],<span class="built_in">ax</span></span><br><span class="line">	<span class="comment">;判断按键，进行贪吃蛇的逻辑操作  ;蛇的前近方向 3:上  0:下  2:左   1:右</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,keyboard_input_buffer</span><br><span class="line">	<span class="comment">;处理键盘的W A S D 改变方向 10-13位存放			;用开关连入 8255的pc 进行输入 </span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cl</span>,<span class="number">10</span></span><br><span class="line">	<span class="keyword">shr</span> <span class="built_in">ax</span>,<span class="built_in">cl</span></span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">00001111B</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">00000001B</span></span><br><span class="line">	<span class="keyword">jz</span> snake_fulsh_process_key_w</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">00000010B</span></span><br><span class="line">	<span class="keyword">jz</span> snake_fulsh_process_key_a</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">00000100B</span></span><br><span class="line">	<span class="keyword">jz</span> snake_fulsh_process_key_s</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">00001000B</span></span><br><span class="line">	<span class="keyword">jz</span> snake_fulsh_process_key_d</span><br><span class="line"></span><br><span class="line">	<span class="comment">;没有任何按键按下则直接进行处理</span></span><br><span class="line">	<span class="keyword">jmp</span> snake_flush_process</span><br><span class="line"></span><br><span class="line"><span class="comment">;处理按键w</span></span><br><span class="line"><span class="symbol">snake_fulsh_process_key_w:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,snake_direction</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">0</span>	<span class="comment">;当前方向不为下时改变方向为上</span></span><br><span class="line">	<span class="keyword">jz</span> snake_flush_process</span><br><span class="line">	<span class="keyword">mov</span> snake_direction,<span class="number">3</span></span><br><span class="line">	<span class="keyword">jmp</span> snake_flush_process</span><br><span class="line"><span class="comment">;处理按键s</span></span><br><span class="line"><span class="symbol">snake_fulsh_process_key_s:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,snake_direction</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">3</span>	<span class="comment">;当前方向不为上时改变方向为下</span></span><br><span class="line">	<span class="keyword">jz</span> snake_flush_process</span><br><span class="line">	<span class="keyword">mov</span> snake_direction,<span class="number">0</span></span><br><span class="line">	<span class="keyword">jmp</span> snake_flush_process</span><br><span class="line"><span class="comment">;处理按键a</span></span><br><span class="line"><span class="symbol">snake_fulsh_process_key_a:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,snake_direction</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">1</span>	<span class="comment">;当前方向不为右时改变方向为左</span></span><br><span class="line">	<span class="keyword">jz</span> snake_flush_process</span><br><span class="line">	<span class="keyword">mov</span> snake_direction,<span class="number">2</span></span><br><span class="line">	<span class="keyword">jmp</span> snake_flush_process</span><br><span class="line"><span class="comment">;处理按键d</span></span><br><span class="line"><span class="symbol">snake_fulsh_process_key_d:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,snake_direction</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">2</span>	<span class="comment">;当前方向不为左时改变方向为右</span></span><br><span class="line">	<span class="keyword">jz</span> snake_flush_process</span><br><span class="line">	<span class="keyword">mov</span> snake_direction,<span class="number">1</span></span><br><span class="line">	<span class="keyword">jmp</span> snake_flush_process</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;按键处理完了，处理贪吃蛇的位置</span></span><br><span class="line"><span class="symbol">snake_flush_process:</span></span><br><span class="line"><span class="comment">;现在已经得到了贪吃蛇的方向。输出检查是否成功</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">;将按键信息清零</span></span><br><span class="line"><span class="symbol">snake_flush_process_clear_key:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,keyboard_input_buffer</span><br><span class="line">	<span class="comment">;处理键盘的W A S D 都置为零</span></span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">ax</span>,<span class="number">1100001111111111B</span></span><br><span class="line">	<span class="keyword">mov</span> keyboard_input_buffer,<span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;位置刷新，根据上一次是否吃了食物决定身体更新策略</span></span><br><span class="line"><span class="comment">;若上一次刷新吃到了食物，则这一次蛇头变为蛇尾的一部分，然后蛇头向前走一步，若没有吃到，则从最后一节开始，每一节的位置时前一个的位置，第一个位置更新为蛇头的位置。</span></span><br><span class="line"><span class="symbol">move_snake_body:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,@data</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ds</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="comment">;每个位置需要两个字节</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset snake_body_buffer	</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">di</span>,snake_body_length		<span class="comment">;其实有没有吃都从最后一节向前更新即可，无非是length的不同</span></span><br><span class="line">	<span class="keyword">dec</span> <span class="built_in">di</span>			<span class="comment">;减一 方便指向每一节</span></span><br><span class="line">	<span class="keyword">shl</span> <span class="built_in">di</span>,<span class="number">1</span>	</span><br><span class="line">	<span class="keyword">add</span> <span class="built_in">di</span>,<span class="built_in">si</span>	<span class="comment">;指向最后一节 目标地址</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,<span class="built_in">di</span></span><br><span class="line">	<span class="keyword">sub</span> <span class="built_in">si</span>,<span class="number">2</span>	<span class="comment">;源地址</span></span><br><span class="line"><span class="comment">;更新蛇的身体的每一节，第一节不更新</span></span><br><span class="line"><span class="symbol">move_snake_body_every_section:</span></span><br><span class="line">	<span class="comment">;先将旧的尾巴灭掉</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,snake_tail_position_y</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,snake_tail_position_x</span><br><span class="line">	<span class="keyword">call</span> make_it_dark</span><br><span class="line">	<span class="comment">;更新蛇的尾巴信息 si所指向的</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,[<span class="built_in">si</span>]</span><br><span class="line">	<span class="keyword">mov</span> snake_tail_position_x,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,[<span class="built_in">si</span>+<span class="number">1</span>]</span><br><span class="line">	<span class="keyword">mov</span> snake_tail_position_y,<span class="built_in">al</span></span><br><span class="line">	<span class="comment">;串传送的个数 （word）第一节不传送</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span>,snake_body_length</span><br><span class="line">	<span class="keyword">dec</span> <span class="built_in">cx</span>	</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,@data</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ds</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">es</span>,<span class="built_in">ax</span>	</span><br><span class="line">	<span class="keyword">std</span>  		<span class="comment">;反向传送		</span></span><br><span class="line">	<span class="keyword">rep</span> <span class="keyword">movsw</span> 		</span><br><span class="line"></span><br><span class="line"><span class="comment">;更新第一节，将头的位置赋予即可</span></span><br><span class="line"><span class="symbol">move_snake_body_first_section:</span></span><br><span class="line">	<span class="comment">;高位存放纵坐标</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset snake_body_buffer</span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,snake_head_position_y</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,snake_head_position_x</span><br><span class="line">	<span class="keyword">mov</span> [<span class="built_in">si</span>],<span class="built_in">ax</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">;位置刷新，将贪吃蛇头朝对应方向移动一格</span></span><br><span class="line"><span class="symbol">move_snake_head:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cl</span>,snake_direction</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">cl</span>,<span class="number">3</span>	<span class="comment">;上</span></span><br><span class="line">	<span class="keyword">jz</span> move_snake_head_up</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">cl</span>,<span class="number">0</span>	<span class="comment">;下</span></span><br><span class="line">	<span class="keyword">jz</span> move_snake_head_down</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">cl</span>,<span class="number">2</span> 	<span class="comment">;左</span></span><br><span class="line">	<span class="keyword">jz</span> move_snake_head_left</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">cl</span>,<span class="number">1</span>	<span class="comment">;右</span></span><br><span class="line">	<span class="keyword">jz</span> move_snake_head_right</span><br><span class="line">	<span class="comment">;不可能哪个方向都不对</span></span><br><span class="line">	<span class="comment">;jmp move_snake_head_direction_error</span></span><br><span class="line">	<span class="keyword">jmp</span> move_snake_head_left</span><br><span class="line"><span class="comment">;下</span></span><br><span class="line"><span class="symbol">move_snake_head_down:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,snake_head_position_y</span><br><span class="line">	<span class="keyword">sub</span> <span class="number">ah</span>,<span class="number">1</span>	</span><br><span class="line">	<span class="keyword">jnc</span> snake_judge_conflict</span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,<span class="number">7</span>	<span class="comment">;小于0，则从下面钻出来</span></span><br><span class="line">	<span class="keyword">jmp</span> snake_judge_conflict</span><br><span class="line"><span class="comment">;上</span></span><br><span class="line"><span class="symbol">move_snake_head_up:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,snake_head_position_y</span><br><span class="line">	<span class="keyword">add</span> <span class="number">ah</span>,<span class="number">1</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="number">ah</span>,<span class="number">8</span>	</span><br><span class="line">	<span class="keyword">jnz</span> snake_judge_conflict</span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,<span class="number">0</span>	<span class="comment">;等于8，超界，则从上面钻出来</span></span><br><span class="line">	<span class="keyword">jmp</span> snake_judge_conflict</span><br><span class="line"><span class="comment">;左</span></span><br><span class="line"><span class="symbol">move_snake_head_left:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,snake_head_position_x</span><br><span class="line">	<span class="keyword">sub</span> <span class="built_in">al</span>,<span class="number">1</span>	</span><br><span class="line">	<span class="keyword">jnc</span> snake_judge_conflict</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">7</span>	<span class="comment">;小于0，则从下右面钻出来</span></span><br><span class="line">	<span class="keyword">jmp</span> snake_judge_conflict</span><br><span class="line"><span class="comment">;右</span></span><br><span class="line"><span class="symbol">move_snake_head_right:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,snake_head_position_x</span><br><span class="line">	<span class="keyword">add</span> <span class="built_in">al</span>,<span class="number">1</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">8</span>	</span><br><span class="line">	<span class="keyword">jnz</span> snake_judge_conflict</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">0</span>	<span class="comment">;等于8 ，则从左面钻出来</span></span><br><span class="line">	<span class="keyword">jmp</span> snake_judge_conflict</span><br><span class="line"><span class="comment">;判断是否冲突 </span></span><br><span class="line"><span class="symbol">snake_judge_conflict:</span></span><br><span class="line">	<span class="comment">;此时 蛇头坐标为（ah,al)(行列)   ah中存放纵坐标，代表行值，al存放横坐标，代表列值</span></span><br><span class="line">	<span class="keyword">mov</span> snake_head_position_y,<span class="number">ah</span> 	<span class="comment">;行，纵坐标</span></span><br><span class="line">	<span class="keyword">mov</span> snake_head_position_x,<span class="built_in">al</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">call</span> show_snake_info</span><br><span class="line"></span><br><span class="line"><span class="comment">;首先判断是否蛇头和食物重合，若没有重合则蛇尾向前一步走，若重合则蛇尾不动，将蛇的身体信息全部向后移动一位</span></span><br><span class="line"><span class="comment">;清空上一次吃到食物的信息</span></span><br><span class="line"><span class="comment">;将当前食物位置存放在（bh,bl)中和（ah,al）比较</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">bh</span>,food_y	<span class="comment">;行</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bl</span>,food_x	<span class="comment">;列</span></span><br><span class="line">	<span class="keyword">mov</span> food_eaten,<span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,snake_head_position_y</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,snake_head_position_x</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="built_in">bl</span></span><br><span class="line">	<span class="keyword">jnz</span> snake_judge_conflict_not_eat</span><br><span class="line">	<span class="keyword">cmp</span> <span class="number">ah</span>,<span class="number">bh</span></span><br><span class="line">	<span class="keyword">jnz</span> snake_judge_conflict_not_eat</span><br><span class="line">	<span class="comment">;下面时蛇吃了食物</span></span><br><span class="line">	<span class="keyword">mov</span> food_eaten,<span class="number">1</span></span><br><span class="line">	<span class="keyword">add</span> snake_body_length,<span class="number">1</span></span><br><span class="line"><span class="comment">;生成新的食物 位置为（7-当前蛇头x,7-当前蛇尾y)</span></span><br><span class="line"><span class="symbol">snake_create_new_food:</span></span><br><span class="line">	<span class="comment">;原来的食物不用灭，因为现在蛇头在这里</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,food_y</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,food_x</span><br><span class="line">	<span class="keyword">call</span> make_it_dark</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">7</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bl</span>,snake_head_position_x</span><br><span class="line">	<span class="keyword">sub</span> <span class="built_in">ax</span>,<span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">mov</span> food_x,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">7</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bl</span>,snake_tail_position_y</span><br><span class="line">	<span class="keyword">sub</span> <span class="built_in">ax</span>,<span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">mov</span> food_y,<span class="built_in">al</span></span><br><span class="line">	</span><br><span class="line"><span class="comment">;蛇这一步没有吃到食物</span></span><br><span class="line"><span class="symbol">snake_judge_conflict_not_eat:</span></span><br><span class="line">	<span class="keyword">mov</span> food_eaten,<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;判断是否碰撞到自己  头坐标(al,ah)   身体坐标（bl,bh）</span></span><br><span class="line"><span class="symbol">snake_judge_collision:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,snake_head_position_y</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,snake_head_position_x</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset snake_body_buffer</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span>,snake_body_length</span><br><span class="line"><span class="symbol">snake_judge_collision_again:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bl</span>,[<span class="built_in">si</span>]</span><br><span class="line">	<span class="keyword">mov</span> <span class="number">bh</span>,[<span class="built_in">si</span>+<span class="number">1</span>]</span><br><span class="line">	<span class="keyword">add</span> <span class="built_in">si</span>,<span class="number">2</span></span><br><span class="line">	<span class="keyword">cmp</span> <span class="number">ah</span>,<span class="number">bh</span></span><br><span class="line">	<span class="keyword">jnz</span> snake_judge_collision_again_not_collision</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="built_in">bl</span></span><br><span class="line">	<span class="keyword">jnz</span> snake_judge_collision_again_not_collision</span><br><span class="line">	<span class="comment">;碰撞了</span></span><br><span class="line"><span class="symbol">snake_judge_collision_again_collision:</span></span><br><span class="line">	<span class="keyword">mov</span> collision,<span class="number">1</span></span><br><span class="line">	<span class="keyword">jmp</span> snake_gluttony_end</span><br><span class="line"><span class="symbol">snake_judge_collision_again_not_collision:</span></span><br><span class="line">	<span class="keyword">loop</span> snake_judge_collision_again</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">;在led点阵中点亮蛇阵 使用红色</span></span><br><span class="line"><span class="symbol">snake_lighten_led_red:</span></span><br><span class="line">	<span class="comment">;首先点亮食物</span></span><br><span class="line">	<span class="comment">;写入红色灯亮，ah为行号，al为列号 注意这里 （0，0）在左下角    即ah为y al为x</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,food_y</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,food_x</span><br><span class="line">	<span class="keyword">call</span> make_it_red</span><br><span class="line">	<span class="comment">;点亮头</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,snake_head_position_y</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,snake_head_position_x</span><br><span class="line">	<span class="keyword">call</span> make_it_red</span><br><span class="line">	<span class="comment">;点亮身体  记得在更新身体的时候灭掉尾巴的灯</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset snake_body_buffer</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span>,snake_body_length</span><br><span class="line">	<span class="keyword">dec</span> <span class="built_in">cx</span></span><br><span class="line"><span class="symbol">snake_lighten_led_red_body:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,[<span class="built_in">si</span>]</span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,[<span class="built_in">si</span>+<span class="number">1</span>]</span><br><span class="line">	<span class="keyword">call</span> make_it_red</span><br><span class="line">	<span class="keyword">add</span> <span class="built_in">si</span>,<span class="number">2</span></span><br><span class="line">	<span class="keyword">loop</span> snake_lighten_led_red_body</span><br><span class="line"></span><br><span class="line">	<span class="keyword">jmp</span> snake_gluttony_begin</span><br><span class="line"></span><br><span class="line"><span class="symbol">snake_gluttony_end:</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">snake_gluttony endp</span><br><span class="line"></span><br><span class="line"><span class="comment">;延时 bx为传入的参数</span></span><br><span class="line">delay proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"><span class="symbol">again1_delay:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span> , <span class="number">0</span></span><br><span class="line"><span class="symbol">again2_delay:</span></span><br><span class="line">	<span class="keyword">nop</span></span><br><span class="line">	<span class="keyword">loop</span> again2_delay</span><br><span class="line">	<span class="keyword">dec</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">jnz</span> again1_delay</span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">delay endp</span><br><span class="line"></span><br><span class="line"><span class="comment">;短延时 bx为传入的参数 为了增加亮度</span></span><br><span class="line">delay_short proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"><span class="symbol">again1_delay_short:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span> , <span class="number">0ffh</span></span><br><span class="line"><span class="symbol">again2_delay_short:</span></span><br><span class="line">	<span class="keyword">nop</span></span><br><span class="line">	<span class="keyword">loop</span> again2_delay_short</span><br><span class="line">	<span class="keyword">dec</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">jnz</span> again1_delay_short</span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">delay_short endp</span><br><span class="line"></span><br><span class="line"><span class="comment">;8253 设置方式控制字为 00110100 计时器0先低后高方式二二进制 初值为 1000  连在1MHZ上  每10ms进行一次中断 out口接在主板irq上（主板irq已经固定在了irq10)</span></span><br><span class="line"></span><br><span class="line">set_int proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">cli</span></span><br><span class="line">	<span class="comment">;mov si,offset msgsetint</span></span><br><span class="line">	<span class="comment">;call dispstr </span></span><br><span class="line"><span class="comment">;设置8253 </span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">28bh</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">00110110B</span></span><br><span class="line">	<span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">288h</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">1000</span></span><br><span class="line">	<span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">ah</span></span><br><span class="line">	<span class="keyword">out</span> <span class="built_in">dx</span>,<span class="built_in">al</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;设置中断处理程序 irq10使用0B号中断</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">3572h</span></span><br><span class="line">	<span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">	<span class="keyword">mov</span> int_0b_seg,<span class="built_in">es</span></span><br><span class="line">	<span class="keyword">mov</span> int_0b_off,<span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ds</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="built_in">seg</span> int_irq10</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ds</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>,offset int_irq10</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">2572h</span></span><br><span class="line">	<span class="keyword">int</span> <span class="number">21h</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ds</span></span><br><span class="line">	<span class="comment">;imr</span></span><br><span class="line">	<span class="keyword">in</span> <span class="built_in">al</span>,<span class="number">0a1h</span></span><br><span class="line">	<span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">0fbh</span></span><br><span class="line">	<span class="keyword">out</span> <span class="number">0a1h</span>,<span class="built_in">al</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">;EOI</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">20h</span></span><br><span class="line">	<span class="keyword">out</span> <span class="number">0a0h</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">out</span> <span class="number">20h</span>,<span class="built_in">al</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">sti</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">set_int endp</span><br><span class="line"></span><br><span class="line"><span class="comment">;中断处理程序 每一次中断时10ms，这10ms用来扫描输入和同步时间量</span></span><br><span class="line">int_irq10 proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">;mov si,offset msgintirq10</span></span><br><span class="line">	<span class="comment">;call dispstr</span></span><br><span class="line"><span class="comment">;设置时间量</span></span><br><span class="line">	<span class="keyword">add</span> sync_time_buffer,<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;键盘输入  键盘可以用的话就用键盘吧</span></span><br><span class="line">	<span class="keyword">call</span> keyboard_input</span><br><span class="line"></span><br><span class="line"><span class="comment">;红外输入</span></span><br><span class="line">	<span class="comment">;call infrared_input</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">;EOI</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">20h</span></span><br><span class="line">	<span class="keyword">out</span> <span class="number">0a0h</span>,<span class="built_in">al</span></span><br><span class="line">	<span class="keyword">out</span> <span class="number">20h</span>,<span class="built_in">al</span></span><br><span class="line"><span class="symbol">int_irq10_end:</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">iret</span></span><br><span class="line">int_irq10 endp</span><br><span class="line"></span><br><span class="line">dispstr proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"><span class="symbol">dps1:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,[<span class="built_in">si</span>]</span><br><span class="line">	<span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">0</span></span><br><span class="line">	<span class="keyword">jz</span> dps2</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">bx</span>,<span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">ah</span>,<span class="number">0eh</span></span><br><span class="line">	<span class="keyword">int</span> <span class="number">10h</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">jmp</span> dps1</span><br><span class="line"><span class="symbol">dps2:</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">dispstr endp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">show_snake_info proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset msg_direction</span><br><span class="line">	<span class="keyword">call</span> dispstr</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,snake_direction</span><br><span class="line">	<span class="keyword">call</span> dispuib</span><br><span class="line">	<span class="keyword">call</span> dispcrlf</span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset msg_snake_body_position</span><br><span class="line">	<span class="keyword">call</span> dispstr</span><br><span class="line">	<span class="comment">;头</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,snake_head_position_x</span><br><span class="line">	<span class="keyword">call</span> dispuib</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,snake_head_position_y</span><br><span class="line">	<span class="keyword">call</span> dispuib</span><br><span class="line">	<span class="comment">;身</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">si</span>,offset snake_body_buffer</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,snake_body_length</span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cl</span>,<span class="number">1</span></span><br><span class="line">	<span class="keyword">shl</span> <span class="built_in">ax</span>,<span class="built_in">cl</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span>,<span class="built_in">ax</span></span><br><span class="line"><span class="symbol">snake_show_body_again:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">al</span>,[<span class="built_in">si</span>]</span><br><span class="line">	<span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">call</span> dispuib</span><br><span class="line">	<span class="keyword">loop</span> snake_show_body_again</span><br><span class="line"></span><br><span class="line">	<span class="keyword">call</span> dispcrlf</span><br><span class="line"></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">show_snake_info endp</span><br><span class="line"></span><br><span class="line"><span class="comment">;清屏</span></span><br><span class="line">clear_screen proc</span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">push</span> <span class="built_in">di</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">0b800h</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">es</span>,<span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">cx</span>,<span class="number">4000</span></span><br><span class="line">	<span class="keyword">xor</span> <span class="built_in">si</span>,<span class="built_in">si</span></span><br><span class="line"><span class="symbol">clear_screen_again:</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> <span class="built_in">es</span>:[<span class="built_in">si</span>],<span class="number">0</span></span><br><span class="line">	<span class="keyword">inc</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">loop</span> clear_screen_again</span><br><span class="line"></span><br><span class="line">	<span class="comment">;入口参数：AH＝02H</span></span><br><span class="line">	<span class="comment">;BH＝显示页码</span></span><br><span class="line">	<span class="comment">;DH＝行(Y坐标)</span></span><br><span class="line">	<span class="comment">;DL＝ 列(X坐标)</span></span><br><span class="line">	<span class="comment">;设置光标位置</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">02h</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="number">bh</span>,<span class="number">0</span></span><br><span class="line">	<span class="keyword">mov</span> <span class="built_in">dx</span>,<span class="number">0</span></span><br><span class="line">	<span class="keyword">int</span> <span class="number">10h</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">di</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">si</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">dx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">cx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">bx</span></span><br><span class="line">	<span class="keyword">pop</span> <span class="built_in">ax</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">clear_screen endp</span><br><span class="line"></span><br><span class="line">	end start</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://myblog.cuimouren.cn/2021/07/03/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%9B%9B-%E4%BA%8C%E5%8F%89%E6%9F%A5%E6%89%BE%E6%A0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="崔文耀">
      <meta itemprop="description" content="Hello, here is wenyao's space, how do you come in???">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="这里是文耀的space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="../../2021/07/03/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%9B%9B-%E4%BA%8C%E5%8F%89%E6%9F%A5%E6%89%BE%E6%A0%91/" class="post-title-link" itemprop="url">数据结构 四 二叉查找树</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-03 14:50:33" itemprop="dateCreated datePublished" datetime="2021-07-03T14:50:33+08:00">2021-07-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-04 20:08:14" itemprop="dateModified" datetime="2021-07-04T20:08:14+08:00">2021-07-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">数据结构</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%A0%91/" itemprop="url" rel="index"><span itemprop="name">树</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="二叉查找树"><a href="#二叉查找树" class="headerlink" title="二叉查找树"></a>二叉查找树</h1><p><strong>二叉查找树是一个有序的树，使用二叉查找树可以极大的方便查找排好序的元素</strong></p>
<p>二叉查找树保证其中每一个结点的右子树都比他大，左子树都比他小，即左小右大。设x为二叉查找树中的一个结点，x节点包含关键字key，节点x的key值记为key[x]。如果y是x的左子树中的一个结点，则key[y] &lt;= key[x]；如果y是x的右子树的一个结点，则key[y] &gt;= key[x]。</p>
<p><strong>前驱</strong></p>
<p>在中序遍历中排在某元素前面的那个元素是该元素的前驱，当然第一个元素是没有前驱的。在数组型的二叉树中，前驱就放在其前面。<br>寻找前驱的算法如下：<br>    1. 若一个结点有左子树，则左子树的最右侧即为所求前驱。（也就是左边的最大值）<br>    2. 若没有左子树，则从这个结点向上遍历，直到找到某个结点是其父节点的右子树，则这个结点的父节点即为所求。所不存在则说明没有前驱。</p>
<p><strong>后继</strong></p>
<p>在中序遍历中排在某元素后面的那个元素是该元素的后继，当然最后一个元素是没有后继的。在数组型的二叉树中，后继就放在其后面。<br>寻找后继的算法如下：<br>    1. 若一个结点有右子树，则右子树的最左侧即为所求前驱。（也就是右边的最小值）<br>    2. 若没有右子树，则从这个结点向上遍历，直到找到某个结点是其父节点的左子树，则这个结点的父节点即为所求。所不存在则说明没有后继。</p>
<h2 id="ADT"><a href="#ADT" class="headerlink" title="ADT"></a>ADT</h2><ol>
<li>构造空树</li>
<li>销毁一个树</li>
<li>判断树是否为空</li>
<li>插入一个结点</li>
<li>删除一个结点</li>
<li>打印二叉树</li>
<li>前序遍历</li>
<li>中序遍历</li>
<li>后序遍历</li>
<li>根据值的大小查找结点。</li>
<li>查找子树的最小结点</li>
<li>查找子树的最大结点</li>
<li>查找某个结点的前驱</li>
<li>查找某个结点的后继</li>
</ol>
<h2 id="二叉查找树的实现"><a href="#二叉查找树的实现" class="headerlink" title="二叉查找树的实现"></a>二叉查找树的实现</h2><h3 id="接口说明"><a href="#接口说明" class="headerlink" title="接口说明"></a>接口说明</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//二叉查找树</span></span><br><span class="line"><span class="comment">// binary search tree</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">BSTree</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> key; <span class="comment">//可以用Item代替，不过为了方便学习，就不这样了。</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BSTree</span> *<span class="title">parent</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BSTree</span> *<span class="title">left</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BSTree</span> *<span class="title">right</span>;</span></span><br><span class="line">&#125; * BSTree;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">InitBSTree</span><span class="params">(BSTree *tree)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//销毁</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">DestroyBSTree</span><span class="params">(BSTree *tree)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//空</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">EmptyBSTree</span><span class="params">(BSTree *tree)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//插入</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">InsertBSTree</span><span class="params">(BSTree *tree, <span class="keyword">int</span> key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">DeleteBSTree</span><span class="params">(BSTree *tree, <span class="keyword">int</span> key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//打印二叉树 0代表根节点 1代表左边 -1代表右</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Print_BSTree</span><span class="params">(BSTree *tree, <span class="keyword">int</span> direction)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前序遍历</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Preorder_BSTree</span><span class="params">(BSTree *tree)</span></span>;</span><br><span class="line"><span class="comment">// 中序遍历</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Inorder_BSTree</span><span class="params">(BSTree *tree)</span></span>;</span><br><span class="line"><span class="comment">// 后序遍历</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Postorder_BSTree</span><span class="params">(BSTree *tree)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (递归实现)查找&quot;二叉树x&quot;中键值为key的节点</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Search_BSTree</span><span class="params">(BSTree *tree, <span class="keyword">int</span> key, BSTree *tree_save)</span></span>;</span><br><span class="line"><span class="comment">// (非递归实现)查找&quot;二叉树x&quot;中键值为key的节点</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">iterative_bstree_search</span><span class="params">(BSTree *tree, <span class="keyword">int</span> key, BSTree *tree_save)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找最小结点：返回tree为根结点的二叉树的最小结点。</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Min_BSTree</span><span class="params">(BSTree *tree, BSTree *tree_save)</span></span>;</span><br><span class="line"><span class="comment">// 查找最大结点：返回tree为根结点的二叉树的最大结点。</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Max_BSTree</span><span class="params">(BSTree *tree, BSTree *tree_save)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 找结点(x)的后继结点。即，查找&quot;二叉树中数据值大于该结点&quot;的&quot;最小结点&quot;。</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Sucessor_BSTree</span><span class="params">(BSTree *tree, BSTree *x, BSTree *sucessor)</span></span>;</span><br><span class="line"><span class="comment">// 找结点(x)的前驱结点。即，查找&quot;二叉树中数据值小于该结点&quot;的&quot;最大结点&quot;。</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Predecessor_BSTree</span><span class="params">(BSTree *tree, BSTree *x, BSTree *prede)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AutoFillBSTree</span><span class="params">(BSTree *tree, <span class="keyword">int</span> size)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="接口实现"><a href="#接口实现" class="headerlink" title="接口实现"></a>接口实现</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;bstree.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">InitBSTree</span><span class="params">(BSTree *tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    (*tree) = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;初始化成功\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//销毁</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">DestroyBSTree</span><span class="params">(BSTree *tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((*tree) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*tree)-&gt;left == <span class="literal">NULL</span> &amp;&amp; (*tree)-&gt;right == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">free</span>(tree);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        DestroyBSTree(&amp;((*tree)-&gt;left));</span><br><span class="line">        DestroyBSTree(&amp;((*tree)-&gt;right));</span><br><span class="line">        <span class="keyword">if</span> ((*tree) == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;销毁成功\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;销毁失败\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((*tree) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;销毁成功\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//空</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">EmptyBSTree</span><span class="params">(BSTree *tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((*tree) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;空\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;不空\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//插入</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">InsertBSTree</span><span class="params">(BSTree *tree, <span class="keyword">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BSTree <span class="keyword">new</span> = (BSTree)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct BSTree));</span><br><span class="line">    <span class="keyword">new</span>-&gt;key = key;</span><br><span class="line">    <span class="keyword">new</span>-&gt;left = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">new</span>-&gt;right = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">new</span>-&gt;parent = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//左低右高</span></span><br><span class="line">    <span class="keyword">if</span> (EmptyBSTree(tree))</span><br><span class="line">    &#123;</span><br><span class="line">        (*tree) = <span class="keyword">new</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;插入成功 %d\n&quot;</span>, key);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//寻找位置进行插入；</span></span><br><span class="line">        BSTree p = (*tree);</span><br><span class="line">        <span class="keyword">while</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//小 往左走</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">new</span>-&gt;key &lt; p-&gt;key)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (p-&gt;left == <span class="literal">NULL</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//左边为空，则插入到左边即可</span></span><br><span class="line">                    p-&gt;left = <span class="keyword">new</span>;</span><br><span class="line">                    <span class="keyword">new</span>-&gt;parent = p;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;插入成功 %d 到 %d 的左边\n&quot;</span>, key, p-&gt;key);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//左边不空，继续寻找</span></span><br><span class="line">                    p = p-&gt;left;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//大 往右走</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">new</span>-&gt;key &gt; p-&gt;key)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (p-&gt;right == <span class="literal">NULL</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//右边为空，则插入到右边即可</span></span><br><span class="line">                    p-&gt;right = <span class="keyword">new</span>;</span><br><span class="line">                    <span class="keyword">new</span>-&gt;parent = p;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;插入成功 %d 到 %d 的右边\n&quot;</span>, key, p-&gt;key);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//右边不空，继续寻找</span></span><br><span class="line">                    p = p-&gt;right;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">new</span>-&gt;key == p-&gt;key)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;不允许相等的元素存在,插入失败\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;插入失败\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">DeleteBSTree</span><span class="params">(BSTree *tree, <span class="keyword">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//删除的是根节点 删除叶子节点 删除的结点没有左子树或者右子树</span></span><br><span class="line">    <span class="comment">//空</span></span><br><span class="line">    <span class="keyword">if</span> (EmptyBSTree(tree))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;删除失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    BSTree p = (*tree);</span><br><span class="line">    <span class="comment">//p指向树的每一个结点（其实就是相应内存区域），改变 p-&gt;key，就是改变这块内存上key的值。所以才可以实现使用p遍历并更改结点。</span></span><br><span class="line">    <span class="comment">//其实，p-&gt;key==(*p).key  对(*p).key很自然就修改了其值，这点很容易理解。</span></span><br><span class="line">    <span class="comment">//假设这棵树在一个树的左边  解决删除的是根节点的问题</span></span><br><span class="line">    BSTree fakeroot = (BSTree)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct BSTree));</span><br><span class="line">    fakeroot-&gt;left = p;</span><br><span class="line">    fakeroot-&gt;right = <span class="literal">NULL</span>;</span><br><span class="line">    fakeroot-&gt;parent = <span class="literal">NULL</span>;</span><br><span class="line">    p-&gt;parent = fakeroot;</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;key == (*p).key)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;true\n&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//printf(&quot;1111111111111111111111\n&quot;);</span></span><br><span class="line">        <span class="keyword">if</span> (p-&gt;key &lt; key)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//向右走</span></span><br><span class="line">            <span class="comment">//printf(&quot;向右走\n&quot;);</span></span><br><span class="line">            p = p-&gt;right;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p-&gt;key &gt; key)</span><br><span class="line">        &#123;</span><br><span class="line">            p = p-&gt;left;</span><br><span class="line">            <span class="comment">//printf(&quot;向左走\n&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p-&gt;key == key)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//找到了，进行删除 p</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;找到了，进行删除 p %d\n&quot;</span>, p-&gt;key);</span><br><span class="line">            BSTree l = p-&gt;left;</span><br><span class="line">            BSTree r = p-&gt;right;</span><br><span class="line">            <span class="comment">//p为左子树</span></span><br><span class="line">            <span class="keyword">if</span> (p-&gt;parent-&gt;left == p)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//p没有左子树</span></span><br><span class="line">                <span class="keyword">if</span> ((l == <span class="literal">NULL</span>) &amp;&amp; (r != <span class="literal">NULL</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    p-&gt;parent-&gt;left = r;</span><br><span class="line">                    r-&gt;parent = p-&gt;parent;</span><br><span class="line">                    <span class="built_in">free</span>(p);</span><br><span class="line">                    p = <span class="literal">NULL</span>;</span><br><span class="line">                    (*tree) = fakeroot-&gt;left;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;删除成功\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//p没有右子树</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((r == <span class="literal">NULL</span>) &amp;&amp; (l != <span class="literal">NULL</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    p-&gt;parent-&gt;left = l;</span><br><span class="line">                    l-&gt;parent = p-&gt;parent;</span><br><span class="line">                    <span class="built_in">free</span>(p);</span><br><span class="line">                    p = <span class="literal">NULL</span>;</span><br><span class="line">                    (*tree) = fakeroot-&gt;left;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;删除成功\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//p左右子树都有</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((r != <span class="literal">NULL</span>) &amp;&amp; (l != <span class="literal">NULL</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//p为左节点，应为右侧的高 继位</span></span><br><span class="line">                    p-&gt;parent-&gt;left = r;</span><br><span class="line">                    <span class="comment">//将l插入到r的最左下</span></span><br><span class="line">                    <span class="keyword">while</span> (r-&gt;left != <span class="literal">NULL</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        r = r-&gt;left;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//找到了右子树的最左边，插入左子树</span></span><br><span class="line">                    r-&gt;left = l;</span><br><span class="line">                    l-&gt;parent = r;</span><br><span class="line">                    <span class="built_in">free</span>(p);</span><br><span class="line">                    p = <span class="literal">NULL</span>;</span><br><span class="line">                    (*tree) = fakeroot-&gt;left;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;删除成功\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//左右子树都没有</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    p-&gt;parent-&gt;left = <span class="literal">NULL</span>;</span><br><span class="line">                    <span class="built_in">free</span>(p);</span><br><span class="line">                    p = <span class="literal">NULL</span>;</span><br><span class="line">                    (*tree) = fakeroot-&gt;left;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;删除成功\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//p为右子树</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//将 右子树顶替p的位置，然后将左子树插入到右子树的最左下面即可，因为右边比左边大。</span></span><br><span class="line">                <span class="comment">//p为右节点，应为左侧的低 继位</span></span><br><span class="line">                <span class="comment">//p没有左子树</span></span><br><span class="line">                <span class="keyword">if</span> ((l == <span class="literal">NULL</span>) &amp;&amp; (r != <span class="literal">NULL</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    p-&gt;parent-&gt;right = r;</span><br><span class="line">                    r-&gt;parent = p-&gt;parent;</span><br><span class="line">                    <span class="built_in">free</span>(p);</span><br><span class="line">                    p = <span class="literal">NULL</span>;</span><br><span class="line">                    (*tree) = fakeroot-&gt;left;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;删除成功\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//p没有右子树</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((r == <span class="literal">NULL</span>) &amp;&amp; (l != <span class="literal">NULL</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    p-&gt;parent-&gt;right = l;</span><br><span class="line">                    l-&gt;parent = p-&gt;parent;</span><br><span class="line">                    <span class="built_in">free</span>(p);</span><br><span class="line">                    p = <span class="literal">NULL</span>;</span><br><span class="line">                    (*tree) = fakeroot-&gt;left;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;删除成功\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//p左右子树都有</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((r != <span class="literal">NULL</span>) &amp;&amp; (l != <span class="literal">NULL</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    p-&gt;parent-&gt;right = l;</span><br><span class="line">                    <span class="keyword">while</span> (l-&gt;right != <span class="literal">NULL</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        l = l-&gt;right;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//找到了右子树的最左边，插入左子树</span></span><br><span class="line">                    l-&gt;right = r;</span><br><span class="line">                    r-&gt;parent = l;</span><br><span class="line">                    <span class="built_in">free</span>(p);</span><br><span class="line">                    p = <span class="literal">NULL</span>;</span><br><span class="line">                    (*tree) = fakeroot-&gt;left;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;删除成功\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//左右子树都没有</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    p-&gt;parent-&gt;right = <span class="literal">NULL</span>;</span><br><span class="line">                    <span class="built_in">free</span>(p);</span><br><span class="line">                    p = <span class="literal">NULL</span>;</span><br><span class="line">                    (*tree) = fakeroot-&gt;left;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;删除成功\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;没有找到这个元素，删除失败\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//打印二叉树 0代表根节点 -1代表左边 1代表右</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Print_BSTree</span><span class="params">(BSTree *tree, <span class="keyword">int</span> direction)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BSTree p = *tree;</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//根节点</span></span><br><span class="line">        <span class="keyword">if</span> (direction == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;结点 %2d 为根节点\n&quot;</span>, p-&gt;key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//左</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (direction == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;结点 %2d 为结点 %2d 的left\n&quot;</span>, p-&gt;key, p-&gt;parent-&gt;key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;结点 %2d 为结点 %2d right\n&quot;</span>, p-&gt;key, p-&gt;parent-&gt;key);</span><br><span class="line">        &#125;</span><br><span class="line">        Print_BSTree(&amp;(p-&gt;left), <span class="number">-1</span>);</span><br><span class="line">        Print_BSTree(&amp;(p-&gt;right), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前序遍历</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Preorder_BSTree</span><span class="params">(BSTree *tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BSTree p = (*tree);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, p-&gt;key);</span><br><span class="line">        Preorder_BSTree(&amp;(p-&gt;left));</span><br><span class="line">        Preorder_BSTree(&amp;(p-&gt;right));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 中序遍历</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Inorder_BSTree</span><span class="params">(BSTree *tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BSTree p = (*tree);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Inorder_BSTree(&amp;(p-&gt;left));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, p-&gt;key);</span><br><span class="line">        Inorder_BSTree(&amp;(p-&gt;right));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 后序遍历</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Postorder_BSTree</span><span class="params">(BSTree *tree)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BSTree p = (*tree);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Postorder_BSTree(&amp;(p-&gt;left));</span><br><span class="line">        Postorder_BSTree(&amp;(p-&gt;right));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, p-&gt;key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (递归实现)查找&quot;二叉树x&quot;中键值为key的节点</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Search_BSTree</span><span class="params">(BSTree *tree, <span class="keyword">int</span> key, BSTree *tree_save)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BSTree p = (*tree);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//*tree_save = NULL;</span></span><br><span class="line">        <span class="comment">//printf(&quot;没找到\n&quot;);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;key == key)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//找到了</span></span><br><span class="line">        *tree_save = p;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;找到了\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Search_BSTree(&amp;(p-&gt;left), key, tree_save);</span><br><span class="line">    Search_BSTree(&amp;(p-&gt;right), key, tree_save);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// (非递归实现)查找&quot;二叉树x&quot;中键值为key的节点</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">iterative_bstree_search</span><span class="params">(BSTree *tree, <span class="keyword">int</span> key, BSTree *tree_save)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BSTree p = (*tree);</span><br><span class="line">    <span class="keyword">while</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (p-&gt;key == key)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//找到了</span></span><br><span class="line">            (*tree_save) = p;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;找到了\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p-&gt;key &lt; key)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//往右走</span></span><br><span class="line">            p = p-&gt;right;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p-&gt;key &gt; key)</span><br><span class="line">        &#123;</span><br><span class="line">            p = p-&gt;left;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//没找到</span></span><br><span class="line">    (*tree_save) = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;没找到\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找最小结点：返回tree为根结点的二叉树的最小结点。</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Min_BSTree</span><span class="params">(BSTree *tree, BSTree *tree_save)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BSTree p = (*tree);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *tree_save = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (p-&gt;left != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        p = p-&gt;left;</span><br><span class="line">    &#125;</span><br><span class="line">    *tree_save = p;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 查找最大结点：返回tree为根结点的二叉树的最大结点。</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Max_BSTree</span><span class="params">(BSTree *tree, BSTree *tree_save)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BSTree p = (*tree);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *tree_save = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (p-&gt;right != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        p = p-&gt;right;</span><br><span class="line">    &#125;</span><br><span class="line">    *tree_save = p;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//前驱节点：对一棵二叉树进行中序遍历，遍历后的顺序，当前节点的前一个节点为该节点的前驱节点；</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//后继节点：对一棵二叉树进行中序遍历，遍历后的顺序，当前节点的后一个节点为该节点的后继节点；</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找结点(x)的后继结点。即，查找&quot;二叉树中数据值大于该结点&quot;的&quot;最小结点&quot;。</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Sucessor_BSTree</span><span class="params">(BSTree *tree, BSTree *x, BSTree *sucessor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//即其右子树的最左边</span></span><br><span class="line">    <span class="keyword">if</span> ((*x) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;空结点，没有后继\n&quot;</span>);</span><br><span class="line">        (*sucessor) = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//有右子树</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((*x)-&gt;right != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Min_BSTree(&amp;((*x)-&gt;right), sucessor);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;找到了后继，%d 的后继为 %d \n&quot;</span>, (*x)-&gt;key, (*sucessor)-&gt;key);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//没有右子树 则从此开始向上找一个是左结点的结点</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((*x)-&gt;right == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        BSTree p = *x;</span><br><span class="line">        <span class="comment">//从x往上查，直到有一个结点是左节点  则该左节点的父节点为所求</span></span><br><span class="line">        <span class="keyword">while</span> (p-&gt;parent != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (p-&gt;parent-&gt;left == p)</span><br><span class="line">            &#123;</span><br><span class="line">                *sucessor = p-&gt;parent;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;找到了后继，%d 的后继为 %d \n&quot;</span>, (*x)-&gt;key, (*sucessor)-&gt;key);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                p = p-&gt;parent;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//p此时已经是root了，还没有找到说明那个结点没有后继。</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;结点 %d 没有后继\n&quot;</span>, (*x)-&gt;key);</span><br><span class="line">        (*sucessor) = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 找结点(x)的前驱结点。即，查找&quot;二叉树中数据值小于该结点&quot;的&quot;最大结点&quot;。</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Predecessor_BSTree</span><span class="params">(BSTree *tree, BSTree *x, BSTree *prede)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (*x == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;空结点，没有前驱\n&quot;</span>);</span><br><span class="line">        *prede = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//左子树 则寻找其左子树的最大值</span></span><br><span class="line">    <span class="keyword">if</span> ((*x)-&gt;left != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Max_BSTree(&amp;((*x)-&gt;left), prede);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;找到了前驱，%d 的前驱为 %d \n&quot;</span>, (*x)-&gt;key, (*prede)-&gt;key);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//没有左子树，则向上寻找一个是其父节点的右子树的结点。</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((*x)-&gt;left == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        BSTree p = *x;</span><br><span class="line">        <span class="keyword">while</span> (p-&gt;parent != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (p-&gt;parent-&gt;right == p)</span><br><span class="line">            &#123;</span><br><span class="line">                *prede = p-&gt;parent;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;找到了前驱，%d 的前驱为 %d \n&quot;</span>, (*x)-&gt;key, (*prede)-&gt;key);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                p = p-&gt;parent;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//p此时已经是root了，还没有找到说明那个结点没有前驱。</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;结点 %d 没有前驱\n&quot;</span>, (*x)-&gt;key);</span><br><span class="line">        (*prede) = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AutoFillBSTree</span><span class="params">(BSTree *tree, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    InsertBSTree(tree, <span class="number">5</span>);</span><br><span class="line">    InsertBSTree(tree, <span class="number">4</span>);</span><br><span class="line">    InsertBSTree(tree, <span class="number">6</span>);</span><br><span class="line">    InsertBSTree(tree, <span class="number">2</span>);</span><br><span class="line">    InsertBSTree(tree, <span class="number">3</span>);</span><br><span class="line">    InsertBSTree(tree, <span class="number">1</span>);</span><br><span class="line">    InsertBSTree(tree, <span class="number">8</span>);</span><br><span class="line">    InsertBSTree(tree, <span class="number">7</span>);</span><br><span class="line">    InsertBSTree(tree, <span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        BSTree sucessor = <span class="literal">NULL</span>;</span><br><span class="line">        BSTree x = <span class="literal">NULL</span>;</span><br><span class="line">        Search_BSTree(tree, i, &amp;x);</span><br><span class="line">        Sucessor_BSTree(tree, &amp;x, &amp;sucessor);</span><br><span class="line">        <span class="keyword">if</span> (sucessor != <span class="literal">NULL</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;succor: %d\n&quot;</span>, sucessor-&gt;key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        BSTree prede = <span class="literal">NULL</span>;</span><br><span class="line">        BSTree x = <span class="literal">NULL</span>;</span><br><span class="line">        Search_BSTree(tree, i, &amp;x);</span><br><span class="line">        Predecessor_BSTree(tree, &amp;x, &amp;prede);</span><br><span class="line">        <span class="keyword">if</span> (prede != <span class="literal">NULL</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;succor: %d\n&quot;</span>, prede-&gt;key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="接口使用"><a href="#接口使用" class="headerlink" title="接口使用"></a>接口使用</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;bstree.c&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BSTree tree;</span><br><span class="line">    InitBSTree(&amp;tree);</span><br><span class="line">    <span class="comment">//DestroyBSTree(&amp;tree);</span></span><br><span class="line">    AutoFillBSTree(&amp;tree, <span class="number">10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n前序遍历: &quot;</span>);</span><br><span class="line">    Preorder_BSTree(&amp;tree);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n中序遍历: &quot;</span>);</span><br><span class="line">    Inorder_BSTree(&amp;tree);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n后序遍历: &quot;</span>);</span><br><span class="line">    Postorder_BSTree(&amp;tree);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    Print_BSTree(&amp;tree, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://myblog.cuimouren.cn/2021/07/01/%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="崔文耀">
      <meta itemprop="description" content="Hello, here is wenyao's space, how do you come in???">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="这里是文耀的space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="../../2021/07/01/%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0C/" class="post-title-link" itemprop="url">深入学习C</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-01 21:12:45" itemprop="dateCreated datePublished" datetime="2021-07-01T21:12:45+08:00">2021-07-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-28 17:18:35" itemprop="dateModified" datetime="2021-08-28T17:18:35+08:00">2021-08-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/C/" itemprop="url" rel="index"><span itemprop="name">C</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="C"><a href="#C" class="headerlink" title="C"></a>C</h1><h2 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h2><h3 id="内存管理函数"><a href="#内存管理函数" class="headerlink" title="内存管理函数"></a>内存管理函数</h3><blockquote>
<ol>
<li><pre><code>void *malloc(int num);
</code></pre>
在堆区分配一块指定大小的内存空间，用来存放数据。这块内存空间在函数执行完成后不会被初始化，它们的值是未知的。</li>
</ol>
</blockquote>
<blockquote>
<ol start="2">
<li><pre><code>void *calloc(int num, int size);
</code></pre>
在内存中动态地分配 num 个长度为 size 的连续空间，并将每一个字节都初始化为 0。所以它的结果是分配了 num*size 个字节长度的内存空间，并且每个字节的值都是0。</li>
</ol>
</blockquote>
<blockquote>
<ol start="3">
<li><pre><code>void *realloc(void *address, int newsize);
</code></pre>
该函数重新分配内存，把内存扩展到 newsize。</li>
</ol>
</blockquote>
<blockquote>
<ol start="4">
<li><pre><code>void free(void *address);
</code></pre>
该函数释放 address 所指向的内存块,释放的是动态分配的内存空间。</li>
</ol>
</blockquote>
<h4 id="关于-realloc-的坑"><a href="#关于-realloc-的坑" class="headerlink" title="关于 realloc 的坑"></a>关于 realloc 的坑</h4><p>1、realloc失败的时候，返回NULL</p>
<p>2、realloc失败的时候，原来的内存不改变，不会释放也不会移动</p>
<p>3、假如原来的内存后面还有足够多剩余内存的话，realloc的内存=原来的内存+剩余内存,realloc还是返回原来内存的地址; 假如原来的内存后面没有足够多剩余内存的话，realloc将申请新的内存，然后把原来的内存数据拷贝到新内存里，原来的内存将被free掉, realloc返回新内存的地址。</p>
<p>4、如果size为0，效果等同于free()。</p>
<p>5、传递给realloc的指针必须是先前通过malloc(), calloc(), 或realloc()分配的,或者是NULL</p>
<p>6、传递给realloc的指针可以为空，等同于malloc。</p>
<p><strong>如果在连续的realloc中，有一次的size==0,则相当于free了目标指针，则这个指针就变成了野指针，继而在下一次realloc中，就会报错</strong></p>
<p><strong>记住，内存分配一定不要忘记size是 num*sizeof(type)</strong></p>
<h3 id="QUS"><a href="#QUS" class="headerlink" title="QUS"></a>QUS</h3><h4 id="1"><a href="#1" class="headerlink" title="1"></a>1</h4><p><strong><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011727691/article/details/66981143">什么情况下指针需要使用malloc分配内存，什么时候不需要</a></strong></p>
<p>1.在c语言中，内存模型分为栈和堆。</p>
<p>2，这两种模型内存的方式是不同的，在栈中存放的变量是由系统自动管理的，在函数结束后系统会自动释放，不需要人为的进行任何操作。</p>
<p>3，而在堆中存放的是用户自己管理的内存，手动分配的，malloc建立，系统不会在函数体执行结束后自动释放，需要用户手动释放通过free函数。</p>
<p>当你对分配的空间进行自己的管理和释放需要使用malloc，或者当你的分配的空间在函数结束后还需要存在。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> * <span class="title">create</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> *p = (<span class="keyword">int</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>));<span class="comment">//此时在堆中建立了存放int的空间。</span></span><br><span class="line"></span><br><span class="line">    *p=<span class="number">2</span>;</span><br><span class="line">    returen p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> *a = create();<span class="comment">//此时执行完后 刚刚在函数体内用malloc分配的空间还在，还存着2。</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,*a);<span class="comment">//输出2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="2"><a href="#2" class="headerlink" title="2"></a>2</h4><p><strong><a target="_blank" rel="noopener" href="https://zhidao.baidu.com/question/872413254876148412.html">为什么可以对 malloc函数声明 的*p直接赋值 而 对 int *p声明中的*p不能直接赋值</a></strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> * p = (<span class="keyword">int</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>));                   </span><br><span class="line">此时p是一个<span class="keyword">int</span>指针，它指向<span class="built_in">malloc</span>分配给他的一个地址，此地址已经有意义，只是这个地址内部的值还是随机的，比如我们认为p=<span class="number">0x1234</span>              </span><br><span class="line">*p = <span class="number">20</span>;                </span><br><span class="line">此时往<span class="number">0x1234</span>这个地址内部放入一个<span class="keyword">int</span>数，完全OK的操作         </span><br><span class="line">但是<span class="keyword">int</span> * q， 仅仅定义了q是一个<span class="keyword">int</span>型的地址，但是q此时是随机值（windows下一般为<span class="number">0xcccc</span>），也就是俗称的野指针          </span><br><span class="line">那么*p = <span class="number">20</span>; 的操作就是极度危险的，因为没人能预测你到底把这个<span class="number">20</span>放到了系统的哪里，很可能会造成不可预测的破坏。           </span><br></pre></td></tr></table></figure>

<h4 id="3"><a href="#3" class="headerlink" title="3"></a>3</h4><p><strong>紧紧抓住c语言形参与实参的关系，这样才能更好的使用指针</strong></p>
<p>由于是值传递，所以传入指针的值，在函数中进行更改不会改变实参的数据。<br>eg:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Item itemsave;</span><br><span class="line">GetItemLinkList(&amp;list, <span class="number">2</span>, &amp;itemsave);</span><br><span class="line"><span class="regexp">//</span>这个函数这样实现</span><br><span class="line"><span class="regexp">//</span>直接改变itemsave时改变形参，对外面的实参没有任何影响。  只有 *itemsave=    才会有作用。</span><br><span class="line">itemsave = &amp;(p-&gt;item);</span><br><span class="line"><span class="regexp">//</span>这样是不对的，以为函数中的itemsave只是一个形参，其指向的内存和传入的实参是一样的，但是这行代码又修改了itemsave的指向，对实参无法造成任何影响。</span><br><span class="line"><span class="regexp">//</span>必须改为这样</span><br><span class="line">*itemsave=p-&gt;item;</span><br><span class="line"><span class="regexp">//</span>这样，直接修改 *itemsave就是在修改实参的值<span class="regexp">//</span></span><br><span class="line">这也就是为什么说指针传入的值可以修改，不是说可以直接对指针进行修改，而是拿着传入的指针的值，由此得到指向的内存地址（实参的内存地址）然后就可以直接修改这块内存的值了，即修改实参。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4-小心野针"><a href="#4-小心野针" class="headerlink" title="4 小心野针"></a>4 小心野针</h4><blockquote>
<p>初始化一个指针的时候，切记要令其指向NULL;<br>在使用完成一个指针后，切记要进行free.<br>在free一个指针过后，切记要令其指向NULL</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://myblog.cuimouren.cn/2021/07/01/I-HAVE-A-PLAN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../../images/avatar.gif">
      <meta itemprop="name" content="崔文耀">
      <meta itemprop="description" content="Hello, here is wenyao's space, how do you come in???">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="这里是文耀的space">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="../../2021/07/01/I-HAVE-A-PLAN/" class="post-title-link" itemprop="url">I HAVE A PLAN</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-01 14:40:40" itemprop="dateCreated datePublished" datetime="2021-07-01T14:40:40+08:00">2021-07-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-22 20:23:11" itemprop="dateModified" datetime="2021-08-22T20:23:11+08:00">2021-08-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/project/" itemprop="url" rel="index"><span itemprop="name">project</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../categories/project/plan/" itemprop="url" rel="index"><span itemprop="name">plan</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MY-PLANS"><a href="#MY-PLANS" class="headerlink" title="MY PLANS"></a>MY PLANS</h1><p><strong>这篇博客的说明</strong></p>
<p>这篇博客是记录我的所有计划以及idea的地方，以下为比克的章节解释：</p>
<ol>
<li>PLAN num<ol>
<li>digest<br> 计划的描述，计划或者说为一个project，项目。简要说明一下这个project。</li>
<li>timeline<ol>
<li>时间线，用来记录计划的完成情况，每次计划有所进展或者想写有关的事情就可以在对应的timeline区域顺序增加。记得加上时间戳(年月日时分, eg:202107011449)</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="PLAN-1-cos"><a href="#PLAN-1-cos" class="headerlink" title="PLAN 1 cos"></a>PLAN 1 cos</h2><h3 id="digest"><a href="#digest" class="headerlink" title="digest"></a>digest</h3><p>写一个操作系统，计划是按照郑刚的那本操作系统真相还原照猫画虎的写出一个操作系统，之后学习更多有关操作系统开发的知识，做出一个有自己特色的操作系统，特色我还没有想好，毕竟现在知识面太窄了，啥都不会。</p>
<h3 id="timeline"><a href="#timeline" class="headerlink" title="timeline"></a>timeline</h3><blockquote>
<p><strong>time: 202107011449</strong> </p>
</blockquote>
<ol>
<li>写一个操作系统，现在写了到了中断部分，不过因为期末考试以及考研的额事情已经耽搁了好长时间，我预计在考研之前可以照猫画虎的写出一个操作系统。</li>
</ol>
<blockquote>
<p><strong>time: 202107011449</strong> (测试用，记得删掉)</p>
</blockquote>
<ol>
<li>写一个操作系统，现在写了到了中断部分，不过因为期末考试以及考研的额事情已经耽搁了好长时间，我预计在考研之前可以照猫画虎的写出一个操作系统。</li>
</ol>
<h2 id="PLAN-2-stackoverflow-cn"><a href="#PLAN-2-stackoverflow-cn" class="headerlink" title="PLAN 2 stackoverflow cn"></a>PLAN 2 stackoverflow cn</h2><h3 id="digest-1"><a href="#digest-1" class="headerlink" title="digest"></a>digest</h3><p>由于国内的计算机环境实在是烂到家了，所以我想做一个像stackoverflow那样的平台来为中国计算机界的进步增添一份力量。话说StackOverflow也被收购了，看来屠龙少年终成恶龙呀。做一个StackOverflow cn</p>
<h3 id="timeline-1"><a href="#timeline-1" class="headerlink" title="timeline"></a>timeline</h3><h2 id="PLAN-3-tiny-http"><a href="#PLAN-3-tiny-http" class="headerlink" title="PLAN 3 tiny http"></a>PLAN 3 tiny http</h2><h3 id="digest-2"><a href="#digest-2" class="headerlink" title="digest"></a>digest</h3><p>学习计算机网络及相关知识，首先学着写一个小的 http 服务器。</p>
<h3 id="timeline-2"><a href="#timeline-2" class="headerlink" title="timeline"></a>timeline</h3><h2 id="PLAN-4-database"><a href="#PLAN-4-database" class="headerlink" title="PLAN 4 database"></a>PLAN 4 database</h2><h3 id="digest-3"><a href="#digest-3" class="headerlink" title="digest"></a>digest</h3><p>学着写一个小的数据库</p>
<h3 id="timeline-3"><a href="#timeline-3" class="headerlink" title="timeline"></a>timeline</h3><blockquote>
<p><strong>time: 202107241520</strong> </p>
</blockquote>
<ol>
<li>目前已经可以实现简单的插入操作了。数据库的这个整体架构已经写好.</li>
<li>下一步的事情就是实现使用B-Tree作为数据库底层的索引。以及使用编译原理解析命令，而不是简单地使用strcmp.</li>
</ol>
<h2 id="PLAN-5-datastructure"><a href="#PLAN-5-datastructure" class="headerlink" title="PLAN 5 datastructure"></a>PLAN 5 datastructure</h2><h3 id="digest-4"><a href="#digest-4" class="headerlink" title="digest"></a>digest</h3><p>考研要学习数据结构，我发现自己的数据结构基本功真不怎么样，所以需要从头开始学习一边，同时也是为将来的考研做准备。<br>参考数据结构严蔚敏c语言版、c primer plus、STL进行底层数据结构的实现。</p>
<h3 id="timeline-4"><a href="#timeline-4" class="headerlink" title="timeline"></a>timeline</h3><blockquote>
<p><strong>time: 202107011507</strong></p>
</blockquote>
<ol>
<li>在这之前已经将链表进行了实现。</li>
</ol>
<blockquote>
<p><strong>time: 202107031418</strong></p>
</blockquote>
<ol>
<li>重新实现了两种线性表。</li>
<li>实现了基于两种线性表的栈。</li>
</ol>
<blockquote>
<p><strong>time：202107241529</strong></p>
</blockquote>
<ol>
<li>实现了BSTree</li>
</ol>
<blockquote>
<p><strong>time：202108222022</strong></p>
</blockquote>
<ol>
<li>实现了图,红黑树,B树,AVL树</li>
</ol>
<h2 id="PLAN-6-game-engine"><a href="#PLAN-6-game-engine" class="headerlink" title="PLAN 6 game engine"></a>PLAN 6 game engine</h2><h3 id="digest-5"><a href="#digest-5" class="headerlink" title="digest"></a>digest</h3><p>虽然在双创中的项目就是一个游戏引擎，但是我觉得这个项目实现的不是很优雅，我想像<strong>eaxy x</strong>一样做出一个3D游戏引擎，再进一步的目标就是一边像命令行一样进行输入代码，一边可以实时的显示出来结果。</p>
<h3 id="timeline-5"><a href="#timeline-5" class="headerlink" title="timeline"></a>timeline</h3><blockquote>
<p><strong>time: 202107241530</strong></p>
</blockquote>
<ol>
<li>项目已经完成验收，不过我认为这个项目实现的并不是很好，但是现在没有时间去完善了，现在要准备考研，等考完研之后，学习一下dx、vulkan做出一个简单地2D游戏引擎。</li>
<li>目前已完成的<a target="_blank" rel="noopener" href="https://docs.xyyengine.com/">情况</a></li>
</ol>
<h2 id="PLAN-7-project-manager"><a href="#PLAN-7-project-manager" class="headerlink" title="PLAN 7 project manager"></a>PLAN 7 project manager</h2><h3 id="digest-6"><a href="#digest-6" class="headerlink" title="digest"></a>digest</h3><p>像这样再博客上进行项目记录和管理甚是麻烦，做一个可以方便进行这项工作的project，不过现在没有一点思路。</p>
<h3 id="timeline-6"><a href="#timeline-6" class="headerlink" title="timeline"></a>timeline</h3><blockquote>
<p><strong>time: 202107011513</strong></p>
</blockquote>
<ol>
<li>产生设想，没有一点思路。</li>
</ol>
<blockquote>
<p><strong>time: 202107241534</strong></p>
</blockquote>
<ol>
<li>在网页上使用vue制作一个任务规划器。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="../2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="../../">1</a><a class="page-number" href="../2/">2</a><span class="page-number current">3</span><a class="page-number" href="../4/">4</a><span class="space">&hellip;</span><a class="page-number" href="../6/">6</a><a class="extend next" rel="next" href="../4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">崔文耀</p>
  <div class="site-description" itemprop="description">Hello, here is wenyao's space, how do you come in???</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="../../archives/">
        
          <span class="site-state-item-count">67</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="../../categories/">
          
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="../../tags/">
          
        <span class="site-state-item-count">67</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="../../https:/github.com/cuiwenyao" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cuiwenyao" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="../../mailto:yao1970099540@gmail.com" title="E-Mail → mailto:yao1970099540@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">崔文耀</span>
</div>
  <div class="powered-by">由 <a href="../../https:/hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="../../https:/muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="../../lib/anime.min.js"></script>
  <script src="../../lib/velocity/velocity.min.js"></script>
  <script src="../../lib/velocity/velocity.ui.min.js"></script>

<script src="../../js/utils.js"></script>

<script src="../../js/motion.js"></script>


<script src="../../js/schemes/muse.js"></script>


<script src="../../js/next-boot.js"></script>

<script src="../../js/bookmark.js"></script>




  















  

  

</body>
</html>
